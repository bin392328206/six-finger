x# å‰è¨€
>æ–‡æœ¬å·²æ”¶å½•è‡³æˆ‘çš„GitHubä»“åº“ï¼Œæ¬¢è¿Starï¼šhttps://github.com/bin392328206/six-finger                             
> **ç§ä¸€æ£µæ ‘æœ€å¥½çš„æ—¶é—´æ˜¯åå¹´å‰ï¼Œå…¶æ¬¡æ˜¯ç°åœ¨**   
>æˆ‘çŸ¥é“å¾ˆå¤šäººä¸ç©**qq**äº†,ä½†æ˜¯æ€€æ—§ä¸€ä¸‹,æ¬¢è¿åŠ å…¥å…­è„‰ç¥å‰‘Javaèœé¸Ÿå­¦ä¹ ç¾¤ï¼Œç¾¤èŠå·ç ï¼š**549684836** é¼“åŠ±å¤§å®¶åœ¨æŠ€æœ¯çš„è·¯ä¸Šå†™åšå®¢
## çµ®å¨ 
å…¶å®å‰é¢æˆ‘å»å¹´11æœˆä»½ï¼ŒæŠŠRedisçš„å¾ˆå¤šåŸºç¡€çŸ¥è¯†å†™äº†ä¸€éï¼Œè™½ç„¶è¯´æ²¡æœ‰å•¥æ·±åº¦ï¼Œä½†æ˜¯å…¥é—¨æ€»æ˜¯å¯ä»¥çš„ï¼Œæœ€è¿‘æˆ‘å»é¢è¯•ï¼Œç«Ÿç„¶è¢«é—®åˆ°äº†ï¼Œè¿˜æ˜¯è‡ªå·±å¹³æ—¶æ²¡æœ‰ç”¨å¿ƒå‡†å¤‡ï¼Œç—›å®šæ€ç—›ï¼Œæˆ‘å°±å¾—æŠŠRedis åˆ†å¸ƒå¼é”å¼„æ¸…æ¥šç‚¹ã€‚æ‰€ä»¥æœ‰äº†ä»Šå¤©çš„æ–‡ç« 

>[ğŸ”¥ä»é›¶å¼€å§‹å­¦Redisä¹‹é‡‘åˆšå‡¡å¢ƒ](https://juejin.im/post/5dde62bf5188256ebc1ee256)   
>[ğŸ”¥ä»é›¶å¼€å§‹å­¦Redisä¹‹è‡ªåœ¨åœ°å¢ƒ](https://juejin.im/post/5de24ca25188255e8b76e1c4)     
>[ğŸ”¥ä»é›¶å¼€å§‹å­¦Redisä¹‹é€é¥å¤©å¢ƒ](https://juejin.im/post/5de391046fb9a0717220fafe)   
>[ğŸ”¥ä»é›¶å¼€å§‹å­¦Redisä¹‹åŠæ­¥ç¥æ¸¸](https://juejin.im/post/5de49cbbf265da05d03826d5)   
>[ğŸ”¥ä»é›¶å¼€å§‹å­¦Redisä¹‹ç¥æ¸¸ç„å¢ƒ](https://juejin.im/post/5de4d504518825051411c83b)


## å¼•é¢˜
ä¸€èˆ¬é¢è¯•çš„æ—¶å€™ï¼Œé—®å®Œä¸€äº›Redisçš„é—®é¢˜ä¹‹åï¼Œæœ‰æ—¶å€™å¯èƒ½ä¼šé—®ä½ åˆ†å¸ƒå¼é”æ˜¯æ€ä¹ˆå®ç°çš„ï¼Œç„¶åå¤§å®¶å¯èƒ½å°±æ­ç”¨å®ƒçš„ set NX EXå‘½ä»¤ ç„¶åç”¨luaè„šæœ¬åšæˆä¸€ä¸ªåŸå­æ€§æ“ä½œæ¥å®ç°åˆ†å¸ƒå¼é”ã€‚å…¶å®è¿™ä¹ˆæ­ä¹Ÿå¯ä»¥å§ï¼Œç„¶åæˆ‘ä»¬ä¸€èˆ¬åœ¨ç”Ÿäº§ç¯å¢ƒçš„è¯ï¼Œå¯èƒ½ä¼šç”¨ä¸€äº›å¼€æºæ¡†æ¶ï¼Œä½ ä¸å¦‚è¯´Redissonæ¥å®ç°åˆ†å¸ƒå¼é”ï¼Œé‚£å¯èƒ½å°±ä¼šé—®åˆ°ä½ Redissonæ˜¯æ€ä¹ˆå®ç°çš„

æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹ä¸‹é¢å‡ ä¸ªç®€å•çš„ä»£ç 

```
 RLock lock = redisson.getLock(LOCKER_PREFIX + resourceName);
 success = lock.tryLock(100, lockTime, TimeUnit.SECONDS);
lock.unlock();
```
ä»¥ä¸Šç®€å•çš„ä»£ç å°±èƒ½å®ç°åˆ†å¸ƒå¼é” æ˜¯ä¸æ˜¯å¾ˆç®€å•ï¼Œå¹¶ä¸”è¿˜æ”¯æŒåˆ†å¸ƒå¼ ä¸»ä» å“¨å…µç­‰æ¨¡å¼


## æºç è§£æ

### é€šè¿‡ getLock æ–¹æ³•è·å–é”å¯¹è±¡


```
 @Override
    public RLock getLock(String name) {
    
/**
*  æ„é€ å¹¶è¿”å›ä¸€ä¸ª RedissonLock å¯¹è±¡
* commandExecutor: ä¸ Redis èŠ‚ç‚¹é€šä¿¡å¹¶å‘é€æŒ‡ä»¤çš„çœŸæ­£å®ç°ã€‚éœ€è¦è¯´æ˜ä¸€ä¸‹ï¼ŒCommandExecutor å®ç°æ˜¯é€šè¿‡ eval å‘½ä»¤æ¥æ‰§è¡Œ Lua è„šæœ¬
* name: é”çš„å…¨å±€åç§°
* id: Redisson å®¢æˆ·ç«¯å”¯ä¸€æ ‡è¯†ï¼Œå®é™…ä¸Šå°±æ˜¯ä¸€ä¸ª UUID.randomUUID()
*/

        return new RedissonLock(connectionManager.getCommandExecutor(), name);
    }
```

### é€šè¿‡tryLockæ–¹æ³•å°è¯•è·å–é”

![](https://user-gold-cdn.xitu.io/2020/3/15/170dd5da3c820d48?w=727&h=491&f=png&s=49288)

```
    @Override
    public boolean tryLock(long waitTime, long leaseTime, TimeUnit unit) throws InterruptedException {
        //å–å¾—æœ€å¤§ç­‰å¾…æ—¶é—´
        long time = unit.toMillis(waitTime);
        //è®°å½•ä¸‹å½“å‰æ—¶é—´
        long current = System.currentTimeMillis();
        //å–å¾—å½“å‰çº¿ç¨‹idï¼ˆåˆ¤æ–­æ˜¯å¦å¯é‡å…¥é”çš„å…³é”®ï¼‰
        final long threadId = Thread.currentThread().getId();
        //1.å°è¯•ç”³è¯·é”ï¼Œè¿”å›è¿˜å‰©ä½™çš„é”è¿‡æœŸæ—¶é—´
        Long ttl = tryAcquire(leaseTime, unit, threadId);
        // lock acquired
        //2.å¦‚æœè¿”å›çš„é”çš„è¿‡æœŸæ—¶é—´ä¸ºç©ºï¼Œè¡¨ç¤ºç”³è¯·é”æˆåŠŸ
        if (ttl == null) {
            return true;
        }
        //3.ç”³è¯·é”çš„è€—æ—¶å¦‚æœå¤§äºç­‰äºæœ€å¤§ç­‰å¾…æ—¶é—´ï¼Œåˆ™ç”³è¯·é”å¤±è´¥
        time -= (System.currentTimeMillis() - current);
        if (time <= 0) {
            acquireFailed(threadId);
            return false;
        }
        //è®¢é˜…é”é‡Šæ”¾äº‹ä»¶ï¼Œå¹¶é€šè¿‡awaitæ–¹æ³•é˜»å¡ç­‰å¾…é”é‡Šæ”¾ï¼Œæœ‰æ•ˆçš„è§£å†³äº†æ— æ•ˆçš„é”ç”³è¯·æµªè´¹èµ„æºçš„
        //é—®é¢˜ï¼šåŸºäºä¿¡æ¯é‡ï¼Œå½“é”è¢«å…¶å®ƒèµ„æºå ç”¨æ—¶ï¼Œå½“å‰çº¿ç¨‹é€šè¿‡ Redis çš„ channel  
        //è®¢é˜…é”çš„é‡Šæ”¾äº‹ä»¶ï¼Œä¸€æ—¦é”é‡Šæ”¾ä¼šå‘æ¶ˆæ¯é€šçŸ¥å¾…ç­‰å¾…çš„çº¿ç¨‹è¿›è¡Œç«äº‰
        current = System.currentTimeMillis();
        final RFuture<RedissonLockEntry> subscribeFuture = subscribe(threadId);
        //await æ–¹æ³•å†…éƒ¨æ˜¯ç”¨CountDownLatchæ¥å®ç°é˜»å¡ï¼Œ
        if (!await(subscribeFuture, time, TimeUnit.MILLISECONDS)) {
            if (!subscribeFuture.cancel(false)) {
                subscribeFuture.addListener(new FutureListener<RedissonLockEntry>() {
                    @Override
                    public void operationComplete(Future<RedissonLockEntry> future) throws Exception {
                        if (subscribeFuture.isSuccess()) {
                            unsubscribe(subscribeFuture, threadId);
                        }
                    }
                });
            }
            acquireFailed(threadId);
            return false;
        }

        try {
                //è®¡ç®—è·å–é”çš„æ€»è€—æ—¶ï¼Œå¦‚æœå¤§äºç­‰äºæœ€å¤§ç­‰å¾…æ—¶é—´ï¼Œåˆ™è·å–é”å¤±è´¥
            time -= (System.currentTimeMillis() - current);
            if (time <= 0) {
                acquireFailed(threadId);
                return false;
            }
        //æ”¶åˆ°é”é‡Šæ”¾çš„ä¿¡å·åï¼Œåœ¨æœ€å¤§ç­‰å¾…æ—¶é—´ä¹‹å†…ï¼Œå¾ªç¯ä¸€æ¬¡æ¥ç€ä¸€æ¬¡çš„å°è¯•è·å–é”
        //è·å–é”æˆåŠŸï¼Œåˆ™ç«‹é©¬è¿”å›true
        //è‹¥åœ¨æœ€å¤§ç­‰å¾…æ—¶é—´ä¹‹å†…è¿˜æ²¡è·å–åˆ°é”ï¼Œåˆ™è®¤ä¸ºè·å–é”å¤±è´¥ï¼Œè¿”å›falseç»“æŸå¾ªç¯
            while (true) {
                long currentTime = System.currentTimeMillis();
                 // å†æ¬¡å°è¯•ç”³è¯·é”
                ttl = tryAcquire(leaseTime, unit, threadId);
                // lock acquired
               // æˆåŠŸè·å–é”åˆ™ç›´æ¥è¿”å›trueç»“æŸå¾ªç¯
                if (ttl == null) {
                    return true;
                }
                //è¶…è¿‡æœ€å¤§ç­‰å¾…æ—¶é—´åˆ™è¿”å›falseç»“æŸå¾ªç¯ï¼Œè·å–é”å¤±è´¥
                time -= (System.currentTimeMillis() - currentTime);
                if (time <= 0) {
                    acquireFailed(threadId);
                    return false;
                }

                // waiting for message
                currentTime = System.currentTimeMillis();
                if (ttl >= 0 && ttl < time) {
                 //å¦‚æœå‰©ä½™æ—¶é—´(ttl)å°äºwait time ,å°±æ—¶é—´å†…ï¼Œ
                 //ä»Entryçš„ä¿¡å·é‡è·å–ä¸€ä¸ªè®¸å¯(é™¤éè¢«ä¸­æ–­æˆ–ç”¨çš„è®¸å¯)ã€‚

                    getEntry(threadId).getLatch().tryAcquire(ttl, TimeUnit.MILLISECONDS);
                } else {
                 //åˆ™å°±åœ¨wait time æ—¶é—´èŒƒå›´å†…ç­‰å¾…å¯ä»¥é€šè¿‡ä¿¡å·é‡
                    getEntry(threadId).getLatch().tryAcquire(time, TimeUnit.MILLISECONDS);
                }
             //7.æ›´æ–°å‰©ä½™çš„ç­‰å¾…æ—¶é—´(æœ€å¤§ç­‰å¾…æ—¶é—´-å·²ç»æ¶ˆè€—çš„é˜»å¡æ—¶é—´)
                time -= (System.currentTimeMillis() - currentTime);
                if (time <= 0) {
                    acquireFailed(threadId);
                    return false;
                }
            }
        } finally {
          //7.æ— è®ºæ˜¯å¦è·å¾—é”,éƒ½è¦å–æ¶ˆè®¢é˜…è§£é”æ¶ˆæ¯
            unsubscribe(subscribeFuture, threadId);
        }
//        return get(tryLockAsync(waitTime, leaseTime, unit));
    }
```

åŠ é”çš„æµç¨‹å›¾

![](https://user-gold-cdn.xitu.io/2020/3/15/170dd8f606d03398?w=919&h=715&f=png&s=91844)


```
<T> RFuture<T> tryLockInnerAsync(long leaseTime, TimeUnit unit, long threadId, RedisStrictCommand<T> command) {
// * é€šè¿‡ EVAL å‘½ä»¤æ‰§è¡Œ Lua è„šæœ¬è·å–é”ï¼Œä¿è¯äº†åŸå­æ€§
        internalLockLeaseTime = unit.toMillis(leaseTime);
   // 1.å¦‚æœç¼“å­˜ä¸­çš„keyä¸å­˜åœ¨ï¼Œåˆ™æ‰§è¡Œ hset å‘½ä»¤(hset key UUID+threadId 1),ç„¶åé€šè¿‡ pexpire å‘½ä»¤è®¾ç½®é”çš„è¿‡æœŸæ—¶é—´(å³é”çš„ç§Ÿçº¦æ—¶é—´)
   / è¿”å›ç©ºå€¼ nil ï¼Œè¡¨ç¤ºè·å–é”æˆåŠŸ
        return commandExecutor.evalWriteAsync(getName(), LongCodec.INSTANCE, command,
                  "if (redis.call('exists', KEYS[1]) == 0) then " +
                      "redis.call('hset', KEYS[1], ARGV[2], 1); " +
                      "redis.call('pexpire', KEYS[1], ARGV[1]); " +
                      "return nil; " +
                  "end; " +
                   // å¦‚æœkeyå·²ç»å­˜åœ¨ï¼Œå¹¶ä¸”valueä¹ŸåŒ¹é…ï¼Œè¡¨ç¤ºæ˜¯å½“å‰çº¿ç¨‹æŒæœ‰çš„é”ï¼Œåˆ™æ‰§è¡Œ hincrby å‘½ä»¤ï¼Œé‡å…¥æ¬¡æ•°åŠ 1ï¼Œå¹¶ä¸”è®¾ç½®å¤±æ•ˆæ—¶é—´
                  "if (redis.call('hexists', KEYS[1], ARGV[2]) == 1) then " +
                      "redis.call('hincrby', KEYS[1], ARGV[2], 1); " +
                      "redis.call('pexpire', KEYS[1], ARGV[1]); " +
                      "return nil; " +
                  "end; " +
                   //å¦‚æœkeyå·²ç»å­˜åœ¨ï¼Œä½†æ˜¯valueä¸åŒ¹é…ï¼Œè¯´æ˜é”å·²ç»è¢«å…¶ä»–çº¿ç¨‹æŒæœ‰ï¼Œé€šè¿‡ pttl å‘½ä»¤è·å–é”çš„å‰©ä½™å­˜æ´»æ—¶é—´å¹¶è¿”å›ï¼Œè‡³æ­¤è·å–é”å¤±è´¥
                  "return redis.call('pttl', KEYS[1]);",
                  //è¿™ä¸‰ä¸ªå‚æ•°åˆ†åˆ«å¯¹åº”KEYS[1]ï¼ŒARGV[1]å’ŒARGV[2]
                    Collections.<Object>singletonList(getName()), internalLockLeaseTime, getLockName(threadId));
    }
```
LUAè„šæœ¬
- KEYS[1]å°±æ˜¯Collections.singletonList(getName())ï¼Œè¡¨ç¤ºåˆ†å¸ƒå¼é”çš„keyï¼›
- ARGV[1]å°±æ˜¯internalLockLeaseTimeï¼Œå³é”çš„ç§Ÿçº¦æ—¶é—´ï¼ˆæŒæœ‰é”çš„æœ‰æ•ˆæ—¶é—´ï¼‰ï¼Œé»˜è®¤30sï¼›
- ARGV[2]å°±æ˜¯getLockName(threadId)ï¼Œæ˜¯è·å–é”æ—¶setçš„å”¯ä¸€å€¼ valueï¼Œå³UUID+threadId- 
### æ€»ç»“ä¸€ä¸‹åŠ é”çš„æµç¨‹
- ç¬¬ä¸€æ­¥å…ˆå°è¯•å»åŠ é”ï¼Œè¿”å›è¿‡æœŸæ—¶é—´ï¼Œå¦‚æœä¸ºç©ºåˆ™å¯ä»¥è·å¾—é” ï¼ˆè¿”å›è·å–é”æˆåŠŸï¼‰ï¼ˆ,åœ¨luaè„šæœ¬é‡Œé¢ä¼šåˆ¤æ–­ä½ çš„keyå’Œvalueæ˜¯ä¸æ˜¯å·²ç»æŒæœ‰é”äº†ï¼Œå¦‚æœæ˜¯ï¼Œå°±æ˜¯ç»™ä½ é‡è¯•æ¬¡æ•°åŠ ï¼Œç„¶åè·å–é”ä¹Ÿæ˜¯å¤±è´¥)
- å¦‚æœç¬¬ä¸€æ¬¡åŠ é”å¤±è´¥ä¹‹åï¼Œå°±ä¼šå»åˆ¤æ–­ä½ æœ€å¤§ç­‰å¾…æ—¶é—´ï¼Œå¦‚æœèµ°åˆ°è¿™çš„æ—¶å€™å·²ç»è¶…è¿‡æœ€å¤§ç­‰å¾…æ—¶é—´ï¼ˆç›´æ¥è¿”å›è·å–é”å¤±è´¥ï¼Œï¼‰
- æ¥ä¸‹æ¥å°±æ˜¯è¯´æˆ‘è¦å»è®¢é˜…redisè§£é”è¿™ä¸ªäº‹ä»¶ï¼Œä¸€æ—¦æœ‰äººæŠŠé”é‡Šæ”¾å°±ä¼šç»§ç»­é€šçŸ¥æ‰€æœ‰çš„çº¿ç¨‹å»ç«äº‰é”
- ç„¶åæ˜¯ä¸€ä¸ªæ­»å¾ªç¯çš„å»è·å–é”ï¼Œå½“æ—¶æ¯æ¬¡æ‰§è¡Œè¿™ä¸ªå¾ªç¯çš„æ—¶å€™ï¼Œæ¯æ¬¡å»è·å–é”ä¹‹å‰éƒ½è¦å»åˆ¤æ–­å½“å‰æ˜¯å¦å·²ç»è¶…è¿‡æœ€å¤§çš„ç­‰å¾…æ—¶é—´ï¼Œå¦‚æœè¶…è¿‡äº†å°±ç›´æ¥é‡Šæ”¾é”ã€‚åªæœ‰å½“è·å¾—é”ï¼Œæˆ–è€…æ˜¯æœ€å¤§çš„ç­‰å¾…æ—¶é—´è¶…è¿‡ä¹‹åæ‰ä¼šè¿”å›æ˜¯å¦æˆåŠŸè·å–é”çš„æ ‡å¿—ã€‚
- é€šè¿‡ Redisson å®ç°åˆ†å¸ƒå¼å¯é‡å…¥é”ï¼Œæ¯”çº¯è‡ªå·±é€šè¿‡set key value px milliseconds nx +lua å®ç°ï¼ˆå®ç°ä¸€ï¼‰çš„æ•ˆæœæ›´å¥½äº›ï¼Œè™½ç„¶åŸºæœ¬åŸç†éƒ½ä¸€æ ·ï¼Œå› ä¸ºé€šè¿‡åˆ†ææºç å¯çŸ¥ï¼ŒRedissonLock
æ˜¯å¯é‡å…¥çš„ï¼Œå¹¶ä¸”è€ƒè™‘äº†å¤±è´¥é‡è¯•ï¼Œå¯ä»¥è®¾ç½®é”çš„æœ€å¤§ç­‰å¾…æ—¶é—´ï¼Œ åœ¨å®ç°ä¸Šä¹Ÿåšäº†ä¸€äº›ä¼˜åŒ–ï¼Œå‡å°‘äº†æ— æ•ˆçš„é”ç”³è¯·ï¼Œæå‡äº†èµ„æºçš„åˆ©ç”¨ç‡ã€‚


### ä¸€ä¸ªç®€å•çš„å°æ¡ˆä¾‹ ä¸šåŠ¡ä»£ç 

```
@Autowired
private RedissonClient redissonClient;
//å•†å“ç§’æ€æ ¸å¿ƒä¸šåŠ¡é€»è¾‘çš„å¤„ç†-redissonçš„åˆ†å¸ƒå¼é”
@Override
public Boolean killItemV4(Integer killId, Integer userId) throws Exception {
Boolean result=false;
     final String lockKey=new StringBuffer().append(killId).append(userId).append("-RedissonLock").toString();
    RLock lock=redissonClient.getLock(lockKey);
     try {
       //TODO:ç¬¬ä¸€ä¸ªå‚æ•°30s=è¡¨ç¤ºå°è¯•è·å–åˆ†å¸ƒå¼é”ï¼Œå¹¶ä¸”æœ€å¤§çš„ç­‰å¾…è·å–é”çš„æ—¶é—´ä¸º30s
        //TODO:ç¬¬äºŒä¸ªå‚æ•°10s=è¡¨ç¤ºä¸Šé”ä¹‹åï¼Œ10så†…æ“ä½œå®Œæ¯•å°†è‡ªåŠ¨é‡Šæ”¾é”
        Boolean cacheRes=lock.tryLock(30,10,TimeUnit.SECONDS);
        if (cacheRes){
            //TODO:æ ¸å¿ƒä¸šåŠ¡é€»è¾‘çš„å¤„ç†
            if (itemKillSuccessMapper.countByKillUserId(killId,userId) <= 0){
                ItemKill itemKill=itemKillMapper.selectByIdV2(killId);
                if (itemKill!=null && 1==itemKill.getCanKill() && itemKill.getTotal()>0){
                    int res=itemKillMapper.updateKillItemV2(killId);
                    if (res>0){
                        commonRecordKillSuccessInfo(itemKill,userId);                         result=true;
                    }
                }
            }else{
                throw new Exception("redisson-æ‚¨å·²ç»æŠ¢è´­è¿‡è¯¥å•†å“äº†!");
            }
        }
}finally {
        //TODO:é‡Šæ”¾é”
        lock.unlock();
}
return result;
}
```

### redisçš„zSet

å·¥ä½œä¸­å…¶å®ä¹Ÿæœ‰ç”¨åˆ°è¿™ä¸ªæ•°æ®ç»“æ„ï¼Œå¦‚æœè¯´ç”¨å®ƒæ¥åšä¸€äº›ç”¨æˆ·æ’åç»Ÿè®¡å•¥çš„ï¼Œä½†æ˜¯å‘¢ï¼Œå½“é¢è¯•å®˜é—®åˆ°è·³è¡¨çš„æ—¶å€™ï¼Œæˆ‘ç«Ÿç„¶æ²¡å¬è¿‡ï¼Œè¿™ä¸å¾—å¥½å¥½è¡¥è¡¥

### åº•å±‚æ•°æ®ç»“æ„

æœ‰åºé›†åˆå¯¹è±¡çš„ç¼–ç å¯ä»¥æ˜¯ziplistæˆ–è€…skiplistã€‚åŒæ—¶æ»¡è¶³ä»¥ä¸‹æ¡ä»¶æ—¶ä½¿ç”¨ziplistç¼–ç ï¼š

å…ƒç´ æ•°é‡å°äº128ä¸ª
æ‰€æœ‰memberçš„é•¿åº¦éƒ½å°äº64å­—èŠ‚
ä»¥ä¸Šä¸¤ä¸ªæ¡ä»¶çš„ä¸Šé™å€¼å¯é€šè¿‡zset-max-ziplist-entrieså’Œzset-max-ziplist-valueæ¥ä¿®æ”¹ã€‚

ziplistç¼–ç çš„æœ‰åºé›†åˆä½¿ç”¨ç´§æŒ¨åœ¨ä¸€èµ·çš„å‹ç¼©åˆ—è¡¨èŠ‚ç‚¹æ¥ä¿å­˜ï¼Œç¬¬ä¸€ä¸ªèŠ‚ç‚¹ä¿å­˜memberï¼Œç¬¬äºŒä¸ªä¿å­˜scoreã€‚ziplistå†…çš„é›†åˆå…ƒç´ æŒ‰scoreä»å°åˆ°å¤§æ’åºï¼Œscoreè¾ƒå°çš„æ’åœ¨è¡¨å¤´ä½ç½®ã€‚

skiplistç¼–ç çš„æœ‰åºé›†åˆåº•å±‚æ˜¯ä¸€ä¸ªå‘½åä¸ºzsetçš„ç»“æ„ä½“ï¼Œè€Œä¸€ä¸ªzsetç»“æ„åŒæ—¶åŒ…å«ä¸€ä¸ªå­—å…¸å’Œä¸€ä¸ªè·³è·ƒè¡¨ã€‚è·³è·ƒè¡¨æŒ‰scoreä»å°åˆ°å¤§ä¿å­˜æ‰€æœ‰é›†åˆå…ƒç´ ã€‚è€Œå­—å…¸åˆ™ä¿å­˜ç€ä»memberåˆ°scoreçš„æ˜ å°„ï¼Œè¿™æ ·å°±å¯ä»¥ç”¨O(1)çš„å¤æ‚åº¦æ¥æŸ¥æ‰¾memberå¯¹åº”çš„scoreå€¼ã€‚è™½ç„¶åŒæ—¶ä½¿ç”¨ä¸¤ç§ç»“æ„ï¼Œä½†å®ƒä»¬ä¼šé€šè¿‡æŒ‡é’ˆæ¥å…±äº«ç›¸åŒå…ƒç´ çš„memberå’Œscoreï¼Œå› æ­¤ä¸ä¼šæµªè´¹é¢å¤–çš„å†…å­˜ã€‚

### skiplistä»‹ç»

è·³è¡¨(skip List)æ˜¯ä¸€ç§éšæœºåŒ–çš„æ•°æ®ç»“æ„ï¼ŒåŸºäºå¹¶è”çš„é“¾è¡¨ï¼Œå®ç°ç®€å•ï¼Œæ’å…¥ã€åˆ é™¤ã€æŸ¥æ‰¾çš„å¤æ‚åº¦å‡ä¸ºO(logN)ã€‚ç®€å•è¯´æ¥è·³è¡¨ä¹Ÿæ˜¯é“¾è¡¨çš„ä¸€ç§ï¼Œåªä¸è¿‡å®ƒåœ¨é“¾è¡¨çš„åŸºç¡€ä¸Šå¢åŠ äº†è·³è·ƒåŠŸèƒ½ï¼Œæ­£æ˜¯è¿™ä¸ªè·³è·ƒçš„åŠŸèƒ½ï¼Œä½¿å¾—åœ¨æŸ¥æ‰¾å…ƒç´ æ—¶ï¼Œè·³è¡¨èƒ½å¤Ÿæä¾›O(logN)çš„æ—¶é—´å¤æ‚åº¦ã€‚

å…ˆæ¥çœ‹ä¸€ä¸ªæœ‰åºé“¾è¡¨ï¼Œå¦‚ä¸‹å›¾ï¼ˆæœ€å·¦ä¾§çš„ç°è‰²èŠ‚ç‚¹è¡¨ç¤ºä¸€ä¸ªç©ºçš„å¤´ç»“ç‚¹ï¼‰ï¼š


![](https://user-gold-cdn.xitu.io/2020/3/15/170ddae0999f5bc4?w=1062&h=78&f=png&s=37784)

åœ¨è¿™æ ·ä¸€ä¸ªé“¾è¡¨ä¸­ï¼Œå¦‚æœæˆ‘ä»¬è¦æŸ¥æ‰¾æŸä¸ªæ•°æ®ï¼Œé‚£ä¹ˆéœ€è¦ä»å¤´å¼€å§‹é€ä¸ªè¿›è¡Œæ¯”è¾ƒï¼Œç›´åˆ°æ‰¾åˆ°åŒ…å«æ•°æ®çš„é‚£ä¸ªèŠ‚ç‚¹ï¼Œæˆ–è€…æ‰¾åˆ°ç¬¬ä¸€ä¸ªæ¯”ç»™å®šæ•°æ®å¤§çš„èŠ‚ç‚¹ä¸ºæ­¢ï¼ˆæ²¡æ‰¾åˆ°ï¼‰ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæ—¶é—´å¤æ‚åº¦ä¸ºO(n)ã€‚åŒæ ·ï¼Œå½“æˆ‘ä»¬è¦æ’å…¥æ–°æ•°æ®çš„æ—¶å€™ï¼Œä¹Ÿè¦ç»å†åŒæ ·çš„æŸ¥æ‰¾è¿‡ç¨‹ï¼Œä»è€Œç¡®å®šæ’å…¥ä½ç½®ã€‚



å‡å¦‚æˆ‘ä»¬æ¯ç›¸é‚»ä¸¤ä¸ªèŠ‚ç‚¹å¢åŠ ä¸€ä¸ªæŒ‡é’ˆï¼Œè®©æŒ‡é’ˆæŒ‡å‘ä¸‹ä¸‹ä¸ªèŠ‚ç‚¹ï¼Œå¦‚ä¸‹å›¾ï¼š


![](https://user-gold-cdn.xitu.io/2020/3/15/170ddae8b40a6d3c?w=1062&h=118&f=png&s=45295)

è¿™æ ·æ‰€æœ‰æ–°å¢åŠ çš„æŒ‡é’ˆè¿æˆäº†ä¸€ä¸ªæ–°çš„é“¾è¡¨ï¼Œä½†å®ƒåŒ…å«çš„èŠ‚ç‚¹ä¸ªæ•°åªæœ‰åŸæ¥çš„ä¸€åŠï¼ˆä¸Šå›¾ä¸­æ˜¯7, 19, 26ï¼‰ã€‚ç°åœ¨å½“æˆ‘ä»¬æƒ³æŸ¥æ‰¾æ•°æ®çš„æ—¶å€™ï¼Œå¯ä»¥å…ˆæ²¿ç€è¿™ä¸ªæ–°é“¾è¡¨è¿›è¡ŒæŸ¥æ‰¾ã€‚å½“ç¢°åˆ°æ¯”å¾…æŸ¥æ•°æ®å¤§çš„èŠ‚ç‚¹æ—¶ï¼Œå†å›åˆ°åŸæ¥çš„é“¾è¡¨ä¸­è¿›è¡ŒæŸ¥æ‰¾ã€‚æ¯”å¦‚ï¼Œæˆ‘ä»¬æƒ³æŸ¥æ‰¾23ï¼ŒæŸ¥æ‰¾çš„è·¯å¾„æ˜¯æ²¿ç€ä¸‹å›¾ä¸­æ ‡çº¢çš„æŒ‡é’ˆæ‰€æŒ‡å‘çš„æ–¹å‘è¿›è¡Œçš„ï¼š


![](https://user-gold-cdn.xitu.io/2020/3/15/170ddaf8b601dc3a?w=1062&h=177&f=png&s=62267)

- 23é¦–å…ˆå’Œ7æ¯”è¾ƒï¼Œå†å’Œ19æ¯”è¾ƒï¼Œæ¯”å®ƒä»¬éƒ½å¤§ï¼Œç»§ç»­å‘åæ¯”è¾ƒã€‚
- ä½†23å’Œ26æ¯”è¾ƒçš„æ—¶å€™ï¼Œæ¯”26è¦å°ï¼Œå› æ­¤å›åˆ°ä¸‹é¢çš„é“¾è¡¨ï¼ˆåŸé“¾è¡¨ï¼‰ï¼Œä¸22æ¯”è¾ƒã€‚ 23æ¯”22è¦å¤§ï¼Œæ²¿ä¸‹é¢çš„æŒ‡é’ˆç»§ç»­å‘åå’Œ26æ¯”è¾ƒã€‚23æ¯”26å°ï¼Œè¯´æ˜å¾…æŸ¥æ•°æ®23åœ¨åŸé“¾è¡¨ä¸­ä¸å­˜åœ¨ï¼Œè€Œä¸”å®ƒ-çš„æ’å…¥ä½ç½®åº”è¯¥åœ¨22å’Œ26ä¹‹é—´ã€‚

åœ¨è¿™ä¸ªæŸ¥æ‰¾è¿‡ç¨‹ä¸­ï¼Œç”±äºæ–°å¢åŠ çš„æŒ‡é’ˆï¼Œæˆ‘ä»¬ä¸å†éœ€è¦ä¸é“¾è¡¨ä¸­æ¯ä¸ªèŠ‚ç‚¹é€ä¸ªè¿›è¡Œæ¯”è¾ƒäº†ã€‚éœ€è¦æ¯”è¾ƒçš„èŠ‚ç‚¹æ•°å¤§æ¦‚åªæœ‰åŸæ¥çš„ä¸€åŠã€‚

åˆ©ç”¨åŒæ ·çš„æ–¹å¼ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ä¸Šå±‚æ–°äº§ç”Ÿçš„é“¾è¡¨ä¸Šï¼Œç»§ç»­ä¸ºæ¯ç›¸é‚»çš„ä¸¤ä¸ªèŠ‚ç‚¹å¢åŠ ä¸€ä¸ªæŒ‡é’ˆï¼Œä»è€Œäº§ç”Ÿç¬¬ä¸‰å±‚é“¾è¡¨ã€‚å¦‚ä¸‹å›¾ï¼š


![](https://user-gold-cdn.xitu.io/2020/3/15/170ddb17f55aca6f?w=1062&h=177&f=png&s=46718)

åœ¨è¿™ä¸ªæ–°çš„ä¸‰å±‚é“¾è¡¨ç»“æ„ä¸Šï¼Œå¦‚æœæˆ‘ä»¬è¿˜æ˜¯æŸ¥æ‰¾23ï¼Œé‚£ä¹ˆæ²¿ç€æœ€ä¸Šå±‚é“¾è¡¨é¦–å…ˆè¦æ¯”è¾ƒçš„æ˜¯19ï¼Œå‘ç°23æ¯”19å¤§ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å°±çŸ¥é“åªéœ€è¦åˆ°19çš„åé¢å»ç»§ç»­æŸ¥æ‰¾ï¼Œä»è€Œä¸€ä¸‹å­è·³è¿‡äº†19å‰é¢çš„æ‰€æœ‰èŠ‚ç‚¹ã€‚å¯ä»¥æƒ³è±¡ï¼Œå½“é“¾è¡¨è¶³å¤Ÿé•¿çš„æ—¶å€™ï¼Œè¿™ç§å¤šå±‚é“¾è¡¨çš„æŸ¥æ‰¾æ–¹å¼èƒ½è®©æˆ‘ä»¬è·³è¿‡å¾ˆå¤šä¸‹å±‚èŠ‚ç‚¹ï¼Œå¤§å¤§åŠ å¿«æŸ¥æ‰¾çš„é€Ÿåº¦ã€‚

skiplistæ­£æ˜¯å—è¿™ç§å¤šå±‚é“¾è¡¨çš„æƒ³æ³•çš„å¯å‘è€Œè®¾è®¡å‡ºæ¥çš„ã€‚å®é™…ä¸Šï¼ŒæŒ‰ç…§ä¸Šé¢ç”Ÿæˆé“¾è¡¨çš„æ–¹å¼ï¼Œä¸Šé¢æ¯ä¸€å±‚é“¾è¡¨çš„èŠ‚ç‚¹ä¸ªæ•°ï¼Œæ˜¯ä¸‹é¢ä¸€å±‚çš„èŠ‚ç‚¹ä¸ªæ•°çš„ä¸€åŠï¼Œè¿™æ ·æŸ¥æ‰¾è¿‡ç¨‹å°±éå¸¸ç±»ä¼¼äºä¸€ä¸ªäºŒåˆ†æŸ¥æ‰¾ï¼Œä½¿å¾—æŸ¥æ‰¾çš„æ—¶é—´å¤æ‚åº¦å¯ä»¥é™ä½åˆ°O(log n)ã€‚ä½†æ˜¯ï¼Œè¿™ç§æ–¹æ³•åœ¨æ’å…¥æ•°æ®çš„æ—¶å€™æœ‰å¾ˆå¤§çš„é—®é¢˜ã€‚æ–°æ’å…¥ä¸€ä¸ªèŠ‚ç‚¹ä¹‹åï¼Œå°±ä¼šæ‰“ä¹±ä¸Šä¸‹ç›¸é‚»ä¸¤å±‚é“¾è¡¨ä¸ŠèŠ‚ç‚¹ä¸ªæ•°ä¸¥æ ¼çš„2:1çš„å¯¹åº”å…³ç³»ã€‚å¦‚æœè¦ç»´æŒè¿™ç§å¯¹åº”å…³ç³»ï¼Œå°±å¿…é¡»æŠŠæ–°æ’å…¥çš„èŠ‚ç‚¹åé¢çš„æ‰€æœ‰èŠ‚ç‚¹ï¼ˆä¹ŸåŒ…æ‹¬æ–°æ’å…¥çš„èŠ‚ç‚¹ï¼‰é‡æ–°è¿›è¡Œè°ƒæ•´ï¼Œè¿™ä¼šè®©æ—¶é—´å¤æ‚åº¦é‡æ–°èœ•åŒ–æˆO(n)ã€‚åˆ é™¤æ•°æ®ä¹Ÿæœ‰åŒæ ·çš„é—®é¢˜ã€‚
## ç»“å°¾
ç®—æ˜¯å¯¹redisçŸ¥è¯†çš„å°å°è¡¥å……å§ã€‚
## æ—¥å¸¸æ±‚èµ
> å¥½äº†å„ä½ï¼Œä»¥ä¸Šå°±æ˜¯è¿™ç¯‡æ–‡ç« çš„å…¨éƒ¨å†…å®¹äº†ï¼Œèƒ½çœ‹åˆ°è¿™é‡Œçš„äººå‘€ï¼Œéƒ½æ˜¯**çœŸç²‰**ã€‚

> åˆ›ä½œä¸æ˜“ï¼Œå„ä½çš„æ”¯æŒå’Œè®¤å¯ï¼Œå°±æ˜¯æˆ‘åˆ›ä½œçš„æœ€å¤§åŠ¨åŠ›ï¼Œæˆ‘ä»¬ä¸‹ç¯‡æ–‡ç« è§

>å…­è„‰ç¥å‰‘ | æ–‡ ã€åŸåˆ›ã€‘å¦‚æœæœ¬ç¯‡åšå®¢æœ‰ä»»ä½•é”™è¯¯ï¼Œè¯·æ‰¹è¯„æŒ‡æ•™ï¼Œä¸èƒœæ„Ÿæ¿€ ï¼

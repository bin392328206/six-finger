# å‰è¨€
>æ–‡æœ¬å·²æ”¶å½•è‡³æˆ‘çš„GitHubä»“åº“ï¼Œæ¬¢è¿Starï¼šhttps://github.com/bin392328206/six-finger                             
> **ç§ä¸€æ£µæ ‘æœ€å¥½çš„æ—¶é—´æ˜¯åå¹´å‰ï¼Œå…¶æ¬¡æ˜¯ç°åœ¨**   
>æˆ‘çŸ¥é“å¾ˆå¤šäººä¸ç©**qq**äº†,ä½†æ˜¯æ€€æ—§ä¸€ä¸‹,æ¬¢è¿åŠ å…¥å…­è„‰ç¥å‰‘Javaèœé¸Ÿå­¦ä¹ ç¾¤ï¼Œç¾¤èŠå·ç ï¼š**549684836** é¼“åŠ±å¤§å®¶åœ¨æŠ€æœ¯çš„è·¯ä¸Šå†™åšå®¢
![](https://user-gold-cdn.xitu.io/2019/11/30/16ebbfc45ff83dba?w=640&h=496&f=jpeg&s=28818)

## çµ®å¨ 
> è‡ªåœ¨åœ°å¢ƒ å·²ç»åœ¨æ­¦ä¾ çš„ä¸–ç•Œé‡Œç®—çš„ä¸Šä¸€æ”¾å¼ºè€…äº† æ‰€ä»¥å‘¢åŸºç¡€çš„ä¸œè¥¿ä»Šå¤©å°±ä¸è¯´äº†ï¼Œ       
> å¦‚æœè¦å»çœ‹åŸºç¡€çš„è¯å»ºè®®çœ‹æˆ‘ä¸‹é¢çš„é“¾æ¥ï¼š  
>[ğŸ”¥ä»é›¶å¼€å§‹å­¦Redisä¹‹é‡‘åˆšå‡¡å¢ƒ](https://juejin.im/post/5dde62bf5188256ebc1ee256)  
>ç¬¬ä¸€ç¯‡åŸºç¡€çš„æ¦‚ç‡å¾ˆå¤š ä¼°è®¡å¤§å®¶çœ‹å¾—æƒ³ç¡è§‰ é‚£ä¹ˆè¿™ä¸€ç¯‡    
> æˆ‘ä¿è¯å…¨æ˜¯æ»¡æ»¡çš„å¹²è´§ï¼Œä¸ç®¡æ˜¯å·¥ä½œè¿˜æ˜¯é¢è¯• éƒ½ä¼šè®©äººçœ¼å‰ä¸€äº®ï¼Œè®©äººè§‰å¾—è¿™å®¶ä¼™ **æœ‰ç‚¹æ„æ€**


## ç¼“å­˜é›ªå´©ã€å‡»ç©¿ã€ç©¿é€ã€ç¼“å­˜ä¸€è‡´æ€§é—®é¢˜
> çœ‹åˆ°è¿™å¤§å®¶å¯èƒ½ä¼šæƒ³ è¿™åšä¸»æ˜¯ä¸æ˜¯shaï¼Œè¿™ä¸œè¥¿åŸºæœ¬ä¸ŠèƒŒè¿‡é¢è¯•é¢˜çš„ï¼Œè°ç‰¹ä¹ˆä¸ä¼šå‘€ã€‚ã€‚ã€‚

> åšä¸»æˆ‘ä¹Ÿæ‰¿è®¤è¿™æ˜¯è€ç”Ÿå¸¸è°ˆçš„ä¸œè¥¿ï¼Œä½†æ˜¯ä¹Ÿæ˜¯å¾ˆé‡è¦çš„ä¸œè¥¿ï¼Œä»Šå¤©å°±å¸¦å¤§å®¶å®Œæ•´çš„è§£å†³è¿™äº›é—®é¢˜

> å…ˆæ¥çœ‹çœ‹ç¼“å­˜çš„å¤„ç†æµç¨‹ï¼š

![](https://user-gold-cdn.xitu.io/2019/12/1/16ebff3ab806eda2?w=447&h=308&f=png&s=26503)

>  å‰å°è¯·æ±‚ï¼Œåå°å…ˆä»ç¼“å­˜ä¸­å–æ•°æ®ï¼Œå–åˆ°ç›´æ¥è¿”å›ç»“æœï¼Œå–ä¸åˆ°æ—¶ä»æ•°æ®åº“ä¸­å–ï¼Œæ•°æ®åº“å–åˆ°æ›´æ–°ç¼“å­˜ï¼Œå¹¶è¿”å›ç»“æœï¼Œæ•°æ®åº“ä¹Ÿæ²¡å–åˆ°ï¼Œé‚£ç›´æ¥è¿”å›ç©ºç»“æœã€‚
## ç¼“å­˜é›ªå´©
### ä»€ä¹ˆæ˜¯ç¼“å­˜é›ªå´©å‘¢ 
> å°±æ˜¯æ•°æ®æœªåŠ è½½åˆ°ç¼“å­˜ä¸­ï¼Œæˆ–è€…ç¼“å­˜åŒä¸€æ—¶é—´å¤§é¢ç§¯çš„å¤±æ•ˆï¼Œä»è€Œå¯¼è‡´æ‰€æœ‰è¯·æ±‚éƒ½å»æŸ¥æ•°æ®åº“ï¼Œå¯¼è‡´æ•°æ®åº“CPUå’Œå†…å­˜è´Ÿè½½è¿‡é«˜ï¼Œç”šè‡³å®•æœºã€‚å‡è®¾ä¸€ä¸‡ä¸ªè¯·æ±‚åŒæ—¶æ‰“åˆ°ä½ çš„æ•°æ®åº“ï¼Œé‚£ä¹ˆä½ çš„æ•°æ®åº“ä¸ç”¨æƒ³è‚¯å®šç»™ææ­»äº†ï¼Œè¿™å°±æ˜¯ç¼“å­˜é›ªå´©

### ä¸€ä¸ªç¼“å­˜é›ªå´©å‘è¿‡ç¨‹
1.  redisé›†ç¾¤å¤§é¢ç§¯æ•…éšœ
2.  ç¼“å­˜å¤±æ•ˆï¼Œä½†ä¾ç„¶å¤§é‡è¯·æ±‚è®¿é—®ç¼“å­˜æœåŠ¡redis
3.  rediså¤§é‡å¤±æ•ˆåï¼Œå¤§é‡è¯·æ±‚è½¬å‘åˆ°mysqlæ•°æ®åº“
4.  mysqlçš„è°ƒç”¨é‡æš´å¢ï¼Œå¾ˆå¿«å°±æ‰›ä¸ä½äº†ï¼Œç”šè‡³ç›´æ¥å®•æœº
5.  ç”±äºå¤§é‡çš„åº”ç”¨æœåŠ¡ä¾èµ–mysqlå’Œredisçš„æœåŠ¡ï¼Œè¿™ä¸ªæ—¶å€™å¾ˆå¿«ä¼šæ¼”å˜æˆå„æœåŠ¡å™¨é›†ç¾¤çš„é›ªå´©ï¼Œæœ€åç½‘ç«™å½»åº•å´©æºƒã€‚

> ç”±æ­¤å¯è§ ç¼“å­˜é›ªå´©çš„æƒ…å†µå‡ºç°å¯¹äºä¸€ä¸ªäº§å“æ¥è¯´ï¼Œå¯èƒ½ä¼šè®©ç”¨æˆ·å¯¹å®ƒå¤±å»ä¿¡å¿ƒï¼Œæ‰€ä»¥é˜²æ­¢ç¼“å­˜é›ªå´©æ˜¯éå¸¸æœ‰å¿…è¦çš„

### **å¦‚ä½•è§£å†³ç¼“å­˜é›ªå´©**
- ç¬¬ä¸€ç§æ–¹æ¡ˆï¼š ç¼“å­˜å±‚è®¾è®¡æˆé«˜å¯ç”¨ï¼Œé˜²æ­¢ç¼“å­˜å¤§é¢ç§¯æ•…éšœã€‚å³ä½¿ä¸ªåˆ«èŠ‚ç‚¹ã€ä¸ªåˆ«æœºå™¨ã€ç”šè‡³æ˜¯æœºæˆ¿å®•æ‰ï¼Œä¾ç„¶å¯ä»¥æä¾›æœåŠ¡ï¼Œä¾‹å¦‚ Redis Sentinel å’Œ Redis Cluster éƒ½å®ç°äº†é«˜å¯ç”¨ã€‚

- ç¬¬äºŒç§æ–¹æ¡ˆï¼šåœ¨æ‰¹é‡å¾€Rediså­˜æ•°æ®çš„æ—¶å€™ï¼ŒæŠŠæ¯ä¸ªKeyçš„å¤±æ•ˆæ—¶é—´éƒ½åŠ ä¸ªéšæœºå€¼å°±å¥½äº†ï¼Œè¿™æ ·å¯ä»¥ä¿è¯æ•°æ®ä¸ä¼šåœ¨åŒä¸€æ—¶é—´å¤§é¢ç§¯å¤±æ•ˆï¼Œæˆ‘ç›¸ä¿¡ï¼ŒRedisè¿™ç‚¹æµé‡è¿˜æ˜¯é¡¶å¾—ä½çš„ã€‚

```
redisUtils.set(RedisKeys.App.appApiFrontHomePageOrg(),homePageOrgDTOList,RedisUtils.FRONT_END_EXPIRE+RandomUtil.randomInt(1,100)*100);
```
> æœ€åçš„éšæœºæ•°å°±æ˜¯é˜²æ­¢é¦–é¡µç¼“å­˜åŒæ—¶å¤±æ•ˆçš„

- åŠ äº’æ–¥é”ã€‚å½“å‘ç°æ²¡æœ‰å‘½ä¸­Redisï¼Œå»æŸ¥æ•°æ®åº“çš„æ—¶å€™ï¼Œåœ¨æ‰§è¡Œæ›´æ–°ç¼“å­˜çš„æ“ä½œä¸ŠåŠ é”ï¼Œè°æ‹¿åˆ°é”è°å»æ›´æ–°ï¼ŒåŒæ—¶åœ¨æ‹¿åˆ°é”ä¹‹åå…ˆä»ç¼“å­˜å†è·å–ä¸€æ¬¡å¦‚æœæœ‰å°±è¿”å›ï¼Œæ²¡æœ‰å°±æŸ¥åº“ç„¶åæ›´æ–°(è¿™ç§æ–¹æ¡ˆå…¶å®ä¹Ÿæ˜¯å¯ä»¥çš„)


```

<!-- redisæ‰€éœ€ (è‡ªå¸¦lettuce 5.1.4.RELEASE) lettuceæ˜¯springboot2.xåè¿æ¥redisæ¨èä½¿ç”¨çš„å®¢æˆ·ç«¯ -->
<dependency>
   <groupId>org.springframework.boot</groupId>
   <artifactId>spring-boot-starter-data-redis</artifactId>
</dependency>
```

> è¿™ä¸ªæ˜¯å…·ä½“çš„æ–¹æ³•ï¼ˆä¸šåŠ¡ä»£ç ï¼‰

```
 public void testRedis(){
        String key="å…­è„‰ç¥å‰‘";
        // é€šè¿‡keyè·å–value
        String value = (String) redisTemplate.opsForValue().get(key);
        if (StringUtil.isEmpty(value)) {
            String lockKey="ä¸€å‰‘æ–­è½æ°´";
            try {
                boolean locked = RedissLockUtil.tryLock(lockKey, TimeUnit.SECONDS, 5, 10);
                if (locked) {
                   System.out.println("æˆ‘æ˜¯è·å¾—é”çš„çº¿ç¨‹ï¼Œæ±‚å«æˆ‘å¤§ä½¬"+Thread.currentThread().getName());
                    User byId = service.getById(1);
                    System.out.println("ç¡ä¸€ä¸‹,ç„¶åæŠŠä»æ•°æ®åº“æŸ¥åˆ°çš„æ•°æ®æ”¾åˆ°redisä¸­,ç”Ÿäº§ç¯å¢ƒä¸­æ²¡å¿…è¦ç¡ï¼Œæˆ‘è¿™ä¸ªæ˜¯æµ‹è¯•");
                    Thread.sleep(500);
                    redisTemplate.opsForValue().set(key,"byId");
                    redisTemplate.delete(lockKey);

                } else {
                    // å…¶å®ƒçº¿ç¨‹è¿›æ¥äº†æ²¡è·å–åˆ°é”ä¾¿ç­‰å¾…50msåé‡è¯•
                    System.out.println("æˆ‘ä»¬æ˜¯æ²¡æœ‰å¾—åˆ°é”çš„çº¿ç¨‹ï¼Œç­‰å¾…ä¸€ä¸‹å†è¯•è¯•");
                    Thread.sleep(50);
                    testRedis();
                }
            } catch (Exception e) {

            } finally {
                redisTemplate.delete(lockKey);
            }
        }

    }
```
ä¸‹é¢æ˜¯æµ‹è¯•æ–¹æ³• å’Œæµ‹è¯•ç»“æœ

```
    @Test
    public void testCountDownLatch() {

        int threadCount = 10;

        final CountDownLatch latch = new CountDownLatch(threadCount);

        for (int i = 0; i < threadCount; i++) {

            new Thread(new Runnable() {

                @Override
                public void run() {

                    System.out.println("çº¿ç¨‹" + Thread.currentThread().getId() + "å¼€å§‹å‡ºå‘");

                    try {
                        userController.testRedis();

                    } catch (Exception e) {
                        e.printStackTrace();
                    }

                    System.out.println("çº¿ç¨‹" + Thread.currentThread().getId() + "å·²åˆ°è¾¾ç»ˆç‚¹");

                    latch.countDown();
                }
            }).start();
        }

        try {
            latch.await();
        } catch (InterruptedException e) {
            e.printStackTrace();
        }

        System.out.println("10ä¸ªçº¿ç¨‹å·²ç»æ‰§è¡Œå®Œæ¯•ï¼å¼€å§‹è®¡ç®—æ’å");
    }
```


```
çº¿ç¨‹47å¼€å§‹å‡ºå‘
çº¿ç¨‹49å¼€å§‹å‡ºå‘
çº¿ç¨‹48å¼€å§‹å‡ºå‘
çº¿ç¨‹50å¼€å§‹å‡ºå‘
çº¿ç¨‹52å¼€å§‹å‡ºå‘
çº¿ç¨‹51å¼€å§‹å‡ºå‘
çº¿ç¨‹53å¼€å§‹å‡ºå‘
çº¿ç¨‹55å¼€å§‹å‡ºå‘
çº¿ç¨‹54å¼€å§‹å‡ºå‘
çº¿ç¨‹56å¼€å§‹å‡ºå‘
2019-12-01 11:42:34.757  INFO 222916 --- [       Thread-3] io.lettuce.core.EpollProvider            : Starting without optional epoll library
2019-12-01 11:42:34.760  INFO 222916 --- [       Thread-3] io.lettuce.core.KqueueProvider           : Starting without optional kqueue library
æˆ‘æ˜¯è·å¾—é”çš„çº¿ç¨‹ï¼Œæ±‚å«æˆ‘å¤§ä½¬Thread-2
ç¡ä¸€ä¸‹,ç„¶åæŠŠä»æ•°æ®åº“æŸ¥åˆ°çš„æ•°æ®æ”¾åˆ°redisä¸­,ç”Ÿäº§ç¯å¢ƒä¸­æ²¡å¿…è¦ç¡ï¼Œæˆ‘è¿™ä¸ªæ˜¯æµ‹è¯•
æˆ‘ä»¬æ˜¯æ²¡æœ‰å¾—åˆ°é”çš„çº¿ç¨‹ï¼Œç­‰å¾…ä¸€ä¸‹å†è¯•è¯•
æˆ‘ä»¬æ˜¯æ²¡æœ‰å¾—åˆ°é”çš„çº¿ç¨‹ï¼Œç­‰å¾…ä¸€ä¸‹å†è¯•è¯•
æˆ‘ä»¬æ˜¯æ²¡æœ‰å¾—åˆ°é”çš„çº¿ç¨‹ï¼Œç­‰å¾…ä¸€ä¸‹å†è¯•è¯•
æˆ‘ä»¬æ˜¯æ²¡æœ‰å¾—åˆ°é”çš„çº¿ç¨‹ï¼Œç­‰å¾…ä¸€ä¸‹å†è¯•è¯•
æˆ‘ä»¬æ˜¯æ²¡æœ‰å¾—åˆ°é”çš„çº¿ç¨‹ï¼Œç­‰å¾…ä¸€ä¸‹å†è¯•è¯•
æˆ‘ä»¬æ˜¯æ²¡æœ‰å¾—åˆ°é”çš„çº¿ç¨‹ï¼Œç­‰å¾…ä¸€ä¸‹å†è¯•è¯•
æˆ‘ä»¬æ˜¯æ²¡æœ‰å¾—åˆ°é”çš„çº¿ç¨‹ï¼Œç­‰å¾…ä¸€ä¸‹å†è¯•è¯•
æˆ‘ä»¬æ˜¯æ²¡æœ‰å¾—åˆ°é”çš„çº¿ç¨‹ï¼Œç­‰å¾…ä¸€ä¸‹å†è¯•è¯•
æˆ‘ä»¬æ˜¯æ²¡æœ‰å¾—åˆ°é”çš„çº¿ç¨‹ï¼Œç­‰å¾…ä¸€ä¸‹å†è¯•è¯•
çº¿ç¨‹47å·²åˆ°è¾¾ç»ˆç‚¹
æˆ‘æ˜¯è·å¾—é”çš„çº¿ç¨‹ï¼Œæ±‚å«æˆ‘å¤§ä½¬Thread-7
ç¡ä¸€ä¸‹,ç„¶åæŠŠä»æ•°æ®åº“æŸ¥åˆ°çš„æ•°æ®æ”¾åˆ°redisä¸­,ç”Ÿäº§ç¯å¢ƒä¸­æ²¡å¿…è¦ç¡ï¼Œæˆ‘è¿™ä¸ªæ˜¯æµ‹è¯•
æˆ‘ä»¬æ˜¯æ²¡æœ‰å¾—åˆ°é”çš„çº¿ç¨‹ï¼Œç­‰å¾…ä¸€ä¸‹å†è¯•è¯•
æˆ‘ä»¬æ˜¯æ²¡æœ‰å¾—åˆ°é”çš„çº¿ç¨‹ï¼Œç­‰å¾…ä¸€ä¸‹å†è¯•è¯•
æˆ‘ä»¬æ˜¯æ²¡æœ‰å¾—åˆ°é”çš„çº¿ç¨‹ï¼Œç­‰å¾…ä¸€ä¸‹å†è¯•è¯•
æˆ‘ä»¬æ˜¯æ²¡æœ‰å¾—åˆ°é”çš„çº¿ç¨‹ï¼Œç­‰å¾…ä¸€ä¸‹å†è¯•è¯•
æˆ‘ä»¬æ˜¯æ²¡æœ‰å¾—åˆ°é”çš„çº¿ç¨‹ï¼Œç­‰å¾…ä¸€ä¸‹å†è¯•è¯•
æˆ‘ä»¬æ˜¯æ²¡æœ‰å¾—åˆ°é”çš„çº¿ç¨‹ï¼Œç­‰å¾…ä¸€ä¸‹å†è¯•è¯•
æˆ‘ä»¬æ˜¯æ²¡æœ‰å¾—åˆ°é”çš„çº¿ç¨‹ï¼Œç­‰å¾…ä¸€ä¸‹å†è¯•è¯•
æˆ‘ä»¬æ˜¯æ²¡æœ‰å¾—åˆ°é”çš„çº¿ç¨‹ï¼Œç­‰å¾…ä¸€ä¸‹å†è¯•è¯•
çº¿ç¨‹55å·²åˆ°è¾¾ç»ˆç‚¹
çº¿ç¨‹50å·²åˆ°è¾¾ç»ˆç‚¹
çº¿ç¨‹53å·²åˆ°è¾¾ç»ˆç‚¹
çº¿ç¨‹49å·²åˆ°è¾¾ç»ˆç‚¹
çº¿ç¨‹51å·²åˆ°è¾¾ç»ˆç‚¹
çº¿ç¨‹54å·²åˆ°è¾¾ç»ˆç‚¹
çº¿ç¨‹48å·²åˆ°è¾¾ç»ˆç‚¹
çº¿ç¨‹56å·²åˆ°è¾¾ç»ˆç‚¹
çº¿ç¨‹52å·²åˆ°è¾¾ç»ˆç‚¹
10ä¸ªçº¿ç¨‹å·²ç»æ‰§è¡Œå®Œæ¯•ï¼å¼€å§‹è®¡ç®—æ’å


```
> ä»ä»¥ä¸Šæµ‹è¯•å¯ä»¥çœ‹å‡º ä¸€å¼€å§‹10ä¸ªå¹¶å‘ åªæœ‰çº¿ç¨‹47æ‹¿åˆ°äº†é”ï¼Œ ç„¶å å…¶ä»–çº¿ç¨‹ä¸€ç›´å†é‡æ–°è·å¾—é” ç„¶åç­‰äºŒè½®çš„æ—¶å€™çº¿ç¨‹55æ‹¿åˆ°é” ï¼Œä¹‹åçš„å°±æ˜¯å…¨éƒ¨æ‹¿çš„ç¼“å­˜äº† ï¼Œç¬¬äºŒä¸ªèƒ½æ‹¿åˆ°é” æ˜¯å› ä¸ºè¿™ä¸ªæ˜¯å¯é‡å…¥é”ã€‚  
ç„¶åæˆ‘æµ‹äº†100ä¸ªå¹¶å‘ä¹Ÿæ˜¯å‘ç°æœ€å¤šåªæœ‰2ä¸ªçº¿ç¨‹å»æŸ¥æ•°æ®åº“ï¼Œ æ‰€ä»¥è¿™ç§æ–¹å¼å¯ä»¥è§£å†³ç¼“å­˜é›ªå´©çš„é—®é¢˜

## ç¼“å­˜å‡»ç©¿

### ä»€ä¹ˆæ˜¯ç¼“å­˜å‡»ç©¿
æˆ‘ä¸ªäººç†è§£ å‡»ç©¿ å°±æ˜¯æ­£é¢åˆš æ¯”å¦‚æˆ‘æ˜¯çŸ› ä½ æ˜¯ç›¾ æˆ‘ç›´æ¥æŠŠä½ çš„ç›¾å‡»ç©¿ï¼Œ å°±æ˜¯æ¯”å¦‚ å‡ ä¸ªçƒ­ç‚¹Key åŒæ—¶å‡ ç™¾ä¸‡å¹¶å‘ç›´æ¥æŠŠredis å¹²æ‰äº†ï¼Œ ç„¶åæ•°æ®å…¨éƒ¨æ‰“åˆ°æ•°æ®åº“çš„æƒ…å†µï¼Œæˆ–è€…æ˜¯redisçš„è¿™å‡ ä¸ªçƒ­ç‚¹æ•°æ®å¤±æ•ˆçš„æƒ…æ™¯ä¸‹ï¼ŒåŒæ—¶å…¨éƒ¨çš„å¹¶å‘æŸ¥è¿™ä¸ªçƒ­æ•°æ®ï¼Œå¯¼è‡´æœ€åæ‰“åˆ°æ•°æ®åº“çš„æƒ…å†µ è¿™ä¸ªå°±æ˜¯ç¼“å­˜å‡»ç©¿ã€‚

###ã€€**å¦‚ä½•è§£å†³ç¼“å­˜å‡»ç©¿**
- è¿˜æ˜¯åˆ†å¸ƒå¼é” å“ˆå“ˆ å› ä¸ºåˆ†å¸ƒå¼é”èƒ½æ§åˆ¶åˆ°æ•°æ®åº“çš„æœ€åä¸€åˆ°é˜²çº¿ 
- redisåšé›†ç¾¤ å“¨å…µ ï¼ˆä¸‹ä¸€ç¯‡è®²ï¼‰


## ç¼“å­˜ç©¿é€
### ä»€ä¹ˆæ˜¯ç¼“å­˜ç©¿é€
>  ç¼“å­˜ç©¿é€æ˜¯æŒ‡ç¼“å­˜å’Œæ•°æ®åº“ä¸­éƒ½æ²¡æœ‰çš„æ•°æ®ï¼Œè€Œç”¨æˆ·ä¸æ–­å‘èµ·è¯·æ±‚ï¼Œå¦‚å‘èµ·ä¸ºidä¸ºâ€œ-1â€çš„æ•°æ®æˆ–idä¸ºç‰¹åˆ«å¤§ä¸å­˜åœ¨çš„æ•°æ®ã€‚è¿™æ—¶çš„ç”¨æˆ·å¾ˆå¯èƒ½æ˜¯æ”»å‡»è€…ï¼Œæ”»å‡»ä¼šå¯¼è‡´æ•°æ®åº“å‹åŠ›è¿‡å¤§ã€‚  

> **è¿™ä¸ªå’Œç¼“å­˜å‡»ç©¿ä¸ä¸€æ ·,ç¼“å­˜å‡»ç©¿äººå®¶å¥½æ­¹æœ‰ä¸ªç›¾,ä½ è¿™å°±æ˜¯ç›´æ¥è·Ÿäººå®¶è‚‰æå¹²ã€‚å•¥ä¹Ÿæ²¡æœ‰**

###ã€€**å¦‚ä½•è§£å†³ç¼“å­˜ç©¿é€**

1.  ç¬¬ä¸€ç§æ–¹æ¡ˆ å’Œä¸Šé¢çš„åŒé‡é”ä¸€æ · å¦‚æœæ˜¯æ‹¿åˆ°æ•°æ®åº“ä¸ºç©º é‚£ä¹ˆå°±ç»™è¿™ä¸ªkey è®¾ç½®ä¸€ä¸ªnullå€¼ æ—¶é—´è®¾ç½®çŸ­ä¸€ç‚¹ 30sï¼Œ è¿™æ ·ä¸‹æ¬¡å¹¶å‘è¿›æ¥å°±ä¸ä¼šè¯´æŠŠæ•°æ®æ‰“åˆ°æˆ‘ä»¬çš„æ•°æ®åº“ä¸Šäº†
```
redisTemplate.opsForValue().set(key,"byId",30,TimeUnit.SECONDS);
```
2. å°±æ˜¯æˆ‘ä»¬å†™ä»£ç çš„æ—¶å€™ è¦å¯¹ä¸€äº›éæ³•çš„è¯·æ±‚å‚æ•°æ ¡éªŒ æˆ‘ç›¸ä¿¡å¤§å®¶éƒ½æ˜¯è¿™æ ·åšçš„ã€‚

3. ç¬¬äºŒç§æ–¹æ¡ˆ é‡‡ç”¨æˆ‘ä»¬ç¬¬ä¸€ç¯‡ä¸­å­¦åˆ°çš„ä¸€ä¸ªé«˜çº§ç”¨æ³• bitMap([ä¸æ‡‚çš„å¯ä»¥ç¿»æˆ‘å‰é¢ä¸€ç¯‡æ–‡ç« ](https://juejin.im/post/5dde62bf5188256ebc1ee256))
> ä¸‹é¢æ˜¯å…·ä½“çš„ä»£ç 

```
  public void testRedis() {
        List<String> goodsId = new ArrayList<String>();
        goodsId.add("201912010001");
        goodsId.add("20191201002");
        goodsId.add("20191201003");
        goodsId.add("20191201004");

        String key = "å…­è„‰ç¥å‰‘";
        // é€šè¿‡keyè·å–value
        long index = Math.abs((long) (goodsId.get(3).hashCode()));
        Boolean goodsIdBit = redisTemplate.opsForValue().getBit("goodsIdBit",index);
        if (!goodsIdBit) {
            return;
        }
        String value = (String) redisTemplate.opsForValue().get(key);
        if (StringUtil.isEmpty(value)) {
            String lockKey = "ä¸€å‰‘æ–­è½æ°´";
            try {
                /**
                 * å°è¯•è·å–é”
                 * @param lockKey
                 * @param unit æ—¶é—´å•ä½
                 * @param waitTime æœ€å¤šç­‰å¾…æ—¶é—´
                 * @param leaseTime ä¸Šé”åè‡ªåŠ¨é‡Šæ”¾é”æ—¶é—´
                 * @return
                 */
                boolean locked = RedissLockUtil.tryLock(lockKey, TimeUnit.SECONDS, 5, 10);
                if (locked) {
                    System.out.println("æˆ‘æ˜¯è·å¾—é”çš„çº¿ç¨‹ï¼Œæ±‚å«æˆ‘å¤§ä½¬" + Thread.currentThread().getName());
                    User byId = service.getById(1);
                    System.out.println("ç¡ä¸€ä¸‹,ç„¶åæŠŠä»æ•°æ®åº“æŸ¥åˆ°çš„æ•°æ®æ”¾åˆ°redisä¸­,ç”Ÿäº§ç¯å¢ƒä¸­æ²¡å¿…è¦ç¡ï¼Œæˆ‘è¿™ä¸ªæ˜¯æµ‹è¯•");
                    Thread.sleep(5000);
                    redisTemplate.opsForValue().set(key, "byId", 30, TimeUnit.SECONDS);
                    //è®¾ç½®bitMap
                    redisTemplate.opsForValue().setBit("goodsIdBit", index, true);
                    redisTemplate.delete(lockKey);

                } else {
                    // å…¶å®ƒçº¿ç¨‹è¿›æ¥äº†æ²¡è·å–åˆ°é”ä¾¿ç­‰å¾…50msåé‡è¯•
                    System.out.println("æˆ‘ä»¬æ˜¯æ²¡æœ‰å¾—åˆ°é”çš„çº¿ç¨‹ï¼Œç­‰å¾…ä¸€ä¸‹å†è¯•è¯•");
                    Thread.sleep(50);
                    testRedis();
                }
            } catch (Exception e) {

            } finally {
                redisTemplate.delete(lockKey);
            }
        }

    }
```
ä¸€ä¸ªç®€å•ç»“è®º

```
   List<String> goodsId = new ArrayList<String>();
        goodsId.add("201912010001");
        goodsId.add("20191201002");
        goodsId.add("20191201003");
        goodsId.add("20191201004");

        long index = Math.abs((long) (goodsId.get(3).hashCode()));
        System.out.println(index);
        redisTemplate.opsForValue().setBit("goodsIdBit",index,true);
        Boolean aBoolean = redisTemplate.opsForValue().getBit("goodsIdBit", index);
        System.out.println(aBoolean);
        
        590648468
2019-12-01 14:48:34.099  INFO 220368 --- [           main] io.lettuce.core.EpollProvider            : Starting without optional epoll library
2019-12-01 14:48:34.100  INFO 220368 --- [           main] io.lettuce.core.KqueueProvider           : Starting without optional kqueue library
true

```
> å…¶å®å°±æ˜¯å’Œå‰é¢çš„é”å·®ä¸å¤š å¤šäº†ä¸€ç‚¹æ­¥éª¤ å°±æ˜¯å…ˆçœ‹bitmapä¸­æœ‰æ²¡æœ‰è¿™ä¸ªå•†å“id æœ‰æ‰è®©å®ƒå»redisä¸­æŸ¥å•†å“idçš„æ•°æ® ç„¶åä¿å­˜çš„æ—¶å€™ä¹Ÿè¦setbitè¿™ä¸ªå•†å“ id

> å…¶å®æˆ‘è¿™ä¸ªå†™æ³•å¾ˆåƒåœ¾ ä½†æ˜¯æˆ‘ä¸çŸ¥é“æ€ä¹ˆå®ç°å»å®ç°ä¸€ä¸ªå¸ƒéš†è¿‡æ»¤å™¨ é‚£è®©ä¼°è®¡å¥½ç‚¹ æœ‰å¤§ç¥å¯ä»¥æŒ‡ç‚¹ä¸€ä¸‹ï¼Œä¸èƒœæ„Ÿæ¿€


## ç¼“å­˜ä¸€è‡´æ€§é—®é¢˜

### ä»€ä¹ˆæ˜¯ç¼“å­˜ä¸€è‡´æ€§é—®é¢˜
> è¿™ä¸ªç®€å• å°±æ˜¯æˆ‘ä»¬æ•°æ®åº“çš„æ•°æ®å’Œç¼“å­˜ä¸­çš„æ•°æ®ä¸ä¸€è‡´ï¼Œè¿™å°±æ˜¯ç¼“å­˜ä¸ä¸€è‡´

### å‡ ç§æ–¹å¼ç¼“å­˜ä¸ä¸€è‡´çš„åŸå› å’Œè§£å†³æ–¹æ¡ˆ

- æ–¹æ¡ˆä¸€ **å…ˆæ›´æ–°æ•°æ®åº“ï¼Œå†åˆ ç¼“å­˜**

> è¿™ä¸ªæ–¹æ¡ˆçš„é—®é¢˜æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ å°±æ˜¯å‡è®¾æˆ‘ä»¬æ›´æ–°æ•°æ®æˆåŠŸäº† ç„¶åå»åˆ é™¤ç¼“å­˜çš„æ—¶å€™å¤±è´¥äº† è¿™å°±å¯¼è‡´äº†ç¼“å­˜ä¸­æ˜¯è€æ•°æ®ï¼Œä¼šé€ æˆç¼“å­˜ä¸ä¸€è‡´

> é‚£ä¹ˆæˆ‘è¿™è¾¹æä¾›å‡ ç§ç®€å•çš„è§£å†³æ–¹æ¡ˆ   

> ç¬¬ä¸€ä¸ªå°±æ˜¯ æˆ‘ä»¬åˆ é™¤çš„æ—¶å€™ æŠŠåˆ é™¤ç¼“å­˜çš„æ“ä½œåšä¸ª5æ¬¡çš„å¾ªç¯ ï¼Œå¦‚æœ5æ¬¡åˆ é™¤æ“ä½œéƒ½å¤±è´¥ï¼Œ æˆ‘ä»¬å°±æŠŠè¿™ä¸ªåŠ¨ä½œç”¨mqå‘é€å‡ºå»ç”¨æ¶ˆè´¹åˆ é™¤

> ç¬¬äºŒä¸ªå°±æ˜¯ç”¨ä¸€ä¸ªä¸­é—´ä»¶**canal** å»å…¼å¬mysqlçš„**binlog** ç„¶å ä»binlongä¸­è§£æå‡ºè¦åˆ é™¤çš„å­—æ®µ ç„¶å ç»§ç»­ä¸Šé¢ç¬¬ä¸€ä¸ªçš„æ–¹å¼ï¼ˆè¿™ä¸ªæ–¹å¼çš„å¥½å¤„ å…¨ç¨‹ä¹Ÿç®—æ˜¯å¼‚æ­¥çš„è·Ÿä¸šåŠ¡ä»£ç æ˜¯æ²¡æœ‰å…³ç³»çš„ï¼‰æˆ‘æŠŠæµç¨‹å›¾è´´ä¸‹ï¼š

![](https://user-gold-cdn.xitu.io/2019/12/1/16ec0db1f4083f22?w=743&h=505&f=png&s=52288)

- æ–¹æ¡ˆäºŒ **å…ˆæ›´æ–°æ•°æ®åº“ï¼Œå†æ›´æ–°ç¼“å­˜** 
> è¿™ä¸ªæ“ä½œ é—®é¢˜æ›´å¤šæ„Ÿè§‰ é¦–å…ˆ æ›´æ–°æ•°æ®æˆåŠŸ æ›´æ–°ç¼“å­˜å¤±è´¥ï¼Œæˆ–è€…æ˜¯å¼€å§‹æ›´æ–°æ•°æ®åº“æˆåŠŸ ç„¶åæ›´æ–°ç¼“å­˜æˆåŠŸ ç„¶åäº‹åŠ¡å›æ»šï¼Œä¹Ÿæ˜¯ç¼“å­˜ä¸ä¸€è‡´ã€‚

- æ–¹æ¡ˆä¸‰ **åˆ é™¤ç¼“å­˜ å†æ›´æ–°æ•°æ®åº“**
>çœ‹èµ·æ¥å¥½åƒæœ€å¥½ æˆ‘åæ­£æ˜¯åˆ é™¤ç¼“å­˜äº† å°±ç®—æ›´æ–°å¤±è´¥ ä¸‹æ¬¡å»è¯»ä¹Ÿæ˜¯æœ€æ–°çš„æ•°æ®ï¼ˆä¸€åˆ‡çœ‹èµ·æ¥å¾ˆç¾å¥½ï¼‰,

>å…¶å®ä¸ç„¶ï¼Œè¯•æƒ³2ä¸ªå¹¶å‘ä¸€ä¸ªæ›´æ–° ä¸€ä¸ªæŸ¥è¯¢ ä½ å…ˆæ›´æ–°çš„æ—¶å€™ åˆ é™¤äº†ç¼“å­˜ ä½†æ˜¯æ­¤æ—¶ æŸ¥è¯¢å‘ç°æ²¡æœ‰ç¼“å­˜ ç„¶åå§æ•°æ®ç¼“å­˜åˆ°äº†æ•°æ®åº“ å°±ä¼šå»æŸ¥æ•°æ®åº“ ä½†æ˜¯æ­¤æ—¶æ›´æ–°çš„åˆæ›´æ–°æˆåŠŸï¼Œæœ€åå°±ä¼šå†å¾ˆé•¿çš„ä¸€ä¸ªæ—¶é—´å†… ç¼“å­˜å’Œæ•°æ®åº“æ˜¯ä¸ä¸€è‡´çš„ï¼Œæ‰€ä»¥è¿™ç§æ˜¯æ–¹æ¡ˆæ˜¯ä¸å¯å–çš„

**ç»¼ä¸Šæ‰€è¯‰ï¼Œæˆ‘è§‰å¾—æœ€å¥½çš„æ–¹å¼å…ˆæŸ¥å†åˆ é™¤ ç„¶åå†é…åˆè®¢é˜…binlong æ¥åšå¤šé‡åˆ é™¤çš„æ–¹å¼æ˜¯ä¸é”™çš„ï¼Œå¯èƒ½æˆ‘æ¥è§¦çš„ä¸æ˜¯å¾ˆå¤šï¼Œå¸Œæœ›å„ä½å¤§ä½¬æœ‰æ›´å¥½çš„æ–¹å¼æå‡º**

## ç»“å°¾
>redisçš„å‡ ä¸ªæ¯”è¾ƒæ£˜æ‰‹çš„é—®é¢˜å°±è®²åˆ°è¿™ åé¢è¿˜æœ‰ **luaè„šæœ¬ ä¸»ä» å“¨å…µ** ç­‰æˆ‘ä»¬ä¸‹é›†å†è§

> å› ä¸ºåšä¸»ä¹Ÿæ˜¯ä¸€ä¸ªå¼€å‘èŒæ–° æˆ‘ä¹Ÿæ˜¯ä¸€è¾¹å­¦ä¸€è¾¹å†™ æˆ‘æœ‰ä¸ªç›®æ ‡å°±æ˜¯ä¸€å‘¨ äºŒåˆ°ä¸‰ç¯‡ å¸Œæœ›èƒ½åšæŒä¸ªä¸€å¹´å§ å¸Œæœ›å„ä½å¤§ä½¬å¤šææ„è§ï¼Œè®©æˆ‘å¤šå­¦ä¹ ï¼Œä¸€èµ·è¿›æ­¥ã€‚
## æ—¥å¸¸æ±‚èµ
> å¥½äº†å„ä½ï¼Œä»¥ä¸Šå°±æ˜¯è¿™ç¯‡æ–‡ç« çš„å…¨éƒ¨å†…å®¹äº†ï¼Œèƒ½çœ‹åˆ°è¿™é‡Œçš„äººå‘€ï¼Œéƒ½æ˜¯**äººæ‰**ã€‚

> åˆ›ä½œä¸æ˜“ï¼Œå„ä½çš„æ”¯æŒå’Œè®¤å¯ï¼Œå°±æ˜¯æˆ‘åˆ›ä½œçš„æœ€å¤§åŠ¨åŠ›ï¼Œæˆ‘ä»¬ä¸‹ç¯‡æ–‡ç« è§

>å…­è„‰ç¥å‰‘ | æ–‡ ã€åŸåˆ›ã€‘å¦‚æœæœ¬ç¯‡åšå®¢æœ‰ä»»ä½•é”™è¯¯ï¼Œè¯·æ‰¹è¯„æŒ‡æ•™ï¼Œä¸èƒœæ„Ÿæ¿€ ï¼

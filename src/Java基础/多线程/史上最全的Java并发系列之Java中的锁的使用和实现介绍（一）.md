# å‰è¨€
>æ–‡æœ¬å·²æ”¶å½•è‡³æˆ‘çš„GitHubä»“åº“ï¼Œæ¬¢è¿Starï¼šhttps://github.com/bin392328206/six-finger                             
> **ç§ä¸€æ£µæ ‘æœ€å¥½çš„æ—¶é—´æ˜¯åå¹´å‰ï¼Œå…¶æ¬¡æ˜¯ç°åœ¨**   
>æˆ‘çŸ¥é“å¾ˆå¤šäººä¸ç©**qq**äº†,ä½†æ˜¯æ€€æ—§ä¸€ä¸‹,æ¬¢è¿åŠ å…¥å…­è„‰ç¥å‰‘Javaèœé¸Ÿå­¦ä¹ ç¾¤ï¼Œç¾¤èŠå·ç ï¼š**549684836** é¼“åŠ±å¤§å®¶åœ¨æŠ€æœ¯çš„è·¯ä¸Šå†™åšå®¢
## çµ®å¨ 
å¤šçº¿ç¨‹åŸºç¡€è®²å®Œäº†ï¼Œæ¥ä¸‹å¼€å°±æ˜¯é”äº†ï¼Œè®²å®Œè¿™ä¸¤ä¸ªJavaå¹¶å‘çš„åŸºç¡€å°±å·®ä¸å¤šäº†  
- [ğŸ”¥å²ä¸Šæœ€å…¨çš„Javaå¹¶å‘ç³»åˆ—ä¹‹å¹¶å‘ç¼–ç¨‹çš„æŒ‘æˆ˜](https://juejin.im/post/5dfb1ca26fb9a0160b63827f)  
- [ğŸ”¥å²ä¸Šæœ€å…¨çš„Javaå¹¶å‘ç³»åˆ—ä¹‹Javaå¹¶å‘æœºåˆ¶çš„åº•å±‚å®ç°åŸç†](https://juejin.im/post/5dfb3a27e51d4558181d35b0)    
- [ğŸ”¥å²ä¸Šæœ€å…¨çš„Javaå¹¶å‘ç³»åˆ—ä¹‹Javaå†…å­˜æ¨¡å‹](https://juejin.im/post/5dfc3dadf265da339b5001dd)  
- [ğŸ”¥å²ä¸Šæœ€å…¨çš„Javaå¹¶å‘ç³»åˆ—ä¹‹Javaå¤šçº¿ç¨‹ï¼ˆä¸€ï¼‰](https://juejin.im/post/5dfc9106518825126e63a711) 
- [ğŸ”¥å²ä¸Šæœ€å…¨çš„Javaå¹¶å‘ç³»åˆ—ä¹‹Javaå¤šçº¿ç¨‹ï¼ˆäºŒï¼‰](https://juejin.im/post/5dfeeed6e51d45582248e4a5)


## é”ä»‹ç»
é”æ˜¯ç”¨æ¥æ§åˆ¶å¤šä¸ªçº¿ç¨‹è®¿é—®å…±äº«èµ„æºçš„æ–¹å¼ï¼Œä¸€èˆ¬æ¥è¯´ï¼Œä¸€ä¸ªé”èƒ½å¤Ÿé˜²æ­¢å¤šä¸ªçº¿ç¨‹åŒæ—¶è®¿é—®å…±äº«èµ„æºã€‚

### Lockæ¥å£
åœ¨Java SE 5ä¹‹åï¼Œå¹¶å‘åŒ…ä¸­æ–°å¢äº†Lockæ¥å£ï¼ˆä»¥åŠç›¸å…³å®ç°ç±»ï¼‰ç”¨æ¥å®ç°é”åŠŸèƒ½ï¼Œå®ƒæä¾›äº†ä¸synchronizedå…³é”®å­—ç±»ä¼¼çš„åŒæ­¥åŠŸèƒ½ï¼Œåªæ˜¯åœ¨ä½¿ç”¨æ—¶éœ€è¦ æ˜¾å¼ åœ°è·å–å’Œé‡Šæ”¾é”ã€‚
è™½ç„¶å®ƒç¼ºå°‘äº†ï¼ˆé€šè¿‡synchronizedå—æˆ–è€…æ–¹æ³•æ‰€æä¾›çš„ï¼‰éšå¼è·å–é‡Šæ”¾é”çš„ä¾¿æ·æ€§ï¼Œä½†æ˜¯å´æ‹¥æœ‰äº†é”è·å–ä¸é‡Šæ”¾çš„ å¯æ“ä½œæ€§ã€å¯ä¸­æ–­çš„è·å–é” ä»¥åŠ è¶…æ—¶è·å–é” ç­‰å¤šç§synchronizedå…³é”®å­—æ‰€ä¸å…·å¤‡çš„åŒæ­¥ç‰¹æ€§ã€‚

ä½¿ç”¨synchronizedå…³é”®å­—å°†ä¼š éšå¼ åœ°è·å–é”ï¼Œä½†æ˜¯å®ƒå°†é”çš„è·å–å’Œé‡Šæ”¾å›ºåŒ–äº†ï¼Œä¹Ÿå°±æ˜¯å…ˆè·å–å†é‡Šæ”¾ã€‚

Lockçš„ä½¿ç”¨ï¼š

```
Lock lock = new ReentrantLock();
lock.lock();
try {
} finally {
    lock.unlock();
}
```
æ³¨æ„ ï¼š
1. åœ¨finallyå—ä¸­é‡Šæ”¾é”ï¼Œç›®çš„æ˜¯ä¿è¯åœ¨è·å–åˆ°é”ä¹‹åï¼Œæœ€ç»ˆèƒ½å¤Ÿè¢«é‡Šæ”¾ã€‚
2. ä¸è¦å°†è·å–é”çš„è¿‡ç¨‹å†™åœ¨tryå—ä¸­ï¼Œå› ä¸ºå¦‚æœåœ¨è·å–é”ï¼ˆè‡ªå®šä¹‰é”çš„å®ç°ï¼‰æ—¶å‘ç”Ÿäº†å¼‚å¸¸ï¼Œå¼‚å¸¸æŠ›å‡ºçš„åŒæ—¶ï¼Œä¹Ÿä¼šå¯¼è‡´é”æ— æ•…é‡Šæ”¾ã€‚

Lockæ¥å£æä¾›çš„synchronizedå…³é”®å­—æ‰€ä¸å…·å¤‡çš„ä¸»è¦ç‰¹æ€§ï¼š

- å°è¯•éé˜»å¡æ€§è·å–é”ï¼š å½“å‰çº¿ç¨‹å°è¯•è·å–é”ï¼Œå¦‚æœæ­¤æ—¶æ²¡æœ‰å…¶ä»–çº¿ç¨‹å ç”¨æ­¤é”ï¼Œåˆ™æˆåŠŸè·å–åˆ°é”ã€‚
- èƒ½è¢«ä¸­æ–­çš„è·å–é”ï¼š å½“è·å–åˆ°é”çš„çº¿ç¨‹è¢«ä¸­æ–­æ—¶ï¼Œä¸­æ–­å¼‚å¸¸ä¼šæŠ›å‡ºå¹¶ä¸”ä¼šé‡Šæ”¾é”ã€‚
- è¶…æ—¶è·å–é”ï¼š åœ¨æŒ‡å®šæ—¶é—´å†…è·å–é”ï¼Œå¦‚æœè¶…è¿‡æ—¶é—´è¿˜æ²¡è·å–ï¼Œåˆ™è¿”å›ã€‚

Lock ç›¸å…³çš„APIï¼š
![](https://user-gold-cdn.xitu.io/2019/12/23/16f309aebd642ba2?w=1625&h=350&f=png&s=65909)
- void lock();ï¼šè·å–é”ï¼Œè·å–ä¹‹åè¿”å›
- void lockInterruptibly() throws InterruptedException;ï¼šå¯ä¸­æ–­çš„è·å–é”
- boolean tryLock();ï¼šå°è¯•éé˜»å¡çš„è·å–é”
- boolean tryLock(long time, TimeUnit unit) throws InterruptedException;ï¼š è¶…æ—¶è·å–é”ã€‚ è¶…æ—¶æ—¶é—´ç»“æŸï¼Œæœªè·å¾—é”ï¼Œè¿”å›false.
- void unlock();ï¼šé‡Šæ”¾é”
- Condition newCondition();ï¼šè·å–ç­‰å¾…é€šçŸ¥ç»„ä»¶ï¼Œæ”¹ç»„ä»¶å’Œé”ç»‘å®šï¼Œå½“å‰çº¿ç¨‹è·å–åˆ°é”æ‰èƒ½è°ƒç”¨wait()æ–¹æ³•ï¼Œè°ƒç”¨ä¹‹ååˆ™ä¼šé‡Šæ”¾é”ã€‚

### é˜Ÿåˆ—åŒæ­¥å™¨
é˜Ÿåˆ—åŒæ­¥å™¨AbstractQueuedSynchronizerï¼ˆä»¥ä¸‹ç®€ç§°åŒæ­¥å™¨ï¼‰ï¼Œæ˜¯ç”¨æ¥æ„å»ºé”æˆ–è€…å…¶ä»–åŒæ­¥ç»„ä»¶çš„åŸºç¡€æ¡†æ¶ï¼Œå®ƒä½¿ç”¨äº†ä¸€ä¸ªint æˆå‘˜å˜é‡è¡¨ç¤ºåŒæ­¥çŠ¶æ€ï¼Œé€šè¿‡å†…ç½®çš„FIFOé˜Ÿåˆ—æ¥å®Œæˆèµ„æºè·å–çº¿ç¨‹çš„æ’é˜Ÿå·¥ä½œï¼Œå¹¶å‘åŒ…çš„ä½œè€…Doug LeaæœŸæœ›å®ƒèƒ½å¤Ÿæˆä¸ºå®ç°å¤§éƒ¨åˆ†åŒæ­¥éœ€æ±‚çš„åŸºç¡€ã€‚

åŒæ­¥å™¨çš„ä¸»è¦ä½¿ç”¨æ–¹å¼æ˜¯ç»§æ‰¿AbstractQueuedSynchronizerï¼Œé€šè¿‡åŒæ­¥å™¨æä¾›çš„3ä¸ªæ–¹æ³•getState()ã€setState(int newState)å’ŒcompareAndSetState(int expect,int update)æ¥è¿›è¡Œçº¿ç¨‹å®‰å…¨çš„çŠ¶æ€åŒæ­¥ã€‚

åŒæ­¥å™¨æ˜¯å®ç°é”çš„å…³é”®ï¼Œåœ¨é”çš„å®ç°ä¸­èšåˆåŒæ­¥å™¨ï¼Œåˆ©ç”¨åŒæ­¥å™¨å®ç°é”çš„è¯­ä¹‰ã€‚
å¯ä»¥è¿™æ ·ç†è§£äºŒè€…ä¹‹é—´çš„å…³ç³»ï¼š

- é”æ˜¯é¢å‘ä½¿ç”¨è€…çš„ï¼Œå®ƒå®šä¹‰äº†ä½¿ç”¨è€…ä¸é”äº¤äº’çš„æ¥å£ï¼Œéšè—äº†å®ç°ç»†èŠ‚ï¼›
- åŒæ­¥å™¨é¢å‘çš„æ˜¯é”çš„å®ç°è€…ï¼Œå®ƒç®€åŒ–äº†é”çš„å®ç°æ–¹å¼ï¼Œå±è”½äº†åŒæ­¥çŠ¶æ€ç®¡ç†ã€çº¿ç¨‹çš„æ’é˜Ÿã€ç­‰å¾…ä¸å”¤é†’ç­‰åº•å±‚æ“ä½œã€‚


åŒæ­¥å™¨çš„è®¾è®¡æ˜¯åŸºäºæ¨¡æ¿æ–¹æ³•æ¨¡å¼çš„ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œä½¿ç”¨è€…éœ€è¦ç»§æ‰¿åŒæ­¥å™¨å¹¶é‡å†™æŒ‡å®šçš„ æ–¹æ³•

é˜Ÿåˆ—åŒæ­¥å™¨çš„æ¥å£ä¸ç¤ºä¾‹:AbstractQueuedSynchronizerå¯é‡å†™çš„æ–¹æ³•
- boolean tryAcquire(int arg)ï¼šç‹¬å å¼è·å–åŒæ­¥çŠ¶æ€ã€‚
- boolean tryRelease(int arg)ï¼šç‹¬å å¼é‡Šæ”¾åŒæ­¥çŠ¶æ€ã€‚
- int tryAcquireShared(int arg)ï¼šå…±äº«å¼è·å–åŒæ­¥çŠ¶æ€ã€‚
- boolean tryReleaseShared(int arg)ï¼šå…±äº«é‡Šæ”¾å–åŒæ­¥çŠ¶æ€ã€‚
- boolean isHeldExclusively()ï¼šå½“å‰åŒæ­¥å™¨æ˜¯å¦åœ¨ç‹¬å å¼æ¨¡å¼ä¸‹è¢«çº¿ç¨‹å ç”¨ã€‚

å®ç°è‡ªå®šä¹‰åŒæ­¥ç»„ä»¶æ—¶ï¼Œå°†ä¼šè°ƒç”¨åŒæ­¥å™¨æä¾› ç‹¬å å¼è·å–ä¸é‡Šæ”¾åŒæ­¥çŠ¶æ€ã€å…±äº«å¼è·å–ä¸é‡Šæ”¾åŒæ­¥çŠ¶æ€ å’Œ æŸ¥è¯¢åŒæ­¥é˜Ÿåˆ—ä¸­çš„ç­‰å¾…çº¿ç¨‹æƒ…å†µ ä¸‰ç±»æ¨¡æ¿æ–¹æ³•ã€‚

ç‹¬å é”çš„ç¤ºä¾‹ä»£ç ï¼š

```
public class TestLock implements Lock {
    private TestQueuedSync sync;
    /**
     * è·å–é”
     */
    @Override
    public void lock() {
        sync.acquire(1);
    }
    /**
     * å¯ä¸­æ–­çš„è·å–é”
     */
    @Override
    public void lockInterruptibly() throws InterruptedException {
        sync.acquireInterruptibly(1);
    }
    /**
     * å°è¯•éé˜»å¡å¼è·å–é”
     */
    @Override
    public boolean tryLock() {
        return sync.tryAcquire(1);
    }
    /**
     * å°è¯•éé˜»å¡å¼è·å–é”
     */
    @Override
    public boolean tryLock(long time, TimeUnit unit) throws InterruptedException {
        return sync.tryAcquire(1);
    }
    /**
     * é‡Šæ”¾é”
     */
    @Override
    public void unlock() {
        sync.release(1);
    }
    @Override
    public Condition newCondition() {
        return sync.newCondition();
    }
    /**
     * æ˜¯å¦æœ‰åŒæ­¥é˜Ÿåˆ—çº¿ç¨‹
     */
    public boolean hasQueuedThreads() {
        return sync.hasQueuedThreads();
    }
    /**
     * é”æ˜¯å¦è¢«å ç”¨
     */
    public boolean isLock() {
        return sync.isHeldExclusively();
    }
    private static class TestQueuedSync extends AbstractQueuedSynchronizer {
        /**
         * ç‹¬å å¼è·å–åŒæ­¥çŠ¶æ€
         */
        @Override
        protected boolean tryAcquire(int arg) {
            if (compareAndSetState(0, 1)) {
                setExclusiveOwnerThread(Thread.currentThread());
                return true;
            }
            return false;
        }
        /**
         * ç‹¬å å¼é‡Šæ”¾åŒæ­¥çŠ¶æ€
         */
        @Override
        protected boolean tryRelease(int arg) {
            if (getState() == 0) {
                throw new IllegalStateException();
            }
            setExclusiveOwnerThread(null);
            setState(0);
            return true;
        }
        /**
         * åŒæ­¥çŠ¶æ€æ˜¯å¦è¢«å ç”¨
         */
        @Override
        protected boolean isHeldExclusively() {
            return getState() == 1;
        }
        /**
         * è¿”å›ä¸€ä¸ªConditionï¼Œæ¯ä¸ªconditionéƒ½åŒ…å«äº†ä¸€ä¸ªconditioné˜Ÿåˆ—
         */
        Condition newCondition() {
            return new ConditionObject();
        }
    }
}
```

ä¸Šè¿°ç¤ºä¾‹ä»£ç ä¸­ï¼Œç‹¬å é”TestLockæ˜¯ä¸€ä¸ªè‡ªå®šä¹‰åŒæ­¥ç»„ä»¶ï¼Œå®ƒåœ¨åŒä¸€æ—¶åˆ»åªå…è®¸ä¸€ä¸ªçº¿ç¨‹å æœ‰é”ã€‚TestLockä¸­å®šä¹‰äº†ä¸€ä¸ªé™æ€å†…éƒ¨ç±»TestQueuedSyncç»§æ‰¿äº†åŒæ­¥å™¨ï¼Œåœ¨tryAcquire(int acquires)æ–¹æ³•ä¸­ï¼Œå¦‚æœç»è¿‡compareAndSetStateè®¾ç½®æˆåŠŸï¼Œåˆ™ä»£è¡¨è·å–äº†åŒæ­¥çŠ¶æ€1ï¼Œè€Œåœ¨tryRelease(int releases)æ–¹æ³•ä¸­åªæ˜¯å°†åŒæ­¥çŠ¶æ€é‡ç½®ä¸º0ã€‚

ç”¨æˆ·ä½¿ç”¨TestLockæ—¶å¹¶ä¸ä¼šç›´æ¥å’Œå†…éƒ¨åŒæ­¥å™¨çš„å®ç°TestQueuedSyncæ‰“äº¤é“ï¼Œè€Œæ˜¯è°ƒç”¨TestLockæä¾›çš„æ–¹æ³•ï¼Œåœ¨TestLockçš„å®ç°ä¸­ï¼Œä»¥è·å–é”çš„lock()æ–¹æ³•ä¸ºä¾‹ï¼Œåªéœ€è¦åœ¨æ–¹æ³•å®ç°ä¸­è°ƒç”¨åŒæ­¥å™¨çš„æ¨¡æ¿æ–¹æ³•acquire(int args)å³å¯ï¼Œå½“å‰çº¿ç¨‹è°ƒç”¨è¯¥æ–¹æ³•è·å–åŒæ­¥çŠ¶æ€å¤±è´¥åä¼šè¢«åŠ å…¥åˆ°åŒæ­¥é˜Ÿåˆ—ä¸­ç­‰å¾…ï¼Œè¿™æ ·å°±å¤§å¤§é™ä½äº†å®ç°ä¸€ä¸ªå¯é è‡ªå®šä¹‰åŒæ­¥ç»„ä»¶çš„é—¨æ§›ã€‚

### é˜Ÿåˆ—åŒæ­¥å™¨çš„å®ç°åˆ†æ
æ¥ä¸‹æ¥å°†ä»å®ç°è§’åº¦åˆ†æåŒæ­¥å™¨æ˜¯å¦‚ä½•å®Œæˆçº¿ç¨‹åŒæ­¥çš„ï¼š

åŒæ­¥é˜Ÿåˆ— ï¼š ä¸€ä¸ªFIFOåŒå‘é˜Ÿåˆ—ã€‚
å½“å‰çº¿ç¨‹è·å–åŒæ­¥çŠ¶æ€å¤±è´¥æ—¶ï¼ŒåŒæ­¥å™¨ä¼šå°†å½“å‰çº¿ç¨‹ä»¥åŠç­‰å¾…çŠ¶æ€ç­‰ä¿¡æ¯æ„é€ æˆä¸ºä¸€ä¸ªèŠ‚ç‚¹Nodeå¹¶å°†å…¶åŠ å…¥åŒæ­¥é˜Ÿåˆ—ï¼ŒåŒæ—¶ä¼šé˜»å¡å½“å‰çº¿ç¨‹ï¼Œå½“åŒæ­¥çŠ¶æ€é‡Šæ”¾æ—¶ï¼Œä¼šæŠŠé¦–èŠ‚ç‚¹ä¸­çš„çº¿ç¨‹å”¤é†’ï¼Œä½¿å…¶å†æ¬¡å°è¯•è·å–åŒæ­¥çŠ¶æ€ã€‚
Node ä¿å­˜ è·å–åŒæ­¥çŠ¶æ€å¤±è´¥çš„çº¿ç¨‹å¼•ç”¨ã€ç­‰å¾…çŠ¶æ€ ä»¥åŠ å‰é©±å’Œåç»§èŠ‚ç‚¹ï¼ŒèŠ‚ç‚¹çš„å±æ€§ç±»å‹ ä¸ åç§° ä»¥åŠ æè¿° å¦‚ä¸‹:

æ¥çœ‹ä¸‹å­˜æ”¾çš„Node

```
/**
 * ç­‰å¾…çŠ¶æ€ï¼š
 *  CANCELLED : 1 åœ¨åŒæ­¥é˜Ÿåˆ—ä¸­ç­‰å¾…è¶…æ—¶æˆ–è¢«ä¸­æ–­ï¼Œéœ€è¦ä»é˜Ÿåˆ—ä¸­å–æ¶ˆç­‰å¾…ï¼Œåœ¨è¯¥çŠ¶æ€å°†ä¸ä¼šå˜åŒ–
 *  SIGNAL : -1  åç»§èŠ‚ç‚¹åœ°çº¿ç¨‹å¤„äºç­‰å¾…çŠ¶æ€ï¼Œå½“å‰èŠ‚ç‚¹é‡Šæ”¾è·å–å–æ¶ˆåŒæ­¥çŠ¶æ€ï¼Œåç»§èŠ‚ç‚¹åœ°çº¿ç¨‹å³å¼€å§‹è¿è¡Œ
 *  CONDITION : -2  åœ¨ç­‰å¾…é˜Ÿåˆ—ä¸­ï¼Œ
 *  PROPAGATE : -3 ä¸‹ä¸€æ¬¡å…±äº«å¼åŒæ­¥çŠ¶æ€è·å–å°†ä¼šæ— æ¡ä»¶åœ°è¢«ä¼ æ’­ä¸‹å»
 *  INITAL : 0  åˆå§‹çŠ¶æ€
 */
volatile int waitStatus;
volatile Node prev;//å‰é©±èŠ‚ç‚¹
volatile Node next;//åç»§èŠ‚ç‚¹
volatile Thread thread;//è·å–åŒæ­¥çŠ¶æ€çš„çº¿ç¨‹
Node nextWaiter;//ç­‰å¾…é˜Ÿåˆ—ä¸­çš„åç»§èŠ‚ç‚¹ã€‚ å¦‚æœèŠ‚ç‚¹æ˜¯å…±äº«çš„çš„ï¼Œè¿™ä¸ªå­—æ®µå°†æ˜¯ä¸€ä¸ªSHAREDå¸¸é‡
```

![](https://user-gold-cdn.xitu.io/2019/12/23/16f30ad561b5f965?w=723&h=225&f=png&s=60500)
å¦‚ä¸Šå›¾æ‰€ç¤ºï¼ŒåŒæ­¥å™¨åŒ…å«äº†ä¸¤ä¸ªèŠ‚ç‚¹ç±»å‹çš„å¼•ç”¨ï¼Œä¸€ä¸ªæŒ‡å‘ å¤´èŠ‚ç‚¹ï¼Œè€Œå¦ä¸€ä¸ªæŒ‡å‘ å°¾èŠ‚ç‚¹ã€‚
è¯•æƒ³ä¸€ä¸‹ï¼Œå½“ä¸€ä¸ªçº¿ç¨‹æˆåŠŸåœ°è·å–äº†åŒæ­¥çŠ¶æ€ï¼ˆæˆ–è€…é”ï¼‰ï¼Œå…¶ä»–çº¿ç¨‹å°†æ— æ³•è·å–åˆ°åŒæ­¥çŠ¶æ€ï¼Œè½¬è€Œè¢«æ„é€ æˆä¸ºèŠ‚ç‚¹å¹¶åŠ å…¥åˆ°åŒæ­¥é˜Ÿåˆ—ä¸­ï¼Œè€Œè¿™ä¸ªåŠ å…¥é˜Ÿåˆ—çš„è¿‡ç¨‹å¿…é¡»è¦ä¿è¯çº¿ç¨‹å®‰å…¨ï¼Œå› æ­¤åŒæ­¥å™¨æä¾›äº†ä¸€ä¸ªåŸºäºCASçš„è®¾ç½®å°¾èŠ‚ç‚¹çš„æ–¹æ³•ï¼šcompareAndSetTail(Node expect,Node update)ï¼Œå®ƒéœ€è¦ä¼ é€’å½“å‰çº¿ç¨‹â€œè®¤ä¸ºâ€çš„å°¾èŠ‚ç‚¹å’Œå½“å‰èŠ‚ç‚¹ï¼Œåªæœ‰è®¾ç½®æˆåŠŸåï¼Œå½“å‰èŠ‚ç‚¹æ‰æ­£å¼ä¸ä¹‹å‰çš„å°¾èŠ‚ç‚¹å»ºç«‹å…³è”ã€‚


#### ç‹¬å å¼åŒæ­¥çŠ¶æ€è·å–ä¸é‡Šæ”¾
é€šè¿‡è°ƒç”¨åŒæ­¥å™¨çš„acquire(int arg)æ–¹æ³•å¯ä»¥è·å–åŒæ­¥çŠ¶æ€ï¼Œè¯¥æ–¹æ³•å¯¹ä¸­æ–­ä¸æ•æ„Ÿï¼Œä¹Ÿå°±æ˜¯ç”±äºçº¿ç¨‹è·å–åŒæ­¥çŠ¶æ€å¤±è´¥åè¿›å…¥åŒæ­¥é˜Ÿåˆ—ä¸­ï¼Œåç»­å¯¹çº¿ç¨‹è¿›è¡Œä¸­æ–­æ“ä½œæ—¶ï¼Œçº¿ç¨‹ä¸ä¼šä»åŒæ­¥é˜Ÿåˆ—ä¸­ç§»å‡ºã€‚acquire(int arg)ä»£ç å¦‚ä¸‹ï¼š

![](https://user-gold-cdn.xitu.io/2019/12/23/16f30b3ba72204dd?w=1167&h=224&f=png&s=58226)

```
public final void acquire(int arg) {
    if (!tryAcquire(arg) &&
        acquireQueued(addWaiter(Node.EXCLUSIVE), arg))
        selfInterrupt();
}
```
ä¸Šè¿°ä»£ç ä¸»è¦å®Œæˆäº† åŒæ­¥çŠ¶æ€è·å–ã€èŠ‚ç‚¹æ„é€ ã€åŠ å…¥åŒæ­¥é˜Ÿåˆ— ä»¥åŠ åœ¨åŒæ­¥é˜Ÿåˆ—ä¸­è‡ªæ—‹ç­‰å¾…ã€‚

- é¦–å…ˆè°ƒç”¨è‡ªå®šä¹‰åŒæ­¥å™¨å®ç°çš„tryAcquire(int arg)æ–¹æ³•ä¿è¯çº¿ç¨‹å®‰å…¨çš„è·å–åŒæ­¥çŠ¶æ€
å¦‚æœè·å–åŒæ­¥çŠ¶æ€å¤±è´¥ï¼Œæ„é€ åŒæ­¥èŠ‚ç‚¹ï¼ˆç‹¬å å¼Node.EXCLUSIVEï¼ŒåŒä¸€æ—¶åˆ»åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹æˆåŠŸè·å–åŒæ­¥çŠ¶æ€ï¼‰å¹¶é€šè¿‡addWaiter(Node node)æ–¹æ³•å°†è¯¥èŠ‚ç‚¹åŠ å…¥åˆ°åŒæ­¥é˜Ÿåˆ—çš„å°¾éƒ¨ã€‚
- æœ€åè°ƒç”¨acquireQueued(Node node,int arg)æ–¹æ³•ï¼Œä½¿å¾—è¯¥èŠ‚ç‚¹ä»¥â€œæ­»å¾ªç¯â€çš„æ–¹å¼è·å–åŒæ­¥çŠ¶æ€
å¦‚æœè·å–ä¸åˆ°åˆ™é˜»å¡èŠ‚ç‚¹ä¸­çš„çº¿ç¨‹ï¼Œè€Œ è¢«é˜»å¡çº¿ç¨‹çš„å”¤é†’ ä¸»è¦ä¾é  å‰é©±èŠ‚ç‚¹çš„å‡ºé˜Ÿæˆ– é˜»å¡çº¿ç¨‹è¢«ä¸­æ–­ æ¥å®ç°ã€‚


æˆ‘ä»¬æ¥çœ‹ä¸‹èŠ‚ç‚¹çš„æ„é€ ä»¥åŠåŠ å…¥åŒæ­¥é˜Ÿåˆ—çš„addWaiter(Node mode)å’ŒinitializeSyncQueue()æ–¹æ³•ï¼š
```
private Node addWaiter(Node mode) {
    Node node = new Node(mode);
    for (;;) {
        Node oldTail = tail;
        if (oldTail != null) {
            U.putObject(node, Node.PREV, oldTail);
            if (compareAndSetTail(oldTail, node)) {
                oldTail.next = node;
                return node;
            }
        } else {
            initializeSyncQueue();
        }
    }
}
private final void initializeSyncQueue() {
    Node h;
    if (U.compareAndSwapObject(this, HEAD, null, (h = new Node())))
        tail = h;
}
```
ä¸Šè¿°ä»£ç é€šè¿‡åœ¨â€œæ­»å¾ªç¯â€ä¸­ä½¿ç”¨compareAndSetTail(Node expect,Node update)æ–¹æ³•æ¥ç¡®ä¿èŠ‚ç‚¹èƒ½å¤Ÿè¢«çº¿ç¨‹å®‰å…¨æ·»åŠ ã€‚ å¦‚æœæ²¡æœ‰å°¾èŠ‚ç‚¹çš„è¯ï¼Œåˆ™æ„å»ºä¸€ä¸ªæ–°çš„åŒæ­¥é˜Ÿåˆ—ã€‚

æ¥ä¸‹æ¥çœ‹ä¸‹acquireQueued(final Node node, int arg)æ–¹æ³•ï¼š

```
final boolean acquireQueued(final Node node, int arg) {
    try {
        boolean interrupted = false;
        for (;;) {
            final Node p = node.predecessor();
            if (p == head && tryAcquire(arg)) {
                setHead(node);
                p.next = null; // help GC
                return interrupted;
            }
            if (shouldParkAfterFailedAcquire(p, node) &&
                parkAndCheckInterrupt())
                interrupted = true;
        }
    } catch (Throwable t) {
        cancelAcquire(node);
        throw t;
    }
}
```
åœ¨acquireQueued(final Node node,int arg)æ–¹æ³•ä¸­ï¼Œå½“å‰çº¿ç¨‹åœ¨â€œæ­»å¾ªç¯â€ä¸­å°è¯•è·å–åŒæ­¥çŠ¶æ€ï¼Œè€Œåªæœ‰å‰é©±èŠ‚ç‚¹æ˜¯å¤´èŠ‚ç‚¹æ‰èƒ½å¤Ÿå°è¯•è·å–åŒæ­¥çŠ¶æ€ï¼Œè¿™æ˜¯ä¸ºä»€ä¹ˆï¼ŸåŸå› æœ‰ä¸¤ä¸ª:
- å¤´èŠ‚ç‚¹æ˜¯æˆåŠŸè·å–åˆ°åŒæ­¥çŠ¶æ€çš„èŠ‚ç‚¹ï¼Œè€Œå¤´èŠ‚ç‚¹çš„çº¿ç¨‹é‡Šæ”¾äº†åŒæ­¥çŠ¶æ€ä¹‹åï¼Œå°†ä¼šå”¤é†’å…¶åç»§èŠ‚ç‚¹ï¼Œåç»§èŠ‚ç‚¹çš„çº¿ç¨‹è¢«å”¤é†’åéœ€è¦æ£€æŸ¥è‡ªå·±çš„å‰é©±èŠ‚ç‚¹æ˜¯å¦æ˜¯å¤´èŠ‚ç‚¹ã€‚
- ç»´æŠ¤åŒæ­¥é˜Ÿåˆ—çš„FIFOåŸåˆ™ã€‚

![](https://user-gold-cdn.xitu.io/2019/12/23/16f30bc4a2671d95?w=644&h=718&f=png&s=160839)

### è‡ªå®šä¹‰åŒæ­¥ç»„ä»¶
- åœ¨åŒä¸€æ—¶åˆ»ï¼Œåªå…è®¸è‡³å¤šä¸¤ä¸ªçº¿ç¨‹åŒæ—¶è®¿é—®ï¼Œè¶…è¿‡ä¸¤ä¸ªçº¿ç¨‹çš„è®¿é—®å°†è¢«é˜»å¡ã€‚
- èƒ½å¤Ÿåœ¨åŒä¸€æ—¶åˆ»æ”¯æŒå¤šä¸ªçº¿ç¨‹çš„è®¿é—®(å…±äº«å¼è®¿é—®)ã€‚

```
package com.atguigu.ct.producer.Test.BB;

import java.util.concurrent.TimeUnit;
import java.util.concurrent.locks.AbstractQueuedSynchronizer;
import java.util.concurrent.locks.Condition;
import java.util.concurrent.locks.Lock;

public class CustomLock implements Lock  {
    private CustomSyncQueue customSyncQueue = new CustomSyncQueue(2);
    public static void main(String[] args) {
        final Lock lock = new CustomLock();
        class Worker extends Thread  {
            @Override
            public void run() {
                while (true) {
                    lock.lock();
                    try {
                        TimeUnit.SECONDS.sleep(1);
                        System.out.println(Thread.currentThread().getName());
                        TimeUnit.SECONDS.sleep(1);
                    }
                    catch (Exception e ){
                        
                    }
                    finally {
                        lock.unlock();
                    }
                }
            }
        }
        // å¯åŠ¨10ä¸ªçº¿ç¨‹
        for (int i = 0; i < 10; i++) {
            Worker w = new Worker();
            w.setDaemon(true);
            w.start();
        }
        // æ¯éš”1ç§’æ¢è¡Œ
        for (int i = 0; i < 10; i++) {
            System.out.println();
        }
    }
    @Override
    public void lock() {
        customSyncQueue.tryAcquireShared(1);
    }
    @Override
    public void unlock() {
        customSyncQueue.tryReleaseShared(1);
    }
    public static class CustomSyncQueue extends AbstractQueuedSynchronizer {
        public CustomSyncQueue(int count) {
            if (count <= 0) {
                throw new IllegalStateException("count must >= 0");
            }
            setState(count);
        }
        @Override
        protected int tryAcquireShared(int reduceCount) {
            for (; ; ) {
                int current = getState();
                int newCount = current - reduceCount;
                if (newCount < 0 || compareAndSetState(current, newCount)) {
                    return newCount;
                }
            }
        }
        @Override
        protected boolean tryReleaseShared(int returnCount) {
            for (; ; ) {
                int current = getState();
                int newCount = current + returnCount;
                if (compareAndSetState(current, newCount)) {
                    return true;
                }
            }
        }
    }

    @Override
    public void lockInterruptibly() throws InterruptedException {
        
    }

    @Override
    public boolean tryLock() {
        return false;
    }

    @Override
    public boolean tryLock(long time, TimeUnit unit) throws InterruptedException {
        return false;
    }

    @Override
    public Condition newCondition() {
        return null;
    }
}

```
åœ¨ä¸Šè¿°ç¤ºä¾‹ä¸­ï¼ŒCustomLockå®ç°äº†Lockæ¥å£ï¼Œæä¾›äº†é¢å‘ä½¿ç”¨è€…çš„æ¥å£ï¼Œä½¿ç”¨è€…è°ƒç”¨lock() æ–¹æ³•è·å–é”ï¼Œéšåè°ƒç”¨unlock()æ–¹æ³•é‡Šæ”¾é”ï¼Œè€ŒåŒä¸€æ—¶åˆ»åªèƒ½æœ‰ä¸¤ä¸ªçº¿ç¨‹åŒæ—¶è·å–åˆ°é”ã€‚ TwinsLockåŒæ—¶åŒ…å«äº†ä¸€ä¸ªè‡ªå®šä¹‰åŒæ­¥å™¨Syncï¼Œè€Œè¯¥åŒæ­¥å™¨é¢å‘çº¿ç¨‹è®¿é—®å’ŒåŒæ­¥çŠ¶æ€æ§åˆ¶ã€‚ä»¥ å…±äº«å¼è·å–åŒæ­¥çŠ¶æ€ä¸ºä¾‹ï¼šåŒæ­¥å™¨ä¼šå…ˆè®¡ç®—å‡ºè·å–åçš„åŒæ­¥çŠ¶æ€ï¼Œç„¶åé€šè¿‡CASç¡®ä¿çŠ¶æ€çš„æ­£ ç¡®è®¾ç½®ï¼Œå½“tryAcquireShared(int reduceCount)æ–¹æ³•è¿”å›å€¼å¤§äºç­‰äº0æ—¶ï¼Œå½“å‰çº¿ç¨‹æ‰è·å–åŒæ­¥çŠ¶ æ€ï¼Œå¯¹äºä¸Šå±‚çš„TwinsLockè€Œè¨€ï¼Œåˆ™è¡¨ç¤ºå½“å‰çº¿ç¨‹è·å¾—äº†é”ã€‚

åŒæ­¥å™¨ä½œä¸ºä¸€ä¸ªæ¡¥æ¢ï¼Œè¿æ¥çº¿ç¨‹è®¿é—®ä»¥åŠåŒæ­¥çŠ¶æ€æ§åˆ¶ç­‰åº•å±‚æŠ€æœ¯ä¸ä¸åŒå¹¶å‘ç»„ä»¶ï¼ˆæ¯”å¦‚ Lockã€CountDownLatchç­‰ï¼‰çš„æ¥å£è¯­ä¹‰

## ç»“å°¾

ç®€ç›´å°±æ˜¯æ¯ç‡¥ï¼Œå“ˆå“ˆï¼Œä¼°è®¡å¾ˆå¤šäººçœ‹åˆ°å¾ˆæ‡µé€¼ï¼Œåœ¨è¿™æˆ‘è‡ªå·±ä¹Ÿæ˜¯æµ…å°è¾„æ­¢ï¼Œç»™å¤§å®¶æ€»ç»“ä¸€ä¸‹ä»Šå¤©è¯´çš„å•¥å§ï¼š
- ç¬¬ä¸€ä¸ªå°±æ˜¯Lockæ¥å£ï¼Œä»–æ˜¯ä¸€ä¸ªé”çš„æ¥å£ï¼Œè¦è‡ªå®šä¹‰é”ï¼Œå°±è¦å®ç°å®ƒï¼Œå®ƒæ˜¯é¢å‘æˆ‘ä»¬å¼€å‘ä½¿ç”¨çš„ã€‚
- ç¬¬äºŒä¸ªå°±æ˜¯æˆ‘ä»¬çš„é˜Ÿåˆ—åŒæ­¥å™¨ï¼Œä»–æ˜¯é”çš„å…·ä½“å®ç°ï¼Œæ˜¯ä¸€ä¸ªé”çš„åº•å±‚æ‰€åœ¨ï¼Œé€šè¿‡å»ç»§æ‰¿ AbstractQueuedSynchronizer è¿™ä¸ªç±»ï¼Œå¯ä»¥è‡ªå®šä¹‰ä¸€ä¸ªé”ï¼Œæ¯”å¦‚è¯´ç‹¬å é”ï¼Œæˆ–è€…æ˜¯å‡ ä¸ªçº¿ç¨‹åŒæ—¶æ‹¿åˆ°é”ï¼Œéƒ½æ˜¯è‡ªå·±å»å®ç°çš„ï¼Œè™½ç„¶æœ‰ç‚¹æ¯ç‡¥ï¼Œä½†æ˜¯è¿™ä¸ªè¿˜æ˜¯å¾ˆæœ‰ç”¨çš„ã€‚

> å› ä¸ºåšä¸»ä¹Ÿæ˜¯ä¸€ä¸ªå¼€å‘èŒæ–° æˆ‘ä¹Ÿæ˜¯ä¸€è¾¹å­¦ä¸€è¾¹å†™ æˆ‘æœ‰ä¸ªç›®æ ‡å°±æ˜¯ä¸€å‘¨ äºŒåˆ°ä¸‰ç¯‡ å¸Œæœ›èƒ½åšæŒä¸ªä¸€å¹´å§ å¸Œæœ›å„ä½å¤§ä½¬å¤šææ„è§ï¼Œè®©æˆ‘å¤šå­¦ä¹ ï¼Œä¸€èµ·è¿›æ­¥ã€‚
## æ—¥å¸¸æ±‚èµ
> å¥½äº†å„ä½ï¼Œä»¥ä¸Šå°±æ˜¯è¿™ç¯‡æ–‡ç« çš„å…¨éƒ¨å†…å®¹äº†ï¼Œèƒ½çœ‹åˆ°è¿™é‡Œçš„äººå‘€ï¼Œéƒ½æ˜¯**çœŸç²‰**ã€‚

> åˆ›ä½œä¸æ˜“ï¼Œå„ä½çš„æ”¯æŒå’Œè®¤å¯ï¼Œå°±æ˜¯æˆ‘åˆ›ä½œçš„æœ€å¤§åŠ¨åŠ›ï¼Œæˆ‘ä»¬ä¸‹ç¯‡æ–‡ç« è§

>å…­è„‰ç¥å‰‘ | æ–‡ ã€åŸåˆ›ã€‘å¦‚æœæœ¬ç¯‡åšå®¢æœ‰ä»»ä½•é”™è¯¯ï¼Œè¯·æ‰¹è¯„æŒ‡æ•™ï¼Œä¸èƒœæ„Ÿæ¿€ ï¼

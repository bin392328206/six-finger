# å‰è¨€
>æ–‡æœ¬å·²æ”¶å½•è‡³æˆ‘çš„GitHubä»“åº“ï¼Œæ¬¢è¿Starï¼šhttps://github.com/bin392328206/six-finger                             
> **ç§ä¸€æ£µæ ‘æœ€å¥½çš„æ—¶é—´æ˜¯åå¹´å‰ï¼Œå…¶æ¬¡æ˜¯ç°åœ¨**   
>æˆ‘çŸ¥é“å¾ˆå¤šäººä¸ç©**qq**äº†,ä½†æ˜¯æ€€æ—§ä¸€ä¸‹,æ¬¢è¿åŠ å…¥å…­è„‰ç¥å‰‘Javaèœé¸Ÿå­¦ä¹ ç¾¤ï¼Œç¾¤èŠå·ç ï¼š**549684836** é¼“åŠ±å¤§å®¶åœ¨æŠ€æœ¯çš„è·¯ä¸Šå†™åšå®¢
## çµ®å¨ 
ä¸çŸ¥é“è¯´å•¥ï¼Œç»§ç»­å¹²ï¼Œè¿™æœ¬ä¹¦å¿«å¹²å®Œäº†   
- [ğŸ”¥å²ä¸Šæœ€å…¨çš„Javaå¹¶å‘ç³»åˆ—ä¹‹å¹¶å‘ç¼–ç¨‹çš„æŒ‘æˆ˜](https://juejin.im/post/5dfb1ca26fb9a0160b63827f)  
- [ğŸ”¥å²ä¸Šæœ€å…¨çš„Javaå¹¶å‘ç³»åˆ—ä¹‹Javaå¹¶å‘æœºåˆ¶çš„åº•å±‚å®ç°åŸç†](https://juejin.im/post/5dfb3a27e51d4558181d35b0)    
- [ğŸ”¥å²ä¸Šæœ€å…¨çš„Javaå¹¶å‘ç³»åˆ—ä¹‹Javaå†…å­˜æ¨¡å‹](https://juejin.im/post/5dfc3dadf265da339b5001dd)  
- [ğŸ”¥å²ä¸Šæœ€å…¨çš„Javaå¹¶å‘ç³»åˆ—ä¹‹Javaå¤šçº¿ç¨‹ï¼ˆä¸€ï¼‰](https://juejin.im/post/5dfc9106518825126e63a711) 
- [ğŸ”¥å²ä¸Šæœ€å…¨çš„Javaå¹¶å‘ç³»åˆ—ä¹‹Javaå¤šçº¿ç¨‹ï¼ˆäºŒï¼‰](https://juejin.im/post/5dfeeed6e51d45582248e4a5)   
- [ğŸ”¥å²ä¸Šæœ€å…¨çš„Javaå¹¶å‘ç³»åˆ—ä¹‹Javaä¸­çš„é”çš„ä½¿ç”¨å’Œå®ç°ä»‹ç»ï¼ˆä¸€ï¼‰](https://juejin.im/post/5e002416e51d45583b43939d) 
- [ğŸ”¥å²ä¸Šæœ€å…¨çš„Javaå¹¶å‘ç³»åˆ—ä¹‹Javaä¸­çš„é”çš„ä½¿ç”¨å’Œå®ç°ä»‹ç»ï¼ˆäºŒï¼‰](https://juejin.im/post/5e0037a651882512670ee0b5)  
- [ğŸ”¥å²ä¸Šæœ€å…¨çš„Javaå¹¶å‘ç³»åˆ—ä¹‹Javaå¹¶å‘å®¹å™¨å’Œæ¡†æ¶](https://juejin.im/post/5e005f746fb9a016253c15d5)   
- [ğŸ”¥å²ä¸Šæœ€å…¨çš„Javaå¹¶å‘ç³»åˆ—ä¹‹Javaä¸­çš„13ä¸ªåŸå­æ“ä½œç±»](https://juejin.im/post/5e006bf6518825126e63a9fb)    
- [ğŸ”¥å²ä¸Šæœ€å…¨çš„Javaå¹¶å‘ç³»åˆ—ä¹‹Javaä¸­çš„å¹¶å‘å·¥å…·ç±»](https://juejin.im/post/5e0076a45188251247688749)  

## å‰è¨€
> Javaä¸­çš„çº¿ç¨‹æ± æ˜¯è¿ç”¨åœºæ™¯æœ€å¤šçš„å¹¶å‘æ¡†æ¶ï¼Œå‡ ä¹æ‰€æœ‰éœ€è¦å¼‚æ­¥æˆ–å¹¶å‘æ‰§è¡Œä»»åŠ¡çš„ç¨‹åºéƒ½å¯ä»¥ä½¿ç”¨çº¿ç¨‹æ± ã€‚
åœ¨å¼€å‘è¿‡ç¨‹ä¸­ï¼Œåˆç†åœ°ä½¿ç”¨çº¿ç¨‹æ± èƒ½å¤Ÿå¸¦æ¥3ä¸ªå¥½å¤„ã€‚

- é™ä½èµ„æºæ¶ˆè€—ã€‚é€šè¿‡é‡å¤åˆ©ç”¨å·²åˆ›å»ºçš„çº¿ç¨‹é™ä½çº¿ç¨‹åˆ›å»ºå’Œé”€æ¯é€ æˆçš„æ¶ˆè€—ã€‚
- æé«˜å“åº”é€Ÿåº¦ã€‚å½“ä»»åŠ¡åˆ°è¾¾æ—¶ï¼Œä»»åŠ¡å¯ä»¥ä¸éœ€è¦ç­‰åˆ°çº¿ç¨‹åˆ›å»ºå°±èƒ½ç«‹å³æ‰§è¡Œã€‚
- æé«˜çº¿ç¨‹çš„å¯ç®¡ç†æ€§ã€‚çº¿ç¨‹æ˜¯ç¨€ç¼ºèµ„æºï¼Œå¦‚æœæ— é™åˆ¶åœ°åˆ›å»ºï¼Œä¸ä»…ä¼šæ¶ˆè€—ç³»ç»Ÿèµ„æºï¼Œè¿˜ä¼šé™ä½ç³»ç»Ÿçš„ç¨³å®šæ€§ï¼Œä½¿ç”¨çº¿ç¨‹æ± å¯ä»¥è¿›è¡Œç»Ÿ- ä¸€åˆ†é…ã€è°ƒä¼˜å’Œç›‘æ§ã€‚ä½†æ˜¯ï¼Œè¦åšåˆ°åˆç†åˆ©ç”¨çº¿ç¨‹æ± ï¼Œå¿…é¡»å¯¹å…¶å®ç°åŸç†äº†å¦‚æŒ‡æŒã€‚

### çº¿ç¨‹æ± çš„å®ç°åŸç†

å½“å‘çº¿ç¨‹æ± æäº¤ä¸€ä¸ªä»»åŠ¡ä¹‹åï¼Œçº¿ç¨‹æ± æ˜¯å¦‚ä½•å¤„ç†è¿™ä¸ªä»»åŠ¡çš„å‘¢ï¼Ÿ
æœ¬æ–‡æ¥çœ‹ä¸€ä¸‹çº¿ç¨‹æ± çš„ä¸»è¦å¤„ç†æµç¨‹ï¼Œå¤„ç†æµç¨‹å›¾ä¸‹å›¾æ‰€ç¤ºã€‚

![](https://user-gold-cdn.xitu.io/2019/12/23/16f32acb56f37396?w=708&h=390&f=png&s=62644)
ä»å›¾ä¸­å¯ä»¥çœ‹å‡ºï¼Œå½“æäº¤ä¸€ä¸ªæ–°ä»»åŠ¡åˆ°çº¿ç¨‹æ± æ—¶ï¼Œçº¿ç¨‹æ± çš„å¤„ç†æµç¨‹å¦‚ä¸‹ã€‚

1. çº¿ç¨‹æ± åˆ¤æ–­æ ¸å¿ƒçº¿ç¨‹æ± é‡Œçš„çº¿ç¨‹æ˜¯å¦éƒ½åœ¨æ‰§è¡Œä»»åŠ¡ã€‚å¦‚æœä¸æ˜¯ï¼Œåˆ™åˆ›å»ºä¸€ä¸ªæ–°çš„å·¥ä½œçº¿ç¨‹æ¥æ‰§è¡Œä»»åŠ¡ã€‚å¦‚æœæ ¸å¿ƒçº¿ç¨‹æ± é‡Œçš„çº¿ç¨‹éƒ½åœ¨æ‰§è¡Œä»»åŠ¡ï¼Œåˆ™è¿›å…¥ä¸‹ä¸ªæµç¨‹ã€‚
2. çº¿ç¨‹æ± åˆ¤æ–­å·¥ä½œé˜Ÿåˆ—æ˜¯å¦å·²ç»æ»¡ã€‚å¦‚æœå·¥ä½œé˜Ÿåˆ—æ²¡æœ‰æ»¡ï¼Œåˆ™å°†æ–°æäº¤çš„ä»»åŠ¡å­˜å‚¨åœ¨è¿™ä¸ªå·¥ä½œé˜Ÿåˆ—é‡Œã€‚å¦‚æœå·¥ä½œé˜Ÿåˆ—æ»¡äº†ï¼Œåˆ™è¿›å…¥ä¸‹ä¸ªæµç¨‹ã€‚
3. çº¿ç¨‹æ± åˆ¤æ–­çº¿ç¨‹æ± çš„çº¿ç¨‹æ˜¯å¦éƒ½å¤„äºå·¥ä½œçŠ¶æ€ã€‚å¦‚æœæ²¡æœ‰ï¼Œåˆ™åˆ›å»ºä¸€ä¸ªæ–°çš„å·¥ä½œçº¿ç¨‹æ¥æ‰§è¡Œä»»åŠ¡ã€‚å¦‚æœå·²ç»æ»¡äº†ï¼Œåˆ™äº¤ç»™é¥±å’Œç­–ç•¥æ¥å¤„ç†è¿™ä¸ªä»»åŠ¡ã€‚

ThreadPoolExecutor æ‰§è¡Œ execute() æ–¹æ³•çš„ç¤ºæ„å›¾å¦‚ä¸‹ï¼š

![](https://user-gold-cdn.xitu.io/2019/12/23/16f32af6e747866f?w=694&h=608&f=png&s=93748)

ThreadPoolExecutoræ‰§è¡Œexecuteæ–¹æ³•åˆ†ä¸‹é¢4ç§æƒ…å†µï¼š

- å¦‚æœå½“å‰è¿è¡Œçš„çº¿ç¨‹å°‘äºcorePoolSizeï¼Œåˆ™åˆ›å»ºæ–°çº¿ç¨‹æ¥æ‰§è¡Œä»»åŠ¡ï¼ˆæ³¨æ„ï¼Œæ‰§è¡Œè¿™ä¸€æ­¥éª¤éœ€è¦è·å–å…¨å±€é”ï¼‰ã€‚ä¸Šå›¾1
- å¦‚æœè¿è¡Œçš„çº¿ç¨‹ç­‰äºæˆ–å¤šäºcorePoolSizeï¼Œåˆ™å°†ä»»åŠ¡åŠ å…¥BlockingQueueã€‚ä¸Šå›¾2
- å¦‚æœæ— æ³•å°†ä»»åŠ¡åŠ å…¥BlockingQueueï¼ˆé˜Ÿåˆ—å·²æ»¡ï¼‰ï¼Œåˆ™åˆ›å»ºæ–°çš„çº¿ç¨‹æ¥å¤„ç†ä»»åŠ¡ï¼ˆæ³¨æ„ï¼Œæ‰§è¡Œè¿™ä¸€æ­¥éª¤éœ€è¦è·å–å…¨å±€é”ï¼‰ã€‚ä¸Šå›¾3
- å¦‚æœåˆ›å»ºæ–°çº¿ç¨‹å°†ä½¿å½“å‰è¿è¡Œçš„çº¿ç¨‹è¶…å‡ºmaximumPoolSizeï¼Œä»»åŠ¡å°†è¢«æ‹’ç»ï¼Œå¹¶è°ƒç”¨RejectedExecutionHandler.rejectedExecution()æ–¹æ³•ã€‚ä¸Šå›¾4

ThreadPoolExecutoré‡‡å–ä¸Šè¿°æ­¥éª¤çš„æ€»ä½“è®¾è®¡æ€è·¯ï¼Œæ˜¯ä¸ºäº†åœ¨æ‰§è¡Œexecute()æ–¹æ³•æ—¶ï¼Œå°½å¯èƒ½åœ°é¿å…è·å–å…¨å±€é”ï¼ˆé‚£å°†ä¼šæ˜¯ä¸€ä¸ªä¸¥é‡çš„å¯ä¼¸ç¼©ç“¶é¢ˆï¼‰ã€‚åœ¨ThreadPoolExecutorå®Œæˆé¢„çƒ­ä¹‹åï¼ˆå½“å‰è¿è¡Œçš„çº¿ç¨‹æ•°å¤§äºç­‰äºcorePoolSizeï¼‰ï¼Œå‡ ä¹æ‰€æœ‰çš„execute()æ–¹æ³•è°ƒç”¨éƒ½æ˜¯æ‰§è¡Œ ä¸Šå›¾2 ï¼Œè€Œ ä¸Šå›¾2 ä¸éœ€è¦è·å–å…¨å±€é”ã€‚

### æºç åˆ†æ
ä¸Šé¢çš„æµç¨‹åˆ†æè®©æˆ‘ä»¬å¾ˆç›´è§‚åœ°äº†è§£äº†çº¿ç¨‹æ± çš„å·¥ä½œåŸç†ï¼Œè®©æˆ‘ä»¬å†é€šè¿‡æºä»£ç æ¥çœ‹çœ‹æ˜¯å¦‚ä½•å®ç°çš„ï¼Œçº¿ç¨‹æ± æ‰§è¡Œä»»åŠ¡çš„æ–¹æ³•å¦‚ä¸‹ï¼š

```
public void execute(Runnable command) {
    if (command == null)
        throw new NullPointerException();

    int c = ctl.get();
    if (workerCountOf(c) < corePoolSize) {
        // å¦‚æœçº¿ç¨‹æ•°å°äºåŸºæœ¬çº¿ç¨‹æ•°ï¼Œåˆ™åˆ›å»ºçº¿ç¨‹å¹¶æ‰§è¡Œå½“å‰ä»»åŠ¡
        if (addWorker(command, true))
            return;
        c = ctl.get();
    }

    // å¦‚çº¿ç¨‹æ•°å¤§äºç­‰äºåŸºæœ¬çº¿ç¨‹æ•°æˆ–çº¿ç¨‹åˆ›å»ºå¤±è´¥ï¼Œåˆ™å°†å½“å‰ä»»åŠ¡æ”¾åˆ°å·¥ä½œé˜Ÿåˆ—ä¸­ã€‚
    if (isRunning(c) && workQueue.offer(command)) {
        int recheck = ctl.get();
        if (!isRunning(recheck) && remove(command))
            reject(command);
        else if (workerCountOf(recheck) == 0)
            addWorker(null, false);
    } else if (!addWorker(command, false))
        // å¦‚æœçº¿ç¨‹æ± ä¸å¤„äºè¿è¡Œä¸­æˆ–ä»»åŠ¡æ— æ³•æ”¾å…¥é˜Ÿåˆ—ï¼Œ
        //å¹¶ä¸”å½“å‰çº¿ç¨‹æ•°é‡å°äºæœ€å¤§å…è®¸çš„çº¿ç¨‹æ•°é‡,åˆ™åˆ›å»ºä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œä»»åŠ¡.

        // æŠ›å‡ºRejectedExecutionExceptionå¼‚å¸¸
        reject(command);
}
```

å·¥ä½œçº¿ç¨‹ï¼šçº¿ç¨‹æ± åˆ›å»ºçº¿ç¨‹æ—¶ï¼Œä¼šå°†çº¿ç¨‹å°è£…æˆå·¥ä½œçº¿ç¨‹Workerï¼ŒWorkeråœ¨æ‰§è¡Œå®Œä»»åŠ¡åï¼Œè¿˜ä¼šå¾ªç¯è·å–å·¥ä½œé˜Ÿåˆ—é‡Œçš„ä»»åŠ¡æ¥æ‰§è¡Œã€‚æˆ‘ä»¬å¯ä»¥ä»Workerç±»çš„run()æ–¹æ³•é‡Œçœ‹åˆ°è¿™ç‚¹

```
public void run() {
    try {
        Runnable task = firstTask;
        firstTask = null;
        while (task != null || (task = getTask()) != null) {
            runTask(task);
            task = null;
        }
    } finally {
        workerDone(this);
    }
}
```
è¯´æ˜çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹éƒ½æ˜¯è¿è¡ŒçŠ¶æ€ 

ThreadPoolExecutorä¸­çº¿ç¨‹æ‰§è¡Œä»»åŠ¡çš„ç¤ºæ„å›¾å¦‚ä¸‹ï¼š

![](https://user-gold-cdn.xitu.io/2019/12/23/16f32b60ea5efd72?w=687&h=474&f=png&s=61253)

çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ‰§è¡Œä»»åŠ¡åˆ†ä¸¤ç§æƒ…å†µï¼š

- åœ¨execute()æ–¹æ³•ä¸­åˆ›å»ºä¸€ä¸ªçº¿ç¨‹æ—¶ï¼Œä¼šè®©è¿™ä¸ªçº¿ç¨‹æ‰§è¡Œå½“å‰ä»»åŠ¡ã€‚
- è¿™ä¸ªçº¿ç¨‹æ‰§è¡Œå®Œä¸Šå›¾ä¸­1çš„ä»»åŠ¡åï¼Œä¼šåå¤ä»BlockingQueueè·å–ä»»åŠ¡æ¥æ‰§è¡Œã€‚

## çº¿ç¨‹æ± çš„æºç ï¼ˆThreadPoolExecutorï¼‰
æˆ‘å°±è®²è®²Javaçš„ThreadPoolExecutorå§ï¼ŒSpringçš„ThreadPoolTaskExecutoråº•å±‚ä¹Ÿæ˜¯Javaçš„ThreadPoolExecutor

### ç»§æ‰¿ç»“æ„

![](https://user-gold-cdn.xitu.io/2019/12/24/16f35f45d8ccbdbb?w=428&h=492&f=png&s=18343)
- Executoræ¥å£åªæœ‰ä¸€ä¸ªæ–¹æ³•execute,ä¼ å…¥çº¿ç¨‹ä»»åŠ¡å‚æ•°
- ExecutorServiceæ¥å£ç»§æ‰¿Executoræ¥å£ï¼Œå¹¶å¢åŠ äº†submitã€shutdownã€invokeAllç­‰ç­‰ä¸€ç³»åˆ—æ–¹æ³•ã€‚
- AbstractExecutorServiceæŠ½è±¡ç±»å®ç°ExecutorServiceæ¥å£ï¼Œå¹¶ä¸”æä¾›äº†ä¸€äº›æ–¹æ³•çš„é»˜è®¤å®ç°ï¼Œä¾‹å¦‚submitæ–¹æ³•ã€invokeAnyæ–¹æ³•ã€invokeAllæ–¹æ³•ã€‚
åƒexecuteæ–¹æ³•ã€çº¿ç¨‹æ± çš„å…³é—­æ–¹æ³•ï¼ˆshutdownã€shutdownNowç­‰ç­‰ï¼‰å°±æ²¡æœ‰æä¾›é»˜è®¤çš„å®ç°ã€‚
- ThreadPoolExecutor ä¸€ä¸ªæœ€ä¸‹é¢çš„åº•å±‚å®ç°ï¼Œæˆ‘ä»¬å…·ä½“å°±æ¥çœ‹çœ‹å®ƒ


### åŸºæœ¬å±æ€§

```
    private final AtomicInteger ctl = new AtomicInteger(ctlOf(RUNNING, 0));
    private static final int COUNT_BITS = Integer.SIZE - 3;
    private static final int CAPACITY   = (1 << COUNT_BITS) - 1;
 
    // runState is stored in the high-order bits
    private static final int RUNNING    = -1 << COUNT_BITS;
    private static final int SHUTDOWN   =  0 << COUNT_BITS;
    private static final int STOP       =  1 << COUNT_BITS;
    private static final int TIDYING    =  2 << COUNT_BITS;
    private static final int TERMINATED =  3 << COUNT_BITS;
 
    // Packing and unpacking ctl
    private static int runStateOf(int c)     { return c & ~CAPACITY; }   // è·å–çº¿ç¨‹æ± è¿è¡ŒçŠ¶æ€
    private static int workerCountOf(int c)  { return c & CAPACITY; }    // è·å–çº¿ç¨‹æ•°é‡
    private static int ctlOf(int rs, int wc) { return rs | wc; }    

```
ctlæ˜¯çº¿ç¨‹æ± çš„æ§åˆ¶çŠ¶æ€ï¼Œæ˜¯AtomicIntegerç±»å‹çš„ï¼Œé‡Œé¢åŒ…å«ä¸¤éƒ¨åˆ†ï¼Œworkcount---çº¿ç¨‹çš„æ•°é‡ï¼ŒrunState---çº¿ç¨‹æ± çš„è¿è¡ŒçŠ¶æ€ã€‚è¿™é‡Œé™åˆ¶äº†æœ€å¤§çº¿ç¨‹æ•°æ˜¯2^29-1ï¼Œå¤§çº¦500ç™¾ä¸‡ä¸ªçº¿ç¨‹ï¼Œè¿™ä¹Ÿæ˜¯ä¸ªé—®é¢˜ï¼Œæ‰€ä»¥ctlä¹Ÿå¯ä»¥å˜æˆAtomicLongç±»å‹çš„ã€‚

çº¿ç¨‹æ± çš„äº”ç§çŠ¶æ€ï¼š

- RUNNING - æ¥å—æ–°ä»»åŠ¡å¹¶ä¸”ç»§ç»­å¤„ç†é˜»å¡é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡
- SHUTDOWN - ä¸æ¥å—æ–°ä»»åŠ¡ä½†æ˜¯ä¼šç»§ç»­å¤„ç†é˜»å¡é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡
- STOP -Â  ä¸æ¥å—æ–°ä»»åŠ¡ï¼Œä¸åœ¨æ‰§è¡Œé˜»å¡é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ï¼Œä¸­æ–­æ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡
- TIDYING - æ‰€æœ‰ä»»åŠ¡éƒ½å·²ç»å®Œæˆï¼Œçº¿ç¨‹æ•°éƒ½è¢«å›æ”¶ï¼Œçº¿ç¨‹ä¼šè½¬åˆ°TIDYINGçŠ¶æ€ä¼šç»§ç»­æ‰§è¡Œé’©å­æ–¹æ³•
- TERMINATED - é’©å­æ–¹æ³•æ‰§è¡Œå®Œæ¯•

çº¿ç¨‹ä¹‹é—´çš„è½¬æ¢ï¼š

- RUNNING -> SHUTDOWN
    -    æ˜¾å¼è°ƒç”¨shutdown()æ–¹æ³•, æˆ–è€…éšå¼è°ƒç”¨äº†finalize()æ–¹æ³•
- (RUNNING or SHUTDOWN) -> STOP
    -    æ˜¾å¼è°ƒç”¨shutdownNow()æ–¹æ³•
- SHUTDOWN -> TIDYING
    -    å½“çº¿ç¨‹æ± å’Œä»»åŠ¡é˜Ÿåˆ—éƒ½ä¸ºç©ºçš„æ—¶å€™
- STOP -> TIDYING
    -    å½“çº¿ç¨‹æ± ä¸ºç©ºçš„æ—¶å€™
- TIDYING -> TERMINATED
    -    å½“ terminated() hook æ–¹æ³•æ‰§è¡Œå®Œæˆæ—¶å€™
### æ„é€ å‡½æ•°

![](https://user-gold-cdn.xitu.io/2019/12/24/16f36a4daba686f0?w=1211&h=238&f=png&s=61269)
4ä¸ªæ„é€ å‡½æ•°ï¼Œæœ€åéƒ½æ˜¯è°ƒç”¨ä¸€ä¸ªæ–¹æ³•

```
public ThreadPoolExecutor(int corePoolSize,
                          int maximumPoolSize,
                          long keepAliveTime,
                          TimeUnit unit,
                          BlockingQueue<Runnable> workQueue,
                          ThreadFactory threadFactory,
                          RejectedExecutionHandler handler) {
}
```
å‚æ•°ä»‹ç»


|å‚æ•°|ç±»å‹|å«ä¹‰|
|:-:|:-:|:-:|
|corePoolSize|	int|	æ ¸å¿ƒçº¿ç¨‹æ•°
|maximumPoolSize |int|	æœ€å¤§çº¿ç¨‹æ•°
|keepAliveTime	|long|	å­˜æ´»æ—¶é—´
|unit|	TimeUnit|	æ—¶é—´å•ä½|
|workQueue|	BlockingQueue|	å­˜æ”¾çº¿ç¨‹çš„é˜Ÿåˆ—|
|threadFactory|	ThreadFactory|	åˆ›å»ºçº¿ç¨‹çš„å·¥å‚|
|handler|RejectedExecutionHandler|	å¤šä½™çš„çš„çº¿ç¨‹å¤„ç†å™¨ï¼ˆæ‹’ç»ç­–ç•¥ï¼‰|

- corePoolSizeï¼šæ ¸å¿ƒçº¿ç¨‹æ•°ï¼Œå³æœ€å°çš„keep aliveçº¿ç¨‹æ•°ï¼Œå¦‚æœallowCoreThreadTimeOutè®¾ç½®ä¸ºtrueï¼Œåˆ™è¯¥å‚æ•°æ— æ•ˆï¼Œå³ä¸º0ï¼›
- maximumPoolSizeï¼šæœ€å¤§çº¿ç¨‹æ•°ï¼Œå³å®šä¹‰äº†çº¿ç¨‹æ± çš„æœ€å¤§çº¿ç¨‹æ•°ï¼ˆå®é™…æœ€å¤§å€¼ä¸èƒ½è¶…è¿‡CAPACITYï¼‰ï¼›
- keepAliveTimeï¼šç©ºé—²æ—¶é—´ï¼Œå³çº¿ç¨‹çš„æœ€å¤§ç©ºé—²æ—¶é—´ï¼Œé»˜è®¤æƒ…å†µæ˜¯å½“çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ•°è¶…è¿‡corePoolSizeæ—¶ï¼Œçº¿ç¨‹çš„æœ€å¤§ç©ºé—²æ—¶é—´ï¼ŒåŠçº¿ç¨‹æ•°å°äºcorePoolSizeæ—¶ä¸ç”Ÿæ•ˆï¼Œé™¤éallowCoreThreadTimeOutè®¾ç½®ä¸ºtrueï¼›
- workQueueï¼šä»»åŠ¡é˜Ÿåˆ—ï¼Œä¸ºé˜»å¡é˜Ÿåˆ—ï¼Œä¿å­˜éœ€è¦æ‰§è¡Œçš„ä»»åŠ¡ã€‚
- threadFactoryï¼š åˆ›å»ºçº¿ç¨‹çš„å·¥å‚ç±»ã€‚
- handlerï¼š å½“queueæ»¡äº†å’Œçº¿ç¨‹æ•°è¾¾åˆ°æœ€å¤§é™åˆ¶ï¼Œå¯¹äºç»§ç»­åˆ°è¾¾çš„ä»»åŠ¡é‡‡å–çš„ç­–ç•¥ã€‚é»˜è®¤é‡‡å–AbortPolicy ï¼Œ                              ä¹Ÿå°±æ˜¯æ‹’ç»ç­–ç•¥ã€‚

### æ‹’ç»ç­–ç•¥
 1.  AbortPolicy


```

     /**
     *  é»˜è®¤çš„æ‹’ç»ç­–ç•¥,å½“ç»§ç»­æœ‰ä»»åŠ¡åˆ°æ¥æ—¶ç›´æ¥æŠ›å‡ºå¼‚å¸¸
     */
    public static class AbortPolicy implements RejectedExecutionHandler {
      
        public AbortPolicy() { }
 
        public void rejectedExecution(Runnable r, ThreadPoolExecutor e) {
            throw new RejectedExecutionException("Task " + r.toString() +
                                                 " rejected from " +
                                                 e.toString());
        }
    }

```
 2.  DiscardPolicyï¼šrejectedexecutionæ˜¯ä¸ªç©ºæ–¹æ³•ï¼Œæ„å‘³ç€ç›´æ¥æŠ›å¼ƒè¯¥ä»»åŠ¡ï¼Œä¸å¤„ç†ã€‚
 
```
 public static class DiscardPolicy implements RejectedExecutionHandler {
       
        public DiscardPolicy() { }
 
        public void rejectedExecution(Runnable r, ThreadPoolExecutor e) {
        }
    
```
 3.  DiscardOldestPolicyï¼šæŠ›å¼ƒqueueä¸­çš„ç¬¬ä¸€ä¸ªä»»åŠ¡ï¼Œå†æ¬¡æ‰§è¡Œè¯¥ä»»åŠ¡ã€‚
 
```
public static class DiscardOldestPolicy implements RejectedExecutionHandler {
        
        public DiscardOldestPolicy() { }
 
        public void rejectedExecution(Runnable r, ThreadPoolExecutor e) {
            if (!e.isShutdown()) {
                e.getQueue().poll();
                e.execute(r);
            }
        }
    }

```
 4. CallerRunsPolicyï¼š ç›´æ¥ç”±æ‰§è¡Œè¯¥æ–¹æ³•çš„çº¿ç¨‹ç»§ç»­æ‰§è¡Œè¯¥ä»»åŠ¡ï¼Œé™¤éè°ƒç”¨äº†shutdownæ–¹æ³•ï¼Œè¿™ä¸ªä»»åŠ¡æ‰ä¼šè¢«ä¸¢å¼ƒï¼Œå¦åˆ™ç»§ç»­æ‰§è¡Œè¯¥ä»»åŠ¡ä¼šå‘ç”Ÿé˜»å¡ã€‚
 
```
 public static class CallerRunsPolicy implements RejectedExecutionHandler {
       
        public CallerRunsPolicy() { }
 
        public void rejectedExecution(Runnable r, ThreadPoolExecutor e) {
            if (!e.isShutdown()) {
                r.run();
            }
        }
    }

```


### workQueue
ç”¨äºä¿å­˜ç­‰å¾…æ‰§è¡Œçš„ä»»åŠ¡çš„é˜»å¡é˜Ÿåˆ—ã€‚
å¯ä»¥é€‰æ‹©ä»¥ä¸‹å‡ ä¸ªé˜»å¡é˜Ÿåˆ—ï¼š
- rrayBlockingQueueï¼šæ˜¯ä¸€ä¸ªåŸºäºæ•°ç»„ç»“æ„çš„æœ‰ç•Œé˜»å¡é˜Ÿåˆ—ï¼Œæ­¤é˜Ÿåˆ—æŒ‰FIFOï¼ˆå…ˆè¿›å…ˆå‡ºï¼‰åŸåˆ™å¯¹å…ƒç´ è¿›è¡Œæ’åºã€‚
- LinkedBlockingQueueï¼šä¸€ä¸ªåŸºäºé“¾è¡¨ç»“æ„çš„é˜»å¡é˜Ÿåˆ—ï¼Œæ­¤é˜Ÿåˆ—æŒ‰FIFOæ’åºå…ƒç´ ï¼Œååé‡é€šå¸¸è¦é«˜äºArrayBlockingQueueã€‚é™æ€å·¥å‚- æ–¹æ³•Executors.newFixedThreadPool()ä½¿ç”¨äº†è¿™ä¸ªé˜Ÿåˆ—ã€‚
- SynchronousQueueï¼šä¸€ä¸ªä¸å­˜å‚¨å…ƒç´ çš„é˜»å¡é˜Ÿåˆ—ã€‚æ¯ä¸ªæ’å…¥æ“ä½œå¿…é¡»ç­‰åˆ°å¦ä¸€ä¸ªçº¿ç¨‹è°ƒç”¨ç§»é™¤æ“ä½œï¼Œå¦åˆ™æ’å…¥æ“ä½œä¸€ç›´å¤„äºé˜»å¡çŠ¶æ€- ï¼Œååé‡é€šå¸¸è¦é«˜äºLinkedBlockingQueueï¼Œé™æ€å·¥å‚æ–¹æ³•Executors.newCachedThreadPoolä½¿ç”¨äº†è¿™ä¸ªé˜Ÿåˆ—ã€‚
- PriorityBlockingQueueï¼šä¸€ä¸ªå…·æœ‰ä¼˜å…ˆçº§çš„æ— é™é˜»å¡é˜Ÿåˆ—ã€‚




### executeæ–¹æ³•

```
 public void execute(Runnable command) {
        if (command == null)
            throw new NullPointerException();
        /*
         *  3æ­¥æ“ä½œ
         *
         * 1. å¦‚æœå½“å‰è¿è¡Œçš„çº¿ç¨‹æ•°<æ ¸å¿ƒçº¿ç¨‹æ•°,åˆ›å»ºä¸€ä¸ªæ–°çš„çº¿ç¨‹æ‰§è¡Œä»»åŠ¡,è°ƒç”¨addWorkeræ–¹æ³•åŸå­æ€§åœ°æ£€æŸ¥
         *    è¿è¡ŒçŠ¶æ€å’Œçº¿ç¨‹æ•°,é€šè¿‡è¿”å›falseé˜²æ­¢ä¸éœ€è¦çš„æ—¶å€™æ·»åŠ çº¿ç¨‹
         * 2. å¦‚æœä¸€ä¸ªä»»åŠ¡èƒ½å¤ŸæˆåŠŸçš„å…¥é˜Ÿ,ä»ç„¶éœ€è¦åŒé‡æ£€æŸ¥,å› ä¸ºæˆ‘ä»¬æ·»åŠ äº†ä¸€ä¸ªçº¿ç¨‹(æœ‰å¯èƒ½è¿™ä¸ªçº¿ç¨‹åœ¨ä¸Šæ¬¡æ£€æŸ¥åå°±å·²ç»æ­»äº¡äº†)
         *    æˆ–è€…è¿›å…¥æ­¤æ–¹æ³•çš„æ—¶å€™è°ƒç”¨äº†shutdown,æ‰€ä»¥éœ€è¦é‡æ–°æ£€æŸ¥çº¿ç¨‹æ± çš„çŠ¶æ€,å¦‚æœå¿…è¦çš„è¯,å½“åœæ­¢çš„æ—¶å€™è¦å›æ»šå…¥é˜Ÿæ“ä½œ,
         *    æˆ–è€…å½“çº¿ç¨‹æ± ä¸ºç©ºçš„è¯åˆ›å»ºä¸€ä¸ªæ–°çš„çº¿ç¨‹
         * 3. å¦‚æœä¸èƒ½å…¥é˜Ÿ,å°è¯•ç€å¼€å¯ä¸€ä¸ªæ–°çš„çº¿ç¨‹,å¦‚æœå¼€å¯å¤±è´¥,è¯´æ˜çº¿ç¨‹æ± å·²ç»æ˜¯shutdownçŠ¶æ€æˆ–é¥±å’Œäº†,æ‰€ä»¥æ‹’ç»æ‰§è¡Œè¯¥ä»»åŠ¡
         */
        int c = ctl.get();
        if (workerCountOf(c) < corePoolSize) {
            if (addWorker(command, true))
                return;
            c = ctl.get();
        }
        if (isRunning(c) && workQueue.offer(command)) {
            int recheck = ctl.get();
            if (! isRunning(recheck) && remove(command))
                reject(command);
            else if (workerCountOf(recheck) == 0)
                addWorker(null, false);
        }
        else if (!addWorker(command, false))
            reject(command);
    }
```

1. æ£€æŸ¥å½“å‰çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ•°æ˜¯å¦<æ ¸å¿ƒçº¿ç¨‹æ•°ï¼Œå¦‚æœå°äºæ ¸å¿ƒçº¿ç¨‹æ•°ï¼Œå°±è°ƒç”¨addWorkeræ–¹æ³•åˆ›å»ºä¸€ä¸ªæ–°çš„çº¿ç¨‹æ‰§è¡Œä»»åŠ¡ï¼Œaddworkerä¸­çš„ç¬¬äºŒä¸ªå‚æ•°ä¼ å…¥trueï¼Œè¡¨ç¤ºå½“å‰åˆ›å»ºçš„æ˜¯æ ¸å¿ƒçº¿ç¨‹ã€‚å¦‚æœå½“å‰çº¿ç¨‹æ•°>=æ ¸å¿ƒçº¿ç¨‹æ•°æˆ–è€…åˆ›å»ºçº¿ç¨‹å¤±è´¥çš„è¯ï¼Œç›´æ¥è¿›å…¥ç¬¬äºŒç§æƒ…å†µã€‚

2. é€šè¿‡è°ƒç”¨isRunningæ–¹æ³•åˆ¤æ–­çº¿ç¨‹æ± æ˜¯å¦è¿˜åœ¨è¿è¡Œï¼Œå¦‚æœçº¿ç¨‹æ± çŠ¶æ€ä¸æ˜¯runningï¼Œé‚£å°±ç›´æ¥é€€å‡ºexecuteæ–¹æ³•ï¼Œæ²¡æœ‰æ‰§è¡Œçš„å¿…è¦äº†ï¼›å¦‚æœçº¿ç¨‹æ± çš„çŠ¶æ€æ˜¯runningï¼Œå°è¯•ç€æŠŠä»»åŠ¡åŠ å…¥åˆ°queueä¸­ï¼Œå†æ¬¡æ£€æŸ¥çº¿ç¨‹æ± çš„çŠ¶æ€ï¼Œ å¦‚æœå½“å‰ä¸æ˜¯runningï¼Œå¯èƒ½åœ¨å…¥é˜Ÿåè°ƒç”¨äº†shutdownæ–¹æ³•ï¼Œæ‰€ä»¥è¦åœ¨queueä¸­ç§»é™¤è¯¥ä»»åŠ¡ï¼Œé»˜è®¤é‡‡ç”¨æ‹’ç»ç­–ç•¥ç›´æ¥æŠ›å‡ºå¼‚å¸¸ã€‚å¦‚æœå½“å‰çº¿ç¨‹æ•°ä¸º0ï¼Œå¯èƒ½æŠŠallowCoreThreadTimeOutè®¾ä¸ºäº†trueï¼Œæ­£å¥½æ ¸å¿ƒçº¿ç¨‹å…¨éƒ¨è¢«å›æ”¶ï¼Œæ‰€ä»¥å¿…é¡»è¦åˆ›å»ºä¸€ä¸ªç©ºçš„çº¿ç¨‹ï¼Œè®©å®ƒè‡ªå·±å»queueä¸­å»å–ä»»åŠ¡æ‰§è¡Œã€‚

3. å¦‚æœå½“å‰çº¿ç¨‹æ•°>æ ¸å¿ƒçº¿ç¨‹æ•°ï¼Œå¹¶ä¸”å…¥é˜Ÿå¤±è´¥ï¼Œè°ƒç”¨addWorkeræ–¹æ³•åˆ›å»ºä¸€ä¸ªæ–°çš„çº¿ç¨‹å»æ‰§è¡Œä»»åŠ¡ï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯falseï¼Œè¡¨ç¤ºå½“å‰åˆ›å»ºçš„çº¿ç¨‹ä¸æ˜¯æ ¸å¿ƒçº¿ç¨‹ã€‚è¿™ç§æƒ…å†µè¡¨ç¤ºæ ¸å¿ƒçº¿ç¨‹å·²æ»¡å¹¶ä¸”queueå·²æ»¡ï¼Œå¦‚æœå½“å‰çº¿ç¨‹æ•°å°äºæœ€å¤§çº¿ç¨‹æ•°ï¼Œåˆ›å»ºçº¿ç¨‹æ‰§è¡Œä»»åŠ¡ã€‚å¦‚æœå½“å‰çº¿ç¨‹æ•°>=æœ€å¤§çº¿ç¨‹æ•°ï¼Œé»˜è®¤ç›´æ¥é‡‡å–æ‹’ç»ç­–ç•¥ã€‚

### addWorkeræ–¹æ³•

çœ‹ä¸€ä¸‹addWorkeræ˜¯æ€ä¹ˆå…·ä½“æ‰§è¡Œçš„ã€‚ä»£ç æœ‰ç‚¹é•¿ï¼Œæ…¢æ…¢çœ‹ã€‚


```
 private boolean addWorker(Runnable firstTask, boolean core) {
        retry:
        for (;;) {
            int c = ctl.get();
            int rs = runStateOf(c);
 
            // Check if queue empty only if necessary.
            if (rs >= SHUTDOWN &&
                ! (rs == SHUTDOWN &&
                   firstTask == null &&
                   ! workQueue.isEmpty()))
                return false;
 
            for (;;) {
                int wc = workerCountOf(c);
                if (wc >= CAPACITY ||
                    wc >= (core ? corePoolSize : maximumPoolSize))
                    return false;
                if (compareAndIncrementWorkerCount(c))
                    break retry;
                c = ctl.get();  // Re-read ctl
                if (runStateOf(c) != rs)
                    continue retry;
                // else CAS failed due to workerCount change; retry inner loop
            }
        }
 
        boolean workerStarted = false;
        boolean workerAdded = false;
        Worker w = null;
        try {
            w = new Worker(firstTask);
            final Thread t = w.thread;
            if (t != null) {
                final ReentrantLock mainLock = this.mainLock;
                mainLock.lock();
                try {
                    // Recheck while holding lock.
                    // Back out on ThreadFactory failure or if
                    // shut down before lock acquired.
                    int rs = runStateOf(ctl.get());
 
                    if (rs < SHUTDOWN ||
                        (rs == SHUTDOWN && firstTask == null)) {
                        if (t.isAlive()) // precheck that t is startable
                            throw new IllegalThreadStateException();
                        workers.add(w);
                        int s = workers.size();
                        if (s > largestPoolSize)
                            largestPoolSize = s;
                        workerAdded = true;
                    }
                } finally {
                    mainLock.unlock();
                }
                if (workerAdded) {
                    t.start();
                    workerStarted = true;
                }
            }
        } finally {
            if (! workerStarted)
                addWorkerFailed(w);
        }
        return workerStarted;
    }
```
é¦–å…ˆåˆ¤æ–­çº¿ç¨‹æ± çš„runstateï¼Œå¦‚æœrunstateä¸ºshutdownï¼Œé‚£ä¹ˆå¹¶ä¸èƒ½æ»¡è¶³ç¬¬äºŒä¸ªæ¡ä»¶ï¼Œrunstate != shutdownï¼Œæ‰€ä»¥è¿™æ˜¯é’ˆå¯¹runstateä¸æ˜¯runningï¼Œshutdownçš„æƒ…å†µï¼Œå½“runstate>shutdownæ—¶ï¼Œé˜Ÿåˆ—ä¸ºç©ºï¼Œæ­¤æ—¶ä»ç„¶æœ‰ä»»åŠ¡çš„è¯ï¼Œç›´æ¥è¿”å›falseï¼Œçº¿ç¨‹æ± å·²å…³é—­ï¼Œå¹¶ä¸èƒ½åœ¨ç»§ç»­æ‰§è¡Œä»»åŠ¡äº†ã€‚

ç¬¬äºŒä¸ªè‡ªæ—‹æ“ä½œå°±çš„ç›®çš„å°±æ˜¯å¯¹çº¿ç¨‹æ•°é‡è‡ªå¢ï¼Œç”±äºæ¶‰åŠåˆ°é«˜å¹¶å‘ï¼Œæ‰€ä»¥é‡‡ç”¨äº†casæ¥æ§åˆ¶ï¼Œåˆ¤æ–­çº¿ç¨‹çš„workcount>=CAPACITYï¼Œé‚£ä¹ˆç›´æ¥è¿”å›falseï¼Œæˆ–è€…é€šè¿‡åˆ¤æ–­æ˜¯å¦æ ¸å¿ƒçº¿ç¨‹ï¼Œå¦‚æœæ˜¯trueï¼Œåˆ¤æ–­workcount>=æ ¸å¿ƒçº¿ç¨‹æ•°ï¼Œå¦‚æœæ˜¯falseï¼Œåˆ¤æ–­workcount>=æœ€å¤§çº¿ç¨‹æ•°ï¼Œç›´æ¥è¿”å›falseã€‚å¦‚æœä¸æ»¡è¶³ä¸Šä¸ªæ¡ä»¶ï¼Œç›´æ¥ä½¿ç”¨casæŠŠçº¿ç¨‹æ•°è‡ªå¢ï¼Œé€€å‡ºè‡ªæ—‹æ“ä½œã€‚

workerå¯¹è±¡ã€‚

```
  Worker(Runnable firstTask) {
            setState(-1); // inhibit interrupts until runWorker
            this.firstTask = firstTask;
            this.thread = getThreadFactory().newThread(this);
        }
```

åœ¨å½“å‰çº¿ç¨‹ä¸ä¸ºç©ºçš„æƒ…å†µä¸‹ï¼ŒåŠ ä¸€æŠŠå¯é‡å…¥é”reentrantlockï¼Œåœ¨åŠ é”åï¼Œå†æ¬¡æ£€æŸ¥çº¿ç¨‹æ± çš„çŠ¶æ€runstateï¼Œé˜²æ­¢åœ¨è·å–åˆ°é”ä¹‹å‰çº¿ç¨‹æ± å·²ç»å…³é—­äº†ï¼Œçº¿ç¨‹æ± çš„çŠ¶æ€ä¸ºrunningæˆ–è€…çŠ¶æ€ä¸ºshutdownå¹¶ä¸”ä»»åŠ¡ä¸ºç©ºçš„æƒ…å†µä¸‹ï¼Œæ‰èƒ½ç»§ç»­å¾€ä¸‹æ‰§è¡Œä»»åŠ¡ï¼Œè¿™æ˜¯å……åˆ†å¿…è¦æ¡ä»¶ã€‚å¦‚æœå½“å‰çº¿ç¨‹å·²ç»å¼€å¯äº†ï¼Œç›´æ¥æŠ›å‡ºå¼‚å¸¸ï¼Œè¿™æ˜¯ç»ä¸å…è®¸çš„ã€‚

 private final HashSet<Worker> workers = new HashSet<Worker>();
 
 
 ### addWorkerFailedæ–¹æ³•
å¦‚æœæ·»åŠ workerå¤±è´¥æˆ–è€…å¼€å¯çº¿ç¨‹å¤±è´¥å°±è¦è°ƒç”¨addWorkerFailedæ–¹æ³•ç§»é™¤å¤±è´¥çš„workerã€‚


```
   private void addWorkerFailed(Worker w) {
        final ReentrantLock mainLock = this.mainLock;
        mainLock.lock();
        try {
            if (w != null)
                workers.remove(w);
            decrementWorkerCount();
            tryTerminate();
        } finally {
            mainLock.unlock();
        }
    }

```
é¦–å…ˆè¿˜æ˜¯è·å–å…¨å±€é”mainlockï¼Œæ¥ç€å¯¹workersé›†åˆä¸­ç§»é™¤workerï¼Œworkersçš„æ•°é‡è‡ªå‡ã€‚

### runWorkeræ–¹æ³•
è¿™ä¸ªæ–¹æ³•æ˜¯è¿è¡Œtaskçš„æ–¹æ³•

```
 final void runWorker(Worker w) {
        Thread wt = Thread.currentThread();
        Runnable task = w.firstTask;
        w.firstTask = null;
        w.unlock(); // allow interrupts
        boolean completedAbruptly = true;
        try {
            while (task != null || (task = getTask()) != null) {
                w.lock();
                
                if ((runStateAtLeast(ctl.get(), STOP) ||
                     (Thread.interrupted() &&
                      runStateAtLeast(ctl.get(), STOP))) &&
                    !wt.isInterrupted())
                    wt.interrupt();
                try {
                    beforeExecute(wt, task);
                    Throwable thrown = null;
                    try {
                        task.run();
                    } catch (RuntimeException x) {
                        thrown = x; throw x;
                    } catch (Error x) {
                        thrown = x; throw x;
                    } catch (Throwable x) {
                        thrown = x; throw new Error(x);
                    } finally {
                        afterExecute(task, thrown);
                    }
                } finally {
                    task = null;
                    w.completedTasks++;
                    w.unlock();
                }
            }
            completedAbruptly = false;
        } finally {
            processWorkerExit(w, completedAbruptly);
        }
    }

```

é¦–å…ˆè¿˜æ˜¯è·å–å½“å‰çº¿ç¨‹ï¼Œè·å–å½“å‰workerå¯¹è±¡ä¸­çš„ä»»åŠ¡taskï¼ŒæŠŠå½“å‰çº¿ç¨‹çš„çŠ¶æ€ç”±-1è®¾ä¸º0ï¼Œè¡¨ç¤ºå¯ä»¥è·å–é”æ‰§è¡Œä»»åŠ¡ï¼Œæ¥ä¸‹æ¥å°±æ˜¯ä¸€ä¸ªwhileå¾ªç¯ï¼Œå½“taskä¸ä¸ºç©ºæˆ–è€…ä»gettaskæ–¹æ³•å–å‡ºçš„ä»»åŠ¡ä¸ä¸ºç©ºçš„æ—¶å€™ï¼ŒåŠ é”ï¼Œåº•å±‚è¿˜æ˜¯ä½¿ç”¨äº†AQSï¼Œä¿è¯äº†åªæœ‰ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œå®Œæ¯•å…¶ä»–çº¿ç¨‹æ‰èƒ½æ‰§è¡Œã€‚åœ¨æ‰§è¡Œä»»åŠ¡ä¹‹å‰ï¼Œå¿…é¡»è¿›è¡Œåˆ¤æ–­ï¼Œçº¿ç¨‹æ± çš„çŠ¶æ€å¦‚æœ>=STOPï¼Œå¿…é¡»ä¸­æ–­å½“å‰çº¿ç¨‹ï¼Œå¦‚æœæ˜¯runningæˆ–è€…shutdownï¼Œå½“å‰çº¿ç¨‹ä¸èƒ½è¢«ä¸­æ–­ï¼Œé˜²æ­¢çº¿ç¨‹æ± è°ƒç”¨äº†shutdownnowæ–¹æ³•å¿…é¡»ä¸­æ–­æ‰€æœ‰çš„çº¿ç¨‹ã€‚

åœ¨å¤„ç†ä»»åŠ¡ä¹‹å‰ï¼Œä¼šæ‰§è¡ŒbeforeExecuteæ–¹æ³•ï¼Œ åœ¨å¤„ç†ä»»åŠ¡ä¹‹åï¼Œæ‰§è¡ŒafterExecuteæ–¹æ³•ï¼Œè¿™ä¸¤ä¸ªéƒ½æ˜¯é’©å­æ–¹æ³•ï¼Œç»§æ‰¿äº†ThreadPoolExecutorå¯ä»¥é‡å†™æ­¤æ–¹æ³•ï¼ŒåµŒå…¥è‡ªå®šä¹‰çš„é€»è¾‘ã€‚ä¸€æ—¦åœ¨ä»»åŠ¡è¿è¡Œçš„è¿‡ç¨‹ä¸­ï¼Œå‡ºç°å¼‚å¸¸ä¼šç›´æ¥æŠ›å‡ºï¼Œæ‰€ä»¥åœ¨å®é™…çš„ä¸šåŠ¡ä¸­ï¼Œåº”è¯¥ä½¿ç”¨try..catchï¼ŒæŠŠè¿™äº›æ—¥å¸¸åŠ å…¥åˆ°æ—¥å¿—ä¸­ã€‚

ä»»åŠ¡æ‰§è¡Œå®Œï¼Œå°±æŠŠtaskè®¾ä¸ºç©ºï¼Œç´¯åŠ å½“å‰çº¿ç¨‹å®Œæˆçš„ä»»åŠ¡æ•°ï¼Œunlockï¼Œç»§ç»­ä»queueä¸­å–ä»»åŠ¡æ‰§è¡Œã€‚

### getTaskæ–¹æ³•ã€‚

```
  private Runnable getTask() {
        boolean timedOut = false; // Did the last poll() time out?

        for (;;) {
            int c = ctl.get();
            int rs = runStateOf(c);

            // Check if queue empty only if necessary.
            if (rs >= SHUTDOWN && (rs >= STOP || workQueue.isEmpty())) {
                decrementWorkerCount();
                return null;
            }

            int wc = workerCountOf(c);

            // Are workers subject to culling?
            boolean timed = allowCoreThreadTimeOut || wc > corePoolSize;

            if ((wc > maximumPoolSize || (timed && timedOut))
                && (wc > 1 || workQueue.isEmpty())) {
                if (compareAndDecrementWorkerCount(c))
                    return null;
                continue;
            }

            try {
                Runnable r = timed ?
                    workQueue.poll(keepAliveTime, TimeUnit.NANOSECONDS) :
                    workQueue.take();
                if (r != null)
                    return r;
                timedOut = true;
            } catch (InterruptedException retry) {
                timedOut = false;
            }
        }
    }

```

è¿™ä¸ªæœ‰ç‚¹å¤æ‚ï¼Œå…¶å®ç›®çš„å°±æ˜¯è·å¾—ä¸€ä¸ªè¦è¿è¡Œçš„ä»»åŠ¡ï¼Œä¸è¿‡äººå®¶çš„åˆ¤æ–­è¿˜æ˜¯æ¯”è¾ƒå¤šçš„

### shutdownæ–¹æ³•

```
public void shutdown() {
        final ReentrantLock mainLock = this.mainLock;
        mainLock.lock();
        try {
            checkShutdownAccess();
            advanceRunState(SHUTDOWN);
            interruptIdleWorkers();
            onShutdown(); // hook for ScheduledThreadPoolExecutor
        } finally {
            mainLock.unlock();
        }
        tryTerminate();
    }
```
è°ƒç”¨äº†shutdownï¼Œæ„å‘³ç€ä¸èƒ½åœ¨ç»§ç»­å¾€queueä¸­æ·»åŠ ä»»åŠ¡ï¼Œä¹Ÿä¸èƒ½åœ¨æ¥å—æ–°çš„ä»»åŠ¡ã€‚åˆ©ç”¨casæŠŠå½“å‰çº¿ç¨‹æ± çš„çŠ¶æ€è®¾ä¸ºshutdownï¼Œä¸­æ–­æ‰€æœ‰çš„ç©ºé—²çº¿ç¨‹ï¼ŒonShutdownæ˜¯ä¸€ä¸ªé’©å­æ–¹æ³•ï¼Œæ˜¯ä¸“é—¨ç»™ScheduledThreadPoolExecutoræ¥å®ç°çš„ï¼Œå†æ¬¡è°ƒç”¨tryTerminateæ–¹æ³•æ¥å°è¯•ä¸­æ­¢çº¿ç¨‹æ± ï¼Œç›´åˆ°queueä¸­çš„ä»»åŠ¡å…¨éƒ¨å¤„ç†å®Œæ¯•æ‰èƒ½æ­£å¸¸å…³é—­ã€‚

![](https://user-gold-cdn.xitu.io/2019/12/24/16f36fb8bb3d6a0f?w=737&h=688&f=png&s=23714)

æä¸€ä¸‹ï¼Œé»˜è®¤çš„ å­˜ä»»åŠ¡çš„é˜Ÿåˆ—æ˜¯BlockingQueue

## ç»“å°¾
å› ä¸ºå¾ˆå¤šä¸œè¥¿ï¼Œå…¨æ˜¯ä»ä¹¦ä¸Šæ‹·è´çš„ï¼Œå¾ˆæ¯ç‡¥ï¼Œä½†åŒæ—¶çœ‹ä¹¦ï¼Œåˆæ˜¯æœ€è¯¦ç»†çš„å­¦ä¹ æ–¹æ³•ä¹‹ä¸€äº†ï¼Œå¤§å®¶è·Ÿç€ä¹¦çœ‹åšå®¢ï¼Œæˆ–è®¸ä¼šå¥½ç‚¹å§.æœ€åä¸€èŠ‚ä¸å†™äº†ï¼Œå°±æ˜¯å·¥å‚æ–¹æ³•é‡Œé¢çš„å‡ ç§çº¿ç¨‹æ± ï¼Œæˆ‘ä»¬ä¸€èˆ¬ä¹Ÿæ˜¯è‡ªå®šä¹‰çº¿ç¨‹æ± æ¥æ“ä½œçš„ã€‚


> å› ä¸ºåšä¸»ä¹Ÿæ˜¯ä¸€ä¸ªå¼€å‘èŒæ–° æˆ‘ä¹Ÿæ˜¯ä¸€è¾¹å­¦ä¸€è¾¹å†™ æˆ‘æœ‰ä¸ªç›®æ ‡å°±æ˜¯ä¸€å‘¨ äºŒåˆ°ä¸‰ç¯‡ å¸Œæœ›èƒ½åšæŒä¸ªä¸€å¹´å§ å¸Œæœ›å„ä½å¤§ä½¬å¤šææ„è§ï¼Œè®©æˆ‘å¤šå­¦ä¹ ï¼Œä¸€èµ·è¿›æ­¥ã€‚
## æ—¥å¸¸æ±‚èµ
> å¥½äº†å„ä½ï¼Œä»¥ä¸Šå°±æ˜¯è¿™ç¯‡æ–‡ç« çš„å…¨éƒ¨å†…å®¹äº†ï¼Œèƒ½çœ‹åˆ°è¿™é‡Œçš„äººå‘€ï¼Œéƒ½æ˜¯**çœŸç²‰**ã€‚

> åˆ›ä½œä¸æ˜“ï¼Œå„ä½çš„æ”¯æŒå’Œè®¤å¯ï¼Œå°±æ˜¯æˆ‘åˆ›ä½œçš„æœ€å¤§åŠ¨åŠ›ï¼Œæˆ‘ä»¬ä¸‹ç¯‡æ–‡ç« è§

>å…­è„‰ç¥å‰‘ | æ–‡ ã€åŸåˆ›ã€‘å¦‚æœæœ¬ç¯‡åšå®¢æœ‰ä»»ä½•é”™è¯¯ï¼Œè¯·æ‰¹è¯„æŒ‡æ•™ï¼Œä¸èƒœæ„Ÿæ¿€ ï¼

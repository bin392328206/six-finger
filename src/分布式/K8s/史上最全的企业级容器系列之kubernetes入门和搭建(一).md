# å‰è¨€
>æ–‡æœ¬å·²æ”¶å½•è‡³æˆ‘çš„GitHubä»“åº“ï¼Œæ¬¢è¿Starï¼šhttps://github.com/bin392328206/six-finger                             
> **ç§ä¸€æ£µæ ‘æœ€å¥½çš„æ—¶é—´æ˜¯åå¹´å‰ï¼Œå…¶æ¬¡æ˜¯ç°åœ¨**   
>æˆ‘çŸ¥é“å¾ˆå¤šäººä¸ç©**qq**äº†,ä½†æ˜¯æ€€æ—§ä¸€ä¸‹,æ¬¢è¿åŠ å…¥å…­è„‰ç¥å‰‘Javaèœé¸Ÿå­¦ä¹ ç¾¤ï¼Œç¾¤èŠå·ç ï¼š**549684836** é¼“åŠ±å¤§å®¶åœ¨æŠ€æœ¯çš„è·¯ä¸Šå†™åšå®¢
## çµ®å¨
æœ¬æ¥æƒ³ç€ç›´æ¥ç”¨Rancherç›´æ¥æK8sçš„ï¼Œä½†æ˜¯æˆ‘æƒ³ç€å› ä¸ºæ˜¯å­¦ä¹ è¿˜æ˜¯æœ‰ä¸€ä¸ªå­¦ä¹ è¿‡ç¨‹ï¼Œå°±æƒ³ç€èµ°ä¸€å¥—å®˜æ–¹çš„ä¸€ä¸ªæ­å»ºè¿‡ç¨‹ï¼Œå¹¶ä¸”ç†Ÿæ‚‰ä¸€ä¸‹äººå®¶çš„è®¾è®¡æ€æƒ³ã€‚

- [ğŸ”¥å²ä¸Šæœ€å…¨çš„ä¼ä¸šçº§å®¹å™¨ç³»åˆ—ä¹‹Rancher](https://juejin.im/post/5e1066116fb9a048076076b0)

## Kubernetesæ˜¯ä»€ä¹ˆï¼Ÿ
Kubernetesæ˜¯å®¹å™¨é›†ç¾¤ç®¡ç†ç³»ç»Ÿï¼Œæ˜¯ä¸€ä¸ªå¼€æºçš„å¹³å°ï¼Œå¯ä»¥å®ç°å®¹å™¨é›†ç¾¤çš„è‡ªåŠ¨åŒ–éƒ¨ç½²ã€è‡ªåŠ¨æ‰©ç¼©å®¹ã€ç»´æŠ¤ç­‰åŠŸèƒ½ã€‚
é€šè¿‡Kubernetesä½ å¯ä»¥ï¼š
- å¿«é€Ÿéƒ¨ç½²åº”ç”¨
- å¿«é€Ÿæ‰©å±•åº”ç”¨
- æ— ç¼å¯¹æ¥æ–°çš„åº”ç”¨åŠŸèƒ½
- èŠ‚çœèµ„æºï¼Œä¼˜åŒ–ç¡¬ä»¶èµ„æºçš„ä½¿ç”¨
## Kubernetes ç‰¹ç‚¹
- å¯ç§»æ¤: æ”¯æŒå…¬æœ‰äº‘ï¼Œç§æœ‰äº‘ï¼Œæ··åˆäº‘ï¼Œå¤šé‡äº‘ï¼ˆmulti-cloudï¼‰
- å¯æ‰©å±•: æ¨¡å—åŒ–, æ’ä»¶åŒ–, å¯æŒ‚è½½, å¯ç»„åˆ
- è‡ªåŠ¨åŒ–: è‡ªåŠ¨éƒ¨ç½²ï¼Œè‡ªåŠ¨é‡å¯ï¼Œè‡ªåŠ¨å¤åˆ¶ï¼Œè‡ªåŠ¨ä¼¸ç¼©/æ‰©å±•
## ä½¿ç”¨Kubernetesèƒ½åšä»€ä¹ˆï¼Ÿ
- å¤šä¸ªè¿›ç¨‹ï¼ˆä½œä¸ºå®¹å™¨è¿è¡Œï¼‰ååŒå·¥ä½œã€‚ï¼ˆPodï¼‰
- å­˜å‚¨ç³»ç»ŸæŒ‚è½½
- Distributing secrets
- åº”ç”¨å¥åº·æ£€æµ‹
- åº”ç”¨å®ä¾‹çš„å¤åˆ¶
- Podè‡ªåŠ¨ä¼¸ç¼©/æ‰©å±•
- Naming and discovering
- è´Ÿè½½å‡è¡¡
- æ»šåŠ¨æ›´æ–°
- èµ„æºç›‘æ§
- æ—¥å¿—è®¿é—®
- è°ƒè¯•åº”ç”¨ç¨‹åº
- æä¾›è®¤è¯å’Œæˆæƒ
## Kubernetes ç»„ä»¶
K8sæ˜¯ç”±è®¸å¤šä¸ªçš„ç»„ä»¶ç»„æˆçš„ åˆ†ä¸ºMasterç»„ä»¶å’ŒèŠ‚ç‚¹ï¼ˆNodeï¼‰ç»„ä»¶

### Masterç»„ä»¶
Masterç»„ä»¶æä¾›é›†ç¾¤çš„ç®¡ç†æ§åˆ¶ä¸­å¿ƒã€‚
Masterç»„ä»¶å¯ä»¥åœ¨é›†ç¾¤ä¸­ä»»ä½•èŠ‚ç‚¹ä¸Šè¿è¡Œã€‚ä½†æ˜¯ä¸ºäº†ç®€å•èµ·è§ï¼Œé€šå¸¸åœ¨ä¸€å°VM/æœºå™¨ä¸Šå¯åŠ¨æ‰€æœ‰Masterç»„ä»¶ï¼Œå¹¶ä¸”ä¸ä¼šåœ¨æ­¤VM/æœºå™¨ä¸Šè¿è¡Œç”¨æˆ·å®¹å™¨ã€‚
#### kube-apiserver
kube-apiserverç”¨äºæš´éœ²Kubernetes APIã€‚ä»»ä½•çš„èµ„æºè¯·æ±‚/è°ƒç”¨æ“ä½œéƒ½æ˜¯é€šè¿‡kube-apiserveræä¾›çš„æ¥å£è¿›è¡Œã€‚è¯·å‚é˜…æ„å»ºé«˜å¯ç”¨ç¾¤é›†ã€‚
#### ETCD
etcdæ˜¯Kubernetesæä¾›é»˜è®¤çš„å­˜å‚¨ç³»ç»Ÿï¼Œä¿å­˜æ‰€æœ‰é›†ç¾¤æ•°æ®ï¼Œä½¿ç”¨æ—¶éœ€è¦ä¸ºetcdæ•°æ®æä¾›å¤‡ä»½è®¡åˆ’ã€‚
#### kube-controller-manager
kube-controller-managerè¿è¡Œç®¡ç†æ§åˆ¶å™¨ï¼Œå®ƒä»¬æ˜¯é›†ç¾¤ä¸­å¤„ç†å¸¸è§„ä»»åŠ¡çš„åå°çº¿ç¨‹ã€‚é€»è¾‘ä¸Šï¼Œæ¯ä¸ªæ§åˆ¶å™¨æ˜¯ä¸€ä¸ªå•ç‹¬çš„è¿›ç¨‹ï¼Œä½†ä¸ºäº†é™ä½å¤æ‚æ€§ï¼Œå®ƒä»¬éƒ½è¢«ç¼–è¯‘æˆå•ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶ï¼Œå¹¶åœ¨å•ä¸ªè¿›ç¨‹ä¸­è¿è¡Œã€‚
#### kube-scheduler
kube-scheduler ç›‘è§†æ–°åˆ›å»ºæ²¡æœ‰åˆ†é…åˆ°Nodeçš„Podï¼Œä¸ºPodé€‰æ‹©ä¸€ä¸ªNodeã€‚
### èŠ‚ç‚¹ï¼ˆNodeï¼‰ç»„ä»¶
èŠ‚ç‚¹ç»„ä»¶è¿è¡Œåœ¨Nodeï¼Œæä¾›Kubernetesè¿è¡Œæ—¶ç¯å¢ƒï¼Œä»¥åŠç»´æŠ¤Podã€‚
#### kubelet
kubeletæ˜¯ä¸»è¦çš„èŠ‚ç‚¹ä»£ç†ï¼Œå®ƒä¼šç›‘è§†å·²åˆ†é…ç»™èŠ‚ç‚¹çš„podï¼Œå…·ä½“åŠŸèƒ½ï¼š

- å®‰è£…Podæ‰€éœ€çš„volumeã€‚
- ä¸‹è½½Podçš„Secretsã€‚
- Podä¸­è¿è¡Œçš„ dockerï¼ˆæˆ–experimentallyï¼Œrktï¼‰å®¹å™¨ã€‚
- å®šæœŸæ‰§è¡Œå®¹å™¨å¥åº·æ£€æŸ¥ã€‚
- Reports the status of the pod back to the rest of the system, by creating a mirror pod if necessary.
- Reports the status of the node back to the rest of the system.
#### kube-proxy
kube-proxyé€šè¿‡åœ¨ä¸»æœºä¸Šç»´æŠ¤ç½‘ç»œè§„åˆ™å¹¶æ‰§è¡Œè¿æ¥è½¬å‘æ¥å®ç°KubernetesæœåŠ¡æŠ½è±¡ã€‚


## Kubernetes å®‰è£…å‰çš„å‡†å¤‡

### æ¦‚è¿°

æœ¬æ¬¡å®‰è£…é‡‡ç”¨ Ubuntu Server X64 16.04 LTS ç‰ˆæœ¬å®‰è£… kubernetes é›†ç¾¤ç¯å¢ƒï¼Œé›†ç¾¤èŠ‚ç‚¹ä¸º 1 ä¸» 2 ä»æ¨¡å¼ï¼Œæ­¤æ¬¡å¯¹è™šæ‹Ÿæœºä¼šæœ‰äº›åŸºæœ¬è¦æ±‚ï¼Œå¦‚ä¸‹ï¼š

- OSï¼šUbuntu Server X64 18.04 LTSï¼ˆ16.04 ç‰ˆæœ¬æ­¥éª¤ç›¸åŒï¼Œå†ä¹‹å‰åˆ™ä¸åŒï¼‰
- CPUï¼šæœ€ä½è¦æ±‚ï¼Œ1 CPU 2 æ ¸
- å†…å­˜ï¼šæœ€ä½è¦æ±‚ï¼Œ2GB
- ç£ç›˜ï¼šæœ€ä½è¦æ±‚ï¼Œ20GB

åˆ›å»ºä¸‰å°è™šæ‹Ÿæœºï¼Œåˆ†åˆ«å‘½åå¦‚ä¸‹ï¼š
- Ubuntu Server 18.04 X64 Kubernetes Master
- Ubuntu Server 18.04 X64 Kubernetes Slave1
- Ubuntu Server 18.04 X64 Kubernetes Slave2

å¯¹è™šæ‹Ÿæœºç³»ç»Ÿçš„é…ç½®ï¼š
- å…³é—­äº¤æ¢ç©ºé—´ï¼šsudo swapoff -a
- é¿å…å¼€æœºå¯åŠ¨äº¤æ¢ç©ºé—´ï¼šæ³¨é‡Š /etc/fstab ä¸­çš„ swap
- å…³é—­é˜²ç«å¢™ï¼šufw disable

### ä½¿ç”¨ APT å®‰è£… Docker

å®‰è£…

```
# æ›´æ–°è½¯ä»¶æº
sudo apt-get update
# å®‰è£…æ‰€éœ€ä¾èµ–
sudo apt-get -y install apt-transport-https ca-certificates curl software-properties-common
# å®‰è£… GPG è¯ä¹¦
curl -fsSL http://mirrors.aliyun.com/docker-ce/linux/ubuntu/gpg | sudo apt-key add -
# æ–°å¢è½¯ä»¶æºä¿¡æ¯
sudo add-apt-repository "deb [arch=amd64] http://mirrors.aliyun.com/docker-ce/linux/ubuntu $(lsb_release -cs) stable"
# å†æ¬¡æ›´æ–°è½¯ä»¶æº
sudo apt-get -y update
# å®‰è£… Docker CE ç‰ˆ
sudo apt-get -y install docker-ce
```
éªŒè¯

```
docker version
Client:
 Version:           18.09.6
 API version:       1.39
 Go version:        go1.10.8
 Git commit:        481bc77
 Built:             Sat May  4 02:35:57 2019
 OS/Arch:           linux/amd64
 Experimental:      false

Server: Docker Engine - Community
 Engine:
  Version:          18.09.6
  API version:      1.39 (minimum version 1.12)
  Go version:       go1.10.8
  Git commit:       481bc77
  Built:            Sat May  4 01:59:36 2019
  OS/Arch:          linux/amd64
  Experimental:     false
```

é…ç½®åŠ é€Ÿå™¨  
å¯¹äºä½¿ç”¨ systemd çš„ç³»ç»Ÿï¼Œè¯·åœ¨ /etc/docker/daemon.json ä¸­å†™å…¥å¦‚ä¸‹å†…å®¹ï¼ˆå¦‚æœæ–‡ä»¶ä¸å­˜åœ¨è¯·æ–°å»ºè¯¥æ–‡ä»¶ï¼‰

```
{
  "registry-mirrors": [
    "https://registry.docker-cn.com"
  ]
}
```

éªŒè¯åŠ é€Ÿå™¨æ˜¯å¦é…ç½®æˆåŠŸï¼š

```
sudo systemctl restart docker
docker info
...
# å‡ºç°å¦‚ä¸‹è¯­å¥å³è¡¨ç¤ºé…ç½®æˆåŠŸ
Registry Mirrors:
 https://registry.docker-cn.com/
...
```

ä¿®æ”¹ä¸»æœºå

åœ¨åŒä¸€å±€åŸŸç½‘ä¸­ä¸»æœºåä¸åº”è¯¥ç›¸åŒï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦åšä¿®æ”¹ï¼Œç›´æ¥ä¿®æ”¹ /etc/hostname é‡Œçš„åç§°å³å¯

```
vim  /etc/hostname  

#kubernetes-master                    
```

## å®‰è£… kubeadm
kubeadm æ˜¯ kubernetes çš„é›†ç¾¤å®‰è£…å·¥å…·ï¼Œèƒ½å¤Ÿå¿«é€Ÿå®‰è£… kubernetes é›†ç¾¤ã€‚

### é…ç½®è½¯ä»¶æº

```
# å®‰è£…ç³»ç»Ÿå·¥å…·
apt-get update && apt-get install -y apt-transport-https
# å®‰è£… GPG è¯ä¹¦
curl https://mirrors.aliyun.com/kubernetes/apt/doc/apt-key.gpg | apt-key add -
# å†™å…¥è½¯ä»¶æºï¼›æ³¨æ„ï¼šæˆ‘ä»¬ç”¨ç³»ç»Ÿä»£å·ä¸º bionicï¼Œä½†ç›®å‰é˜¿é‡Œäº‘ä¸æ”¯æŒï¼Œæ‰€ä»¥æ²¿ç”¨ 16.04 çš„ xenial
cat << EOF >/etc/apt/sources.list.d/kubernetes.list
> deb https://mirrors.aliyun.com/kubernetes/apt/ kubernetes-xenial main
> EOF
```

### å®‰è£… kubeadmï¼Œkubeletï¼Œkubectl


```
# å®‰è£…
apt-get update  
apt-get install -y kubelet kubeadm kubectl

# å®‰è£…è¿‡ç¨‹å¦‚ä¸‹ï¼Œæ³¨æ„ kubeadm çš„ç‰ˆæœ¬å·
Reading package lists... Done
Building dependency tree       
Reading state information... Done
The following additional packages will be installed:
  conntrack cri-tools kubernetes-cni socat
The following NEW packages will be installed:
  conntrack cri-tools kubeadm kubectl kubelet kubernetes-cni socat
0 upgraded, 7 newly installed, 0 to remove and 96 not upgraded.
Need to get 50.6 MB of archives.
After this operation, 290 MB of additional disk space will be used.
Get:1 http://mirrors.aliyun.com/ubuntu bionic/main amd64 conntrack amd64 1:1.4.4+snapshot20161117-6ubuntu2 [30.6 kB]
Get:2 http://mirrors.aliyun.com/ubuntu bionic/main amd64 socat amd64 1.7.3.2-2ubuntu2 [342 kB]
Get:3 https://mirrors.aliyun.com/kubernetes/apt kubernetes-xenial/main amd64 cri-tools amd64 1.12.0-00 [5,343 kB]
Get:4 https://mirrors.aliyun.com/kubernetes/apt kubernetes-xenial/main amd64 kubernetes-cni amd64 0.7.5-00 [6,473 kB]
Get:5 https://mirrors.aliyun.com/kubernetes/apt kubernetes-xenial/main amd64 kubelet amd64 1.14.1-00 [21.5 MB]
Get:6 https://mirrors.aliyun.com/kubernetes/apt kubernetes-xenial/main amd64 kubectl amd64 1.14.1-00 [8,806 kB]
Get:7 https://mirrors.aliyun.com/kubernetes/apt kubernetes-xenial/main amd64 kubeadm amd64 1.14.1-00 [8,150 kB]
Fetched 50.6 MB in 5s (9,912 kB/s) 
Selecting previously unselected package conntrack.
(Reading database ... 67205 files and directories currently installed.)
Preparing to unpack .../0-conntrack_1%3a1.4.4+snapshot20161117-6ubuntu2_amd64.deb ...
Unpacking conntrack (1:1.4.4+snapshot20161117-6ubuntu2) ...
Selecting previously unselected package cri-tools.
Preparing to unpack .../1-cri-tools_1.12.0-00_amd64.deb ...
Unpacking cri-tools (1.12.0-00) ...
Selecting previously unselected package kubernetes-cni.
Preparing to unpack .../2-kubernetes-cni_0.7.5-00_amd64.deb ...
Unpacking kubernetes-cni (0.7.5-00) ...
Selecting previously unselected package socat.
Preparing to unpack .../3-socat_1.7.3.2-2ubuntu2_amd64.deb ...
Unpacking socat (1.7.3.2-2ubuntu2) ...
Selecting previously unselected package kubelet.
Preparing to unpack .../4-kubelet_1.14.1-00_amd64.deb ...
Unpacking kubelet (1.14.1-00) ...
Selecting previously unselected package kubectl.
Preparing to unpack .../5-kubectl_1.14.1-00_amd64.deb ...
Unpacking kubectl (1.14.1-00) ...
Selecting previously unselected package kubeadm.
Preparing to unpack .../6-kubeadm_1.14.1-00_amd64.deb ...
Unpacking kubeadm (1.14.1-00) ...
Setting up conntrack (1:1.4.4+snapshot20161117-6ubuntu2) ...
Setting up kubernetes-cni (0.7.5-00) ...
Setting up cri-tools (1.12.0-00) ...
Setting up socat (1.7.3.2-2ubuntu2) ...
Setting up kubelet (1.14.1-00) ...
Created symlink /etc/systemd/system/multi-user.target.wants/kubelet.service â†’ /lib/systemd/system/kubelet.service.
Setting up kubectl (1.14.1-00) ...
Processing triggers for man-db (2.8.3-2ubuntu0.1) ...
# æ³¨æ„è¿™é‡Œçš„ç‰ˆæœ¬å·ï¼Œæˆ‘ä»¬ä½¿ç”¨çš„æ˜¯ kubernetes v1.14.1
Setting up kubeadm (1.14.1-00) ...

# è®¾ç½® kubelet è‡ªå¯åŠ¨ï¼Œå¹¶å¯åŠ¨ kubelet
systemctl enable kubelet && systemctl start kubelet
```

- kubeadmï¼šç”¨äºåˆå§‹åŒ– Kubernetes é›†ç¾¤
- kubectlï¼šKubernetes çš„å‘½ä»¤è¡Œå·¥å…·ï¼Œä¸»è¦ä½œç”¨æ˜¯éƒ¨ç½²å’Œç®¡ç†åº”ç”¨ï¼ŒæŸ¥çœ‹å„ç§èµ„æºï¼Œåˆ›å»ºï¼Œåˆ é™¤å’Œæ›´æ–°ç»„ä»¶
- kubeletï¼šä¸»è¦è´Ÿè´£å¯åŠ¨ Pod å’Œå®¹å™¨

## é…ç½® kubeadm
å®‰è£… kubernetes ä¸»è¦æ˜¯å®‰è£…å®ƒçš„å„ä¸ªé•œåƒï¼Œè€Œ kubeadm å·²ç»ä¸ºæˆ‘ä»¬é›†æˆå¥½äº†è¿è¡Œ kubernetes æ‰€éœ€çš„åŸºæœ¬é•œåƒã€‚ä½†ç”±äºå›½å†…çš„ç½‘ç»œåŸå› ï¼Œåœ¨æ­å»ºç¯å¢ƒæ—¶ï¼Œæ— æ³•æ‹‰å–åˆ°è¿™äº›é•œåƒã€‚æ­¤æ—¶æˆ‘ä»¬åªéœ€è¦ä¿®æ”¹ä¸ºé˜¿é‡Œäº‘æä¾›çš„é•œåƒæœåŠ¡å³å¯è§£å†³è¯¥é—®é¢˜
### åˆ›å»ºå¹¶ä¿®æ”¹é…ç½®

```
kubeadm config print init-defaults --kubeconfig ClusterConfiguration > kubeadm.yml

```

ä¿®æ”¹é…ç½®å†…å®¹

```
# ä¿®æ”¹é…ç½®ä¸ºå¦‚ä¸‹å†…å®¹
apiVersion: kubeadm.k8s.io/v1beta1
bootstrapTokens:
- groups:
  - system:bootstrappers:kubeadm:default-node-token
  token: abcdef.0123456789abcdef
  ttl: 24h0m0s
  usages:
  - signing
  - authentication
kind: InitConfiguration
localAPIEndpoint:
  # ä¿®æ”¹ä¸ºä¸»èŠ‚ç‚¹ IP
  advertiseAddress: 192.168.141.130
  bindPort: 6443
nodeRegistration:
  criSocket: /var/run/dockershim.sock
  name: kubernetes-master
  taints:
  - effect: NoSchedule
    key: node-role.kubernetes.io/master
---
apiServer:
  timeoutForControlPlane: 4m0s
apiVersion: kubeadm.k8s.io/v1beta1
certificatesDir: /etc/kubernetes/pki
clusterName: kubernetes
controlPlaneEndpoint: ""
controllerManager: {}
dns:
  type: CoreDNS
etcd:
  local:
    dataDir: /var/lib/etcd
# å›½å†…ä¸èƒ½è®¿é—® Googleï¼Œä¿®æ”¹ä¸ºé˜¿é‡Œäº‘
imageRepository: registry.aliyuncs.com/google_containers
kind: ClusterConfiguration
# ä¿®æ”¹ç‰ˆæœ¬å·
kubernetesVersion: v1.17.0
networking:
  dnsDomain: cluster.local
  # é…ç½®æˆ Calico çš„é»˜è®¤ç½‘æ®µ
  podSubnet: "192.168.0.0/16"
  serviceSubnet: 10.96.0.0/12
scheduler: {}
---
# å¼€å¯ IPVS æ¨¡å¼
apiVersion: kubeproxy.config.k8s.io/v1alpha1
kind: KubeProxyConfiguration
featureGates:
  SupportIPVSProxyMode: true
mode: ipvs
```

æŸ¥çœ‹å’Œæ‹‰å–é•œåƒ

```
# æŸ¥çœ‹æ‰€éœ€é•œåƒåˆ—è¡¨
kubeadm config images list --config kubeadm.yml
# æ‹‰å–é•œåƒ
kubeadm config images pull --config kubeadm.yml
```

### å®‰è£… kubernetes ä¸»èŠ‚ç‚¹
æ‰§è¡Œä»¥ä¸‹å‘½ä»¤åˆå§‹åŒ–ä¸»èŠ‚ç‚¹ï¼Œè¯¥å‘½ä»¤æŒ‡å®šäº†åˆå§‹åŒ–æ—¶éœ€è¦ä½¿ç”¨çš„é…ç½®æ–‡ä»¶ï¼Œå…¶ä¸­æ·»åŠ  --upload-certs å‚æ•°å¯ä»¥åœ¨åç»­æ‰§è¡ŒåŠ å…¥èŠ‚ç‚¹æ—¶è‡ªåŠ¨åˆ†å‘è¯ä¹¦æ–‡ä»¶ã€‚è¿½åŠ çš„ tee kubeadm-init.log ç”¨ä»¥è¾“å‡ºæ—¥å¿—ã€‚


```
kubeadm init --config=kubeadm.yml --experimental-upload-certs | tee kubeadm-init.log

#your configuration file uses a deprecated API spec: "kubeadm.k8s.io/v1beta1". Please use 'kubeadm config migrate --old-config old.yaml --new-config new.yaml', which will write the new, similar spec using a newer API version.
W0106 17:26:39.941946   25748 common.go:77] your configuration file uses a deprecated API spec: "kubeadm.k8s.io/v1beta1". Please use 'kubeadm config migrate --old-config old.yaml --new-config new.yaml', which will write the new, similar spec using a newer API version.
W0106 17:26:39.944487   25748 validation.go:28] Cannot validate kube-proxy config - no validator is available
W0106 17:26:39.944533   25748 validation.go:28] Cannot validate kubelet config - no validator is available
[init] Using Kubernetes version: v1.17.0
[preflight] Running pre-flight checks
	[WARNING IsDockerSystemdCheck]: detected "cgroupfs" as the Docker cgroup driver. The recommended driver is "systemd". Please follow the guide at https://kubernetes.io/docs/setup/cri/
[preflight] Pulling images required for setting up a Kubernetes cluster
[preflight] This might take a minute or two, depending on the speed of your internet connection
[preflight] You can also perform this action in beforehand using 'kubeadm config images pull'
[kubelet-start] Writing kubelet environment file with flags to file "/var/lib/kubelet/kubeadm-flags.env"
[kubelet-start] Writing kubelet configuration to file "/var/lib/kubelet/config.yaml"
[kubelet-start] Starting the kubelet
[certs] Using certificateDir folder "/etc/kubernetes/pki"
[certs] Generating "ca" certificate and key
[certs] Generating "apiserver" certificate and key
[certs] apiserver serving cert is signed for DNS names [kubernetes-master kubernetes kubernetes.default kubernetes.default.svc kubernetes.default.svc.cluster.local] and IPs [10.96.0.1 192.168.62.159]
[certs] Generating "apiserver-kubelet-client" certificate and key
[certs] Generating "front-proxy-ca" certificate and key
[certs] Generating "front-proxy-client" certificate and key
[certs] Generating "etcd/ca" certificate and key
[certs] Generating "etcd/server" certificate and key
[certs] etcd/server serving cert is signed for DNS names [kubernetes-master localhost] and IPs [192.168.62.159 127.0.0.1 ::1]
[certs] Generating "etcd/peer" certificate and key
[certs] etcd/peer serving cert is signed for DNS names [kubernetes-master localhost] and IPs [192.168.62.159 127.0.0.1 ::1]
[certs] Generating "etcd/healthcheck-client" certificate and key
[certs] Generating "apiserver-etcd-client" certificate and key
[certs] Generating "sa" key and public key
[kubeconfig] Using kubeconfig folder "/etc/kubernetes"
[kubeconfig] Writing "admin.conf" kubeconfig file
[kubeconfig] Writing "kubelet.conf" kubeconfig file
[kubeconfig] Writing "controller-manager.conf" kubeconfig file
[kubeconfig] Writing "scheduler.conf" kubeconfig file
[control-plane] Using manifest folder "/etc/kubernetes/manifests"
[control-plane] Creating static Pod manifest for "kube-apiserver"
W0106 17:26:44.531537   25748 manifests.go:214] the default kube-apiserver authorization-mode is "Node,RBAC"; using "Node,RBAC"
[control-plane] Creating static Pod manifest for "kube-controller-manager"
W0106 17:26:44.532749   25748 manifests.go:214] the default kube-apiserver authorization-mode is "Node,RBAC"; using "Node,RBAC"
[control-plane] Creating static Pod manifest for "kube-scheduler"
[etcd] Creating static Pod manifest for local etcd in "/etc/kubernetes/manifests"
[wait-control-plane] Waiting for the kubelet to boot up the control plane as static Pods from directory "/etc/kubernetes/manifests". This can take up to 4m0s
[apiclient] All control plane components are healthy after 24.504808 seconds
[upload-config] Storing the configuration used in ConfigMap "kubeadm-config" in the "kube-system" Namespace
[kubelet] Creating a ConfigMap "kubelet-config-1.17" in namespace kube-system with the configuration for the kubelets in the cluster
[upload-certs] Storing the certificates in Secret "kubeadm-certs" in the "kube-system" Namespace
[upload-certs] Using certificate key:
781e69718ac47389e4e65f025cb9cb842ae621f495323b08f8c3cc5fe69c5a82
[mark-control-plane] Marking the node kubernetes-master as control-plane by adding the label "node-role.kubernetes.io/master=''"
[mark-control-plane] Marking the node kubernetes-master as control-plane by adding the taints [node-role.kubernetes.io/master:NoSchedule]
[bootstrap-token] Using token: abcdef.0123456789abcdef
[bootstrap-token] Configuring bootstrap tokens, cluster-info ConfigMap, RBAC Roles
[bootstrap-token] configured RBAC rules to allow Node Bootstrap tokens to post CSRs in order for nodes to get long term certificate credentials
[bootstrap-token] configured RBAC rules to allow the csrapprover controller automatically approve CSRs from a Node Bootstrap Token
[bootstrap-token] configured RBAC rules to allow certificate rotation for all node client certificates in the cluster
[bootstrap-token] Creating the "cluster-info" ConfigMap in the "kube-public" namespace
[kubelet-finalize] Updating "/etc/kubernetes/kubelet.conf" to point to a rotatable kubelet client certificate and key
[addons] Applied essential addon: CoreDNS
[addons] Applied essential addon: kube-proxy

Your Kubernetes control-plane has initialized successfully!

To start using your cluster, you need to run the following as a regular user:

  mkdir -p $HOME/.kube
  sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
  sudo chown $(id -u):$(id -g) $HOME/.kube/config

You should now deploy a pod network to the cluster.
Run "kubectl apply -f [podnetwork].yaml" with one of the options listed at:
  https://kubernetes.io/docs/concepts/cluster-administration/addons/

Then you can join any number of worker nodes by running the following on each as root:

kubeadm join 192.168.62.159:6443 --token abcdef.0123456789abcdef \
    --discovery-token-ca-cert-hash sha256:7237dd082021214d77c1d99f0cdc2a1a110c33ba94c5e2df699ea3cebbab1ea4 

```
> æ³¨æ„ï¼šå¦‚æœå®‰è£… kubernetes ç‰ˆæœ¬å’Œä¸‹è½½çš„é•œåƒç‰ˆæœ¬ä¸ç»Ÿä¸€åˆ™ä¼šå‡ºç° timed out waiting for the condition é”™è¯¯ã€‚ä¸­é€”å¤±è´¥æˆ–æ˜¯æƒ³ä¿®æ”¹é…ç½®å¯ä»¥ä½¿ç”¨ kubeadm reset å‘½ä»¤é‡ç½®é…ç½®ï¼Œå†åšåˆå§‹åŒ–æ“ä½œå³å¯ã€‚

## é…ç½® kubectl

```
  mkdir -p $HOME/.kube
  sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
  sudo chown $(id -u):$(id -g) $HOME/.kube/config(érootæ‰åš)
```
éªŒè¯æ˜¯å¦æˆåŠŸ

![](https://user-gold-cdn.xitu.io/2020/1/6/16f7a367bfb2f4f8?w=1122&h=611&f=png&s=95464)

```
kubectl get node
```

è‡³æ­¤ä¸»èŠ‚ç‚¹é…ç½®å®Œæˆ

- kubeadm init çš„æ‰§è¡Œè¿‡ç¨‹
- initï¼šæŒ‡å®šç‰ˆæœ¬è¿›è¡Œåˆå§‹åŒ–æ“ä½œ
- preflightï¼šåˆå§‹åŒ–å‰çš„æ£€æŸ¥å’Œä¸‹è½½æ‰€éœ€è¦çš„ Docker é•œåƒæ–‡ä»¶
- kubelet-startï¼šç”Ÿæˆ kubelet çš„é…ç½®æ–‡ä»¶ var/lib/kubelet/config.yamlï¼Œæ²¡æœ‰è¿™ä¸ªæ–‡ä»¶ kubelet æ— æ³•å¯åŠ¨ï¼Œæ‰€ä»¥åˆå§‹åŒ–ä¹‹å‰çš„ - kubelet å®é™…ä¸Šå¯åŠ¨ä¸ä¼šæˆåŠŸ
- certificatesï¼šç”Ÿæˆ Kubernetes ä½¿ç”¨çš„è¯ä¹¦ï¼Œå­˜æ”¾åœ¨ /etc/kubernetes/pki ç›®å½•ä¸­
- kubeconfigï¼šç”Ÿæˆ KubeConfig æ–‡ä»¶ï¼Œå­˜æ”¾åœ¨ /etc/kubernetes ç›®å½•ä¸­ï¼Œç»„ä»¶ä¹‹é—´é€šä¿¡éœ€è¦ä½¿ç”¨å¯¹åº”æ–‡ä»¶
- control-planeï¼šä½¿ç”¨ /etc/kubernetes/manifest ç›®å½•ä¸‹çš„ YAML æ–‡ä»¶ï¼Œå®‰è£… Master ç»„ä»¶
- etcdï¼šä½¿ç”¨ /etc/kubernetes/manifest/etcd.yaml å®‰è£… Etcd æœåŠ¡
- wait-control-planeï¼šç­‰å¾… control-plan éƒ¨ç½²çš„ Master ç»„ä»¶å¯åŠ¨
- apiclientï¼šæ£€æŸ¥ Master ç»„ä»¶æœåŠ¡çŠ¶æ€ã€‚
- uploadconfigï¼šæ›´æ–°é…ç½®
- kubeletï¼šä½¿ç”¨ configMap é…ç½® kubelet
- patchnodeï¼šæ›´æ–° CNI ä¿¡æ¯åˆ° Node ä¸Šï¼Œé€šè¿‡æ³¨é‡Šçš„æ–¹å¼è®°å½•
- mark-control-planeï¼šä¸ºå½“å‰èŠ‚ç‚¹æ‰“æ ‡ç­¾ï¼Œæ‰“äº†è§’è‰² Masterï¼Œå’Œä¸å¯è°ƒåº¦æ ‡ç­¾ï¼Œè¿™æ ·é»˜è®¤å°±ä¸ä¼šä½¿ç”¨ Master èŠ‚ç‚¹æ¥è¿è¡Œ Pod
- bootstrap-tokenï¼šç”Ÿæˆ token è®°å½•ä¸‹æ¥ï¼Œåè¾¹ä½¿ç”¨ kubeadm join å¾€é›†ç¾¤ä¸­æ·»åŠ èŠ‚ç‚¹æ—¶ä¼šç”¨åˆ°
- addonsï¼šå®‰è£…é™„åŠ ç»„ä»¶ CoreDNS å’Œ kube-proxy- 



## ç»“å°¾
k8sçš„MasterèŠ‚ç‚¹å·²ç»æ­å»ºå®Œæ¯•ï¼Œä¸‹ä¸€èŠ‚æˆ‘ä»¬è®²è®²å®ƒçš„Nodeæ­å»ºï¼ˆè¯´å®è¯K8sè¿˜æ˜¯æœ‰ç‚¹éš¾åº¦çš„ï¼Œéš¾æå“¦ï¼Œä½†æ˜¯å¤§å®¶ç¬¬ä¸€æ¬¡ç©ä¸è¦é—®ä¸ºå•¥ï¼Œå…ˆæŠŠä»–ç”¨èµ·æ¥äº†ä¹‹åï¼Œæˆ‘ä»¬å†åè¿‡æ¥å¼„æ¸…æ¥šå®ƒçš„ä¸ºä»€ä¹ˆï¼‰
## æ—¥å¸¸æ±‚èµ
> å¥½äº†å„ä½ï¼Œä»¥ä¸Šå°±æ˜¯è¿™ç¯‡æ–‡ç« çš„å…¨éƒ¨å†…å®¹äº†ï¼Œèƒ½çœ‹åˆ°è¿™é‡Œçš„äººå‘€ï¼Œéƒ½æ˜¯**çœŸç²‰**ã€‚

> åˆ›ä½œä¸æ˜“ï¼Œå„ä½çš„æ”¯æŒå’Œè®¤å¯ï¼Œå°±æ˜¯æˆ‘åˆ›ä½œçš„æœ€å¤§åŠ¨åŠ›ï¼Œæˆ‘ä»¬ä¸‹ç¯‡æ–‡ç« è§

>å…­è„‰ç¥å‰‘ | æ–‡ ã€åŸåˆ›ã€‘å¦‚æœæœ¬ç¯‡åšå®¢æœ‰ä»»ä½•é”™è¯¯ï¼Œè¯·æ‰¹è¯„æŒ‡æ•™ï¼Œä¸èƒœæ„Ÿæ¿€ ï¼
